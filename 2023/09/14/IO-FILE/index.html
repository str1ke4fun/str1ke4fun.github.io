<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>IO_FILE | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>IO_FILE</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-14T11:33:47.000Z" id="date"> 2023-09-14</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-30T11:46:50.366Z" id="updated"> 2023-09-30</time></div></span></div></div><hr><div id="post-content"><p>部分堆题没有给予我们打印堆块中间的机会 这种情况下 无法通过unsortedbin来泄露基址 这里学习一种新办法 通过io file来泄露基址</p>
<p>在一个程序中 初始的文件描述符为1,2,3 分别对应着标准输入 标准输出 标准错误 当我们调用scanf函数或者read函数的时候 就会通过调用文件描述符0来从终端输入数据 也就意味着我们可以利用这一点来做到泄露数据</p>
<p>FILE 在 Linux 系统的标准 IO 库中是用于描述文件的结构，称为文件流。 FILE 结构在程序执行 fopen 等函数时会进行创建，并分配在堆中，然后以链表的形式串联起来，但系统一开始会自动创建的三个文件即stdin、stdout、stderr，它们是在libc上。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span></span><br><span class="hljs-class">&#123;</span><br>    _IO_FILE    file;<br>    _IO_jump_t   *vtable;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><em>_IO_FILE的源码</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br><span class="hljs-type">int</span> _flags;       <span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br> <br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br>  <span class="hljs-type">char</span>* _IO_read_ptr;   <span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-type">char</span>* _IO_read_end;   <span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-type">char</span>* _IO_read_base;  <span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_base; <span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_ptr;  <span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-type">char</span>* _IO_write_end;  <span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_base;   <span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_end;    <span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br> <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br> <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br> <br>  <span class="hljs-type">int</span> _fileno;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  <span class="hljs-type">int</span> _blksize;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">int</span> _flags2;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_off_t _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span></span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br> <br><span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span><br> <br>_IO_lock_t *_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>_IO_list_all变量，其指向FILE链表的头部，结合上面的结构体可知<br>file对应的就是_IO_FILE结构类型<br>vtable对应的就是_IO_jump_t类型。<br>在没有创建其它文件结构时，_IO_list_all指向stderr，然后依次是stdout和stdin，这里通过在前面加上结构体类型可以详细的打印其内存数据信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; p /x *(<span class="hljs-keyword">struct</span> _IO_FILE_plus *) _IO_list_all<br>$<span class="hljs-number">1</span> = &#123;<br>  file = &#123;<br>    _flags = <span class="hljs-number">0xfbad2086</span>, <br>    _IO_read_ptr = <span class="hljs-number">0x0</span>, <br>    _IO_read_end = <span class="hljs-number">0x0</span>, <br>    _IO_read_base = <span class="hljs-number">0x0</span>, <br>    _IO_write_base = <span class="hljs-number">0x0</span>, <br>    _IO_write_ptr = <span class="hljs-number">0x0</span>, <br>    _IO_write_end = <span class="hljs-number">0x0</span>, <br>    _IO_buf_base = <span class="hljs-number">0x0</span>, <br>    _IO_buf_end = <span class="hljs-number">0x0</span>, <br>    _IO_save_base = <span class="hljs-number">0x0</span>, <br>    _IO_backup_base = <span class="hljs-number">0x0</span>, <br>    _IO_save_end = <span class="hljs-number">0x0</span>, <br>    _markers = <span class="hljs-number">0x0</span>, <br>    _chain = <span class="hljs-number">0x7ffff7dce760</span>, <br>    _fileno = <span class="hljs-number">0x2</span>, <br>    _flags2 = <span class="hljs-number">0x0</span>, <br>    _old_offset = <span class="hljs-number">0xffffffffffffffff</span>, <br>    _cur_column = <span class="hljs-number">0x0</span>, <br>    _vtable_offset = <span class="hljs-number">0x0</span>, <br>    _shortbuf = &#123;<span class="hljs-number">0x0</span>&#125;, <br>    _lock = <span class="hljs-number">0x7ffff7dcf8b0</span>, <br>    _offset = <span class="hljs-number">0xffffffffffffffff</span>, <br>    _codecvt = <span class="hljs-number">0x0</span>, <br>    _wide_data = <span class="hljs-number">0x7ffff7dcd780</span>, <br>    _freeres_list = <span class="hljs-number">0x0</span>, <br>    _freeres_buf = <span class="hljs-number">0x0</span>, <br>    __pad5 = <span class="hljs-number">0x0</span>, <br>    _mode = <span class="hljs-number">0x0</span>, <br>    _unused2 = &#123;<span class="hljs-number">0x0</span> &lt;repeats <span class="hljs-number">20</span> times&gt;&#125;<br>  &#125;, <br>  vtable = <span class="hljs-number">0x7ffff7dca2a0</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>_IO_file_jumps，同 *vtable</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; p _IO_file_jumps<br>$<span class="hljs-number">3</span> = &#123;<br>  __dummy = <span class="hljs-number">0</span>, <br>  __dummy2 = <span class="hljs-number">0</span>, <br>  __finish = <span class="hljs-number">0x7ffff7a6e2d0</span> &lt;_IO_new_file_finish&gt;, <br>  __overflow = <span class="hljs-number">0x7ffff7a6f2b0</span> &lt;_IO_new_file_overflow&gt;, <br>  __underflow = <span class="hljs-number">0x7ffff7a6efd0</span> &lt;_IO_new_file_underflow&gt;, <br>  __uflow = <span class="hljs-number">0x7ffff7a70370</span> &lt;__GI__IO_default_uflow&gt;, <br>  __pbackfail = <span class="hljs-number">0x7ffff7a71c00</span> &lt;__GI__IO_default_pbackfail&gt;, <br>  __xsputn = <span class="hljs-number">0x7ffff7a6d8d0</span> &lt;_IO_new_file_xsputn&gt;, <br>  __xsgetn = <span class="hljs-number">0x7ffff7a6d530</span> &lt;__GI__IO_file_xsgetn&gt;, <br>  __seekoff = <span class="hljs-number">0x7ffff7a6cb30</span> &lt;_IO_new_file_seekoff&gt;, <br>  __seekpos = <span class="hljs-number">0x7ffff7a70940</span> &lt;_IO_default_seekpos&gt;, <br>  __setbuf = <span class="hljs-number">0x7ffff7a6c7f0</span> &lt;_IO_new_file_setbuf&gt;, <br>  __sync = <span class="hljs-number">0x7ffff7a6c670</span> &lt;_IO_new_file_sync&gt;, <br>  __doallocate = <span class="hljs-number">0x7ffff7a600b0</span> &lt;__GI__IO_file_doallocate&gt;, <br>  __read = <span class="hljs-number">0x7ffff7a6d8b0</span> &lt;__GI__IO_file_read&gt;, <br>  __write = <span class="hljs-number">0x7ffff7a6d130</span> &lt;_IO_new_file_write&gt;, <br>  __seek = <span class="hljs-number">0x7ffff7a6c8b0</span> &lt;__GI__IO_file_seek&gt;, <br>  __close = <span class="hljs-number">0x7ffff7a6c7e0</span> &lt;__GI__IO_file_close&gt;, <br>  __stat = <span class="hljs-number">0x7ffff7a6d120</span> &lt;__GI__IO_file_stat&gt;, <br>  __showmanyc = <span class="hljs-number">0x7ffff7a71d80</span> &lt;_IO_default_showmanyc&gt;, <br>  __imbue = <span class="hljs-number">0x7ffff7a71d90</span> &lt;_IO_default_imbue&gt;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>_IO_FILE结构体中，_chain字段指向下一个链表节点,此处指向的是stdout</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt;  p  *(<span class="hljs-keyword">struct</span> _IO_FILE_plus *) <span class="hljs-built_in">stdout</span><br>$<span class="hljs-number">1</span> = &#123;<br>  file = &#123;<br>    _flags = <span class="hljs-number">-72540028</span>, <br>    _IO_read_ptr = <span class="hljs-number">0x0</span>, <br>    _IO_read_end = <span class="hljs-number">0x0</span>, <br>    _IO_read_base = <span class="hljs-number">0x0</span>, <br>    _IO_write_base = <span class="hljs-number">0x0</span>, <br>    _IO_write_ptr = <span class="hljs-number">0x0</span>, <br>    _IO_write_end = <span class="hljs-number">0x0</span>, <br>    _IO_buf_base = <span class="hljs-number">0x0</span>, <br>    _IO_buf_end = <span class="hljs-number">0x0</span>, <br>    _IO_save_base = <span class="hljs-number">0x0</span>, <br>    _IO_backup_base = <span class="hljs-number">0x0</span>, <br>    _IO_save_end = <span class="hljs-number">0x0</span>, <br>    _markers = <span class="hljs-number">0x0</span>, <br>    _chain = <span class="hljs-number">0x7ffff7dcda00</span> &lt;_IO_2_1_stdin_&gt;, <br>    _fileno = <span class="hljs-number">1</span>, <span class="hljs-comment">//文件描述符，stderr的fileno值为2，stdout的fileno值为1</span><br>    _flags2 = <span class="hljs-number">0</span>, <br>    _old_offset = <span class="hljs-number">-1</span>, <br>    _cur_column = <span class="hljs-number">0</span>, <br>    _vtable_offset = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>, <br>    _shortbuf = <span class="hljs-string">&quot;&quot;</span>, <br>    _lock = <span class="hljs-number">0x7ffff7dcf8c0</span> &lt;_IO_stdfile_1_lock&gt;, <br>    _offset = <span class="hljs-number">-1</span>, <br>    _codecvt = <span class="hljs-number">0x0</span>, <br>    _wide_data = <span class="hljs-number">0x7ffff7dcd8c0</span> &lt;_IO_wide_data_1&gt;, <br>    _freeres_list = <span class="hljs-number">0x0</span>, <br>    _freeres_buf = <span class="hljs-number">0x0</span>, <br>    __pad5 = <span class="hljs-number">0</span>, <br>    _mode = <span class="hljs-number">0</span>, <br>    _unused2 = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats <span class="hljs-number">19</span> times&gt;<br>  &#125;, <br>  vtable = <span class="hljs-number">0x7ffff7dca2a0</span> &lt;_IO_file_jumps&gt;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>利用_fileno字段</strong><br>_fileno的值就是文件描述符，位于stdin文件结构开头0x70偏移处<br>我们可以尝试篡改_fileno以重定位需要读取的文件<br><em><strong>例子之后再放</strong></em></p>
<p><strong>IO_FILE_leak</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> _IO_new_file_overflow (FILE *f, <span class="hljs-type">int</span> ch)<br>&#123;<br>  <span class="hljs-keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="hljs-comment">/* SET ERROR */</span><br>    &#123;<br>      f-&gt;_flags |= _IO_ERR_SEEN;<br>      __set_errno (EBADF);<br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-comment">/* If currently reading or no buffer allocated. */</span><br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="hljs-number">0</span> || f-&gt;_IO_write_base == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">/* Allocate a buffer if needed. */</span><br>      <span class="hljs-keyword">if</span> (f-&gt;_IO_write_base == <span class="hljs-literal">NULL</span>)<br>	&#123;<br>	  _IO_doallocbuf (f);<br>	  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);<br>	&#125;<br>      <span class="hljs-comment">/* Otherwise must be currently reading.</span><br><span class="hljs-comment">	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span><br><span class="hljs-comment">	 logically slide the buffer forwards one block (by setting the</span><br><span class="hljs-comment">	 read pointers to all point at the beginning of the block).  This</span><br><span class="hljs-comment">	 makes room for subsequent output.</span><br><span class="hljs-comment">	 Otherwise, set the read pointers to _IO_read_end (leaving that</span><br><span class="hljs-comment">	 alone, so it can continue to correspond to the external position). */</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))<br>	&#123;<br>	  <span class="hljs-type">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;<br>	  _IO_free_backup_area (f);<br>	  f-&gt;_IO_read_base -= MIN (nbackup,<br>				   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);<br>	  f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;<br>	&#125;<br>      <span class="hljs-keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)<br>	f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;<br>      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;<br>      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;<br>      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;<br>      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;<br>      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;<br>      <span class="hljs-keyword">if</span> (f-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))<br>	f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (ch == EOF)<br>    <span class="hljs-keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,<br>			 f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);<br>  <span class="hljs-keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="hljs-comment">/* Buffer is really full */</span><br>    <span class="hljs-keyword">if</span> (_IO_do_flush (f) == EOF)<br>      <span class="hljs-keyword">return</span> EOF;<br>  *f-&gt;_IO_write_ptr++ = ch;<br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)<br>      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="hljs-string">&#x27;\n&#x27;</span>))<br>    <span class="hljs-keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,<br>		      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)<br>      <span class="hljs-keyword">return</span> EOF;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>) ch;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>将堆块分配到stdout指针处存储的_IO_2_1_stdout_该IO_FILE结构体处<br>修改其_flags为0xfbad1800，将后面三个read指针置空<br>将_IO_write_base处的第一个字节改为0x58，后面的_IO_write_ptr和_IO_write_end保持不变。<br>之后当程序遇到puts函数时就会打印_IO_write_base到_IO_write_ptr之间的内容<br>按照上面步骤改动的话，我们泄露出的第一个libc地址是_IO_file_jumps。<br>常用的payload如下所示，至于为啥需要flags&#x3D;0xfbad1800（flags也可以是0xfbad3887），<br>这里分析起来十分复杂，可以参见puts源码，只能说为了达到输出效果需要这样设置<br>另外该flags这样设置只是针对puts函数，其余打印函数略有不同。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">payload = p64(<span class="hljs-number">0xfbad1800</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+<span class="hljs-string">b&quot;\x58&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">payload = p64(<span class="hljs-number">0xfbad3887</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p8(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>

<p><em><strong>前面的攻击手段，以后再来探索吧~</strong></em></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/16/ycb-offline-review/">← Next ycb_final_review</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/09/14/free-hook/">free_hook Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>